<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT Product Website Auditor (Canvas Bridge)</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: #0f172a;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #e2e8f0;
        }

        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .toast-enter {
            animation: slideInRight 0.3s ease-out forwards;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // ==========================================
        // 1. CONFIGURATION
        // ==========================================
        const MODEL_ID = "gemini-2.5-flash-preview-09-2025";
        const PT_DATA_GS_URL = "https://script.google.com/macros/s/AKfycbxayHvvpWggMF8yEtYJxhYjoCe8kR65SxIQwQkHbc7S2XCRs-VxOXWzGEgKClG56vQfLA/exec";

        // Columns to DISPLAY in the table (simplified view)
        const BASE_DISPLAY_COLS = ["Platform", "Model #", "Accessories", "Brand", "Title", "Product URL", "Exclude Update"];
        // Columns for Export (Results)
        const EXPORT_COLS_FIXED = [
            "Date Created", "Platform", "Model #", "Accessories", "Brand",
            "Title", "SKU", "Product URL", "Image URL", "Exclude Update",
            "Audit Status", "Audit Reason"
        ];

        const CHUNK_SIZE = 10;
        const MAX_RETRIES = 3;
        const BASE_DELAY_MS = 2000;
        const GS_API_KEY = "55759180";

        // ==========================================
        // 2. HELPERS
        // ==========================================
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        const sanitizeForExport = (val) => (val === null || val === undefined) ? "" : String(val).replace(/[\n\r\t]/g, " ").trim();

        // Robust Copy to Clipboard
        const copyToClipboard = (text, onSuccess, onError) => {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(onSuccess)
                    .catch(() => fallbackCopyTextToClipboard(text, onSuccess, onError));
            } else {
                fallbackCopyTextToClipboard(text, onSuccess, onError);
            }
        };

        const fallbackCopyTextToClipboard = (text, onSuccess, onError) => {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                var successful = document.execCommand('copy');
                if (successful) onSuccess();
                else onError();
            } catch (err) { onError(); }
            document.body.removeChild(textArea);
        };

        // ==========================================
        // 3. GEMINI SERVICE
        // ==========================================
        const Gemini_Service = {
            callAPI: async (dataChunk) => {
                const apiKey = "";
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent?key=${apiKey}`;

                const systemInstruction = `*** SYSTEM COMMAND: PRODUCT ACCESSORY CHECKER ***
You are a Power Tool Accessory Auditor. Visit product pages and extract accessory information.

For each product, visit the Product URL and check:
1. **Page Validity**: Is this the correct product page for the given Brand + Model #?
2. **Model Extraction**: Identify the CORE model number (e.g., "GCM 8 SJL" NOT "GCM 8 SJL Set"). Ignore suffixes like "Set", "Plus", "Kit", "Bundle" unless they are part of the actual model ID (e.g., "Plus" in "V20 Plus").
3. **Accessories**: Find "Lieferumfang" / "Scope of Delivery" / "Includes" section.

CATEGORIZE accessories into ONLY these types:
- **Blade**: S√§geblatt, saw blade, cutting blade (count: x1, x2, etc.)
- **Stand**: Maschinenst√§nder, Untergestell, machine stand, workstand. THIS IS A NORMAL ACCESSORY, NOT A BUNDLE.
- **Battery**: Akku, battery, Ladeger√§t, charger. If "ohne Akku" = write "without Battery"
- **Bundle**: ONLY if the product is bundled with a COMPLETELY DIFFERENT product category (e.g., Saw + Vacuum, Saw + Refrigerator, Saw + other unrelated tool). Stand is NOT a bundle!

IMPORTANT RULES:
- Stand (Maschinenst√§nder) = accessory ‚Üí write "Stand x1"
- Bundle = cross-category product combo ‚Üí write "Bundle" only if truly bundled with unrelated products
- Most products should NOT have "Bundle" - only use it for real cross-category bundles

===== OUTPUT FORMAT (STRICT JSON SCHEMA) =====
Return a JSON ARRAY where each object contains EXACTLY these fields:
{
  "Brand": "string - Brand name from product page",
  "Model #": "string - Model number from product page",
  "Accessories": "string - 'with Blade x1, Stand x1' or '-' if none",
  "Audit Status": "string - 'OK' | 'Mismatch' | 'Invalid URL'",
  "Audit Reason": "string - '-' if OK, otherwise brief explanation"
}

Output ONLY valid JSON. Start with '['.`;

                const execute = async (retryCount = 0) => {
                    try {
                        const payload = {
                            contents: [{ parts: [{ text: `Audit these products:\n${JSON.stringify(dataChunk)}` }] }],
                            systemInstruction: { parts: [{ text: systemInstruction }] },
                            tools: [{ "google_search": {} }]
                        };
                        const response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                        if (!response.ok) {
                            if (response.status === 429) throw new Error("Rate Limit");
                            throw new Error(`HTTP ${response.status}`);
                        }
                        const resJson = await response.json();
                        const text = resJson.candidates?.[0]?.content?.parts?.[0]?.text || "";

                        let jsonStr = text.trim();
                        const firstOpen = jsonStr.search(/[\[\{]/);
                        const lastCloseArr = jsonStr.lastIndexOf(']');
                        const lastCloseObj = jsonStr.lastIndexOf('}');
                        const lastClose = Math.max(lastCloseArr, lastCloseObj);

                        if (firstOpen === -1 || lastClose === -1) throw new Error("No JSON Structure Found");
                        jsonStr = jsonStr.substring(firstOpen, lastClose + 1);

                        let parsedData;
                        try {
                            parsedData = JSON.parse(jsonStr);
                        } catch (parseError) {
                            // Simple repair attempt
                            if (jsonStr.startsWith('[') && !jsonStr.endsWith(']')) {
                                try { parsedData = JSON.parse(jsonStr + ']'); } catch (e) { }
                            }
                            if (!parsedData) throw new Error("Invalid JSON Output from AI");
                        }

                        if (!Array.isArray(parsedData)) parsedData = [parsedData];
                        return parsedData;

                    } catch (error) {
                        if (retryCount < MAX_RETRIES) {
                            const delay = Math.pow(2, retryCount) * BASE_DELAY_MS;
                            await sleep(delay);
                            return execute(retryCount + 1);
                        }
                        throw error;
                    }
                };
                return execute();
            }
        };

        // ==========================================
        // 4. MAIN APP COMPONENT
        // ==========================================
        const App = () => {
            const [gsUrl, setGsUrl] = useState(PT_DATA_GS_URL);
            const [ptDataSheets, setPtDataSheets] = useState([]);
            const [selectedSheet, setSelectedSheet] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [rawRows, setRawRows] = useState([]);
            const [fullHeadersOrder, setFullHeadersOrder] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [progress, setProgress] = useState({ percent: 0, status: "" });
            const [processedBatches, setProcessedBatches] = useState([]);
            const [toast, setToast] = useState(null);
            const [logHistory, setLogHistory] = useState([]);
            const [logViewer, setLogViewer] = useState({ isOpen: false, index: 0 });
            const [onlyEmptyAccessories, setOnlyEmptyAccessories] = useState(true);
            const [gsPassword, setGsPassword] = useState("55759180");

            const [validBrands, setValidBrands] = useState([]);
            const [validModels, setValidModels] = useState([]);
            const [validationMode, setValidationMode] = useState('MTS');

            const showToast = (message, type = 'success') => { setToast({ message, type }); setTimeout(() => setToast(null), 4000); };

            const displayHeaders = useMemo(() => {
                if (fullHeadersOrder.length === 0) return [];
                const dateColumns = fullHeadersOrder.filter(h => /^\d{8}$/.test(h)).sort().reverse();
                const latestPrice = dateColumns[0] || null;
                const cols = BASE_DISPLAY_COLS.filter(c => fullHeadersOrder.includes(c));
                if (latestPrice && !cols.includes(latestPrice)) cols.push(latestPrice);
                if (fullHeadersOrder.includes("Audit Status")) cols.push("Audit Status");
                if (fullHeadersOrder.includes("Audit Reason")) cols.push("Audit Reason");
                return cols;
            }, [fullHeadersOrder]);

            const handleConnect = async () => {
                setIsLoading(true);
                try {
                    const res = await fetch(`${gsUrl}?action=getSheets&key=${GS_API_KEY}`);
                    const sheets = await res.json();
                    if (sheets.error) throw new Error(sheets.hint ? `${sheets.error} (Hint: ${sheets.hint})` : sheets.error);
                    if (Array.isArray(sheets)) {
                        const dataSheets = sheets.filter(s => s.startsWith('Data_'));
                        setPtDataSheets(dataSheets);
                        showToast(`Connected! ${dataSheets.length} Data sheets found.`);
                    }
                } catch (e) { showToast("Connection failed: " + e.message, "error"); }
                setIsLoading(false);
            };

            const handleLoadSheet = async (sheetName) => {
                if (!sheetName) return;
                setSelectedSheet(sheetName);
                setIsLoading(true);
                setProcessedBatches([]);

                const mode = sheetName.toUpperCase().includes('TBS') ? 'TBS' : 'MTS';
                setValidationMode(mode);

                try {
                    const res = await fetch(`${gsUrl}?action=getData&sheet=${encodeURIComponent(sheetName)}&key=${GS_API_KEY}`);
                    const rows = await res.json();
                    if (rows.error) throw new Error(rows.hint ? `${rows.error} (Hint: ${rows.hint})` : rows.error);
                    if (!Array.isArray(rows)) throw new Error("Invalid data");

                    const headers = rows.length > 0 ? Object.keys(rows[0]) : [];
                    setFullHeadersOrder(headers);
                    setRawRows(rows);

                    try {
                        const checkRes = await fetch(`${gsUrl}?action=getData&sheet=Check&key=${GS_API_KEY}`);
                        const checkRows = await checkRes.json();
                        if (Array.isArray(checkRows) && checkRows.length > 0) {
                            const brands = checkRows.map(r => r['Brand']).filter(b => b && b.trim());
                            setValidBrands(brands);
                            const modelCol = mode === 'TBS' ? 'TBS' : 'MTS';
                            const models = checkRows.map(r => r[modelCol] || r[`C${modelCol}`]).filter(m => m && m.trim());
                            setValidModels(models);
                            console.log(`Validation loaded: ${brands.length} brands, ${models.length} models (${mode})`);
                        }
                    } catch (checkErr) { console.warn('Check sheet not found or error:', checkErr); }

                    showToast(`Loaded ${rows.length} rows. Mode: ${mode}`);
                } catch (err) { showToast("Load failed: " + err.message, "error"); }
                setIsLoading(false);
            };

            // --- MAIN AUDIT LOGIC ---
            const startAudit = async () => {
                if (isProcessing || rawRows.length === 0) { showToast("No data", "error"); return; }
                setIsProcessing(true);
                setProcessedBatches([]);

                // Reset Logs and add Initial Status
                setLogHistory([{
                    id: Date.now(),
                    type: 'info',
                    message: `Starting Audit. Valid Brands Loaded: ${validBrands.length}, Valid Models Loaded: ${validModels.length}`
                }]);

                setProgress({ percent: 0, status: "Starting..." });

                const initialCount = rawRows.length;
                let rowsToProcess = rawRows.map((r, i) => ({ ...r, _originalIndex: i }))
                    .filter(r => (r['Exclude Update'] || '').toUpperCase() !== 'Y');

                if (onlyEmptyAccessories) {
                    rowsToProcess = rowsToProcess.filter(r =>
                        !r['Brand'] || r['Brand'].trim() === '' ||
                        !r['Model #'] || r['Model #'].trim() === '' ||
                        !r['Accessories'] || r['Accessories'].trim() === '' || r['Accessories'] === '-'
                    );
                }

                if (rowsToProcess.length === 0) {
                    showToast("All rows are excluded", "error");
                    setIsProcessing(false);
                    return;
                }

                const allBatches = [];
                for (let i = 0; i < rowsToProcess.length; i += CHUNK_SIZE) {
                    allBatches.push({
                        batchId: allBatches.length + 1,
                        rows: rowsToProcess.slice(i, i + CHUNK_SIZE),
                        status: 'pending',
                        results: null,
                        retryCount: 0
                    });
                }

                const totalBatches = allBatches.length;
                let completedCount = 0;
                const maxRetryRounds = 5;
                let retryRound = 0;
                const PARALLEL_BATCHES = 4;

                const processBatch = async (batch) => {
                    const chunkForAI = batch.rows.map(r => ({
                        "Brand": r.Brand || "",
                        "Model #": r['Model #'] || "",
                        "Title": r.Title || "",
                        "Product URL": r['Product URL'] || ""
                    }));

                    try {
                        const aiResults = await Gemini_Service.callAPI(chunkForAI);
                        setLogHistory(prev => [{ id: Date.now(), type: 'ai-response', batch: batch.batchId, data: aiResults }, ...prev]);
                        batch.results = aiResults;
                        batch.status = 'success';
                        return true;
                    } catch (e) {
                        console.error(`Batch ${batch.batchId} failed:`, e);
                        setLogHistory(prev => [{ id: Date.now(), type: 'error', batch: batch.batchId, message: e.message }, ...prev]);
                        batch.status = 'failed';
                        batch.retryCount++;
                        return false;
                    }
                };

                // --- VALIDATION HELPER WITH LOGGING ---
                // We use a local logs collector to update state in batches to avoid re-renders
                let localValidationLogs = [];

                const validateAndMerge = (origRow, match, logPusher) => {
                    const newRow = { ...origRow };

                    if (match) {
                        // Priority 1: AI Result Injection
                        if ((!newRow['Brand'] || newRow['Brand'].trim() === '') && match['Brand']) {
                            newRow['Brand'] = match['Brand'];
                        }

                        if ((!newRow['Model #'] || newRow['Model #'].trim() === '') && match['Model #']) {
                            newRow['Model #'] = match['Model #'];
                        } else if (match["Audit Status"] === "Mismatch" && match['Model #'] && match['Model #'] !== '-' && match['Model #'] !== newRow['Model #']) {
                            // Only override if mismatch detected
                            if (logPusher) logPusher(`[AI Override] Model mismatch detected. Replaced '${newRow['Model #']}' with '${match['Model #']}'`);
                            newRow['Model #'] = match['Model #'];
                            newRow['_modelCorrected'] = true;
                        }

                        if ((!newRow['Accessories'] || newRow['Accessories'].trim() === '' || newRow['Accessories'] === '-') && match['Accessories']) newRow['Accessories'] = match['Accessories'];
                        if (match["Audit Status"]) newRow["Audit Status"] = match["Audit Status"];
                        if (match["Audit Reason"]) newRow["Audit Reason"] = match["Audit Reason"];
                    }

                    // --- BRAND VALIDATION & REPLACEMENT ---
                    const brandValue = (newRow['Brand'] || '').trim();
                    if (brandValue && validBrands.length > 0) {
                        // 1. Exact Match (Case-insensitive)
                        const exactMatch = validBrands.find(b => b.toLowerCase() === brandValue.toLowerCase());
                        if (exactMatch) {
                            if (newRow['Brand'] !== exactMatch) {
                                if (logPusher) logPusher(`[Brand Fix] '${newRow['Brand']}' -> '${exactMatch}' (Exact Match)`);
                                newRow['Brand'] = exactMatch;
                                newRow['_brandCorrected'] = true;
                            }
                        } else {
                            // 2. Fuzzy Match (Contains)
                            const fuzzyMatch = validBrands.find(b =>
                                b.toLowerCase().includes(brandValue.toLowerCase()) ||
                                brandValue.toLowerCase().includes(b.toLowerCase())
                            );
                            if (fuzzyMatch) {
                                if (logPusher) logPusher(`[Brand Fix] '${newRow['Brand']}' -> '${fuzzyMatch}' (Fuzzy Match)`);
                                newRow['Brand'] = fuzzyMatch;
                                newRow['_brandCorrected'] = true;
                            } else {
                                newRow['_brandInvalid'] = true;
                            }
                        }
                    }

                    // --- MODEL VALIDATION & REPLACEMENT ---
                    const modelValue = (newRow['Model #'] || '').trim();
                    if (modelValue && validModels.length > 0) {
                        const normalize = (s) => s.toLowerCase().replace(/[\s\-]/g, '');
                        let modelMatch = validModels.find(m => m.toLowerCase() === modelValue.toLowerCase());

                        if (!modelMatch) modelMatch = validModels.find(m => normalize(m) === normalize(modelValue));

                        if (!modelMatch) {
                            const sortedModels = [...validModels].sort((a, b) => b.length - a.length);
                            modelMatch = sortedModels.find(m => {
                                const normM = normalize(m);
                                const normVal = normalize(modelValue);
                                return normVal.includes(normM);
                            });
                        }

                        if (modelMatch) {
                            if (newRow['Model #'] !== modelMatch) {
                                if (logPusher) logPusher(`[Model Fix] '${newRow['Model #']}' -> '${modelMatch}' (Standardized)`);
                                newRow['Model #'] = modelMatch;
                                newRow['_modelCorrected'] = true;
                            }
                        } else {
                            newRow['_modelInvalid'] = true;
                        }
                    }
                    return newRow;
                };

                try {
                    while (retryRound <= maxRetryRounds) {
                        const pendingBatches = allBatches.filter(b => b.status === 'pending' || b.status === 'failed');
                        if (pendingBatches.length === 0) break;
                        const roundLabel = retryRound === 0 ? 'Processing' : `Retry ${retryRound}`;

                        for (let i = 0; i < pendingBatches.length; i += PARALLEL_BATCHES) {
                            const group = pendingBatches.slice(i, i + PARALLEL_BATCHES);
                            setProgress({ percent: Math.round((completedCount / totalBatches) * 100), status: `${roundLabel}: ${group.map(b => b.batchId).join(',')}...` });
                            const results = await Promise.allSettled(group.map(b => processBatch(b)));
                            completedCount += results.filter(r => r.value === true).length;
                            await sleep(300);
                        }
                        retryRound++;
                    }

                    // --- FINAL MERGE & VALIDATION LOGGING ---
                    let newRawRows = [...rawRows];
                    let validationLogCollector = [];
                    const logPusher = (msg) => validationLogCollector.push(msg);

                    // 1. Merge AI Results
                    allBatches.filter(b => b.status === 'success').forEach(batch => {
                        batch.rows.forEach((origRow, idx) => {
                            const match = batch.results && batch.results[idx] ? batch.results[idx] : null;
                            const updatedRow = validateAndMerge(origRow, match, logPusher); // Pass logger here
                            if (updatedRow._originalIndex !== undefined) {
                                newRawRows[updatedRow._originalIndex] = { ...updatedRow };
                            }
                        });
                    });

                    // 2. Global Validation Pass (Validation for ALL rows, even those not processed by AI)
                    newRawRows = newRawRows.map(row => validateAndMerge(row, null, logPusher)); // Pass logger here

                    if (validationLogCollector.length > 0) {
                        setLogHistory(prev => [{
                            id: Date.now(),
                            type: 'validation',
                            messages: validationLogCollector
                        }, ...prev]);
                    }

                    setRawRows(newRawRows);

                    setProgress({ percent: 100, status: `Done! ${completedCount}/${totalBatches} batches.` });
                    showToast(`Audit finished! Validation applied to ${newRawRows.length} rows.`);
                } catch (error) {
                    showToast("Audit Error: " + error.message, "error");
                } finally {
                    setIsProcessing(false);
                }
            };

            const getExportHeaders = () => {
                const dateColumns = fullHeadersOrder.filter(h => /^\d{8}$/.test(h)).sort().reverse();
                return [...EXPORT_COLS_FIXED, ...dateColumns];
            };

            const handleUpdateSheet = async () => {
                const gsUrl = PT_DATA_GS_URL;
                const password = gsPassword;

                if (!password) { showToast("Please enter GS Admin Password in sidebar", "error"); return; }
                if (!gsUrl) return showToast("No GAS URL configured", "error");
                if (!selectedSheet) return showToast("No sheet selected", "error");

                setIsProcessing(true);
                showToast(`Preparing to update ${selectedSheet}...`, "info");

                try {
                    const header = getExportHeaders();
                    const dataRows = rawRows.map(row => header.map(col => {
                        let val = row[col];
                        return (val === undefined || val === null) ? "" : String(val);
                    }));
                    const payloadData = [header, ...dataRows];
                    const payload = {
                        password: password,
                        action: "updateSheet",
                        sheetName: selectedSheet,
                        data: payloadData,
                        startRow: 1,
                        startCol: 4
                    };

                    const response = await fetch(gsUrl, { method: 'POST', body: JSON.stringify(payload) });
                    const result = await response.json();

                    if (result.status === 'success') {
                        showToast(`‚úÖ Updated ${result.rowsWritten} rows!`, "success");
                    } else {
                        if (result.error && result.error.includes("Password")) showToast("Wrong Password.", "error");
                        else throw new Error(result.error || "Unknown Error");
                    }
                } catch (error) {
                    showToast("Update Failed: " + error.message, "error");
                } finally {
                    setIsProcessing(false);
                }
            };

            const handleCopy = () => {
                if (rawRows.length === 0) return showToast("No data", "error");
                const exportHeaders = getExportHeaders();
                let tsv = exportHeaders.join('\t') + '\n';
                rawRows.forEach(row => { tsv += exportHeaders.map(h => sanitizeForExport(row[h])).join('\t') + '\n'; });
                copyToClipboard(tsv, () => showToast(`Copied ${rawRows.length} rows`), () => showToast("Copy failed", "error"));
            };

            const handleDownloadCSV = () => {
                if (rawRows.length === 0) return showToast("No data", "error");
                const exportHeaders = getExportHeaders();
                let csv = '\ufeff' + exportHeaders.map(h => `"${h}"`).join(',') + '\n';
                rawRows.forEach(row => {
                    csv += exportHeaders.map(h => {
                        const val = sanitizeForExport(row[h]);
                        return `"${String(val).replace(/"/g, '""')}"`;
                    }).join(',') + '\n';
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `Audit_${new Date().toISOString().slice(0, 10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <div className="min-h-screen pb-20">
                    {toast && (
                        <div className={`fixed top-5 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-full shadow-2xl font-bold text-white text-sm toast-enter ${toast.type === 'error' ? 'bg-red-500' : 'bg-emerald-600'}`}>
                            {toast.type === 'error' ? '‚ö†Ô∏è' : '‚úÖ'} {toast.message}
                        </div>
                    )}

                    <header className="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
                        <div className="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-3">
                                <div className="bg-indigo-600 text-white p-2 rounded-lg font-black text-xl tracking-tighter">PT</div>
                                <div>
                                    <h1 className="text-xl font-bold text-slate-800 tracking-tight">Product Website Auditor <span className="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full border border-slate-200">GEMINI SEARCH</span></h1>
                                    <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Consistency & Accessories Check v1.0 (Canvas Bridge)</p>
                                </div>
                            </div>
                        </div>
                    </header>

                    <div className="container mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <aside className="lg:col-span-3 space-y-6">
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5 space-y-4 animate-fade-in">
                                <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2">PT Data Âπ≥Âè∞</h3>
                                <button onClick={handleConnect} disabled={isLoading || ptDataSheets.length > 0}
                                    className={`w-full py-2 rounded-lg text-xs font-bold transition-all shadow-sm ${ptDataSheets.length > 0 ? 'bg-emerald-50 text-emerald-600 border border-emerald-200' : 'bg-violet-600 text-white hover:bg-violet-700'}`}>
                                    {isLoading ? '...' : ptDataSheets.length > 0 ? `‚úì CONNECTED (${ptDataSheets.length} sheets)` : 'CONNECT PT DATA'}
                                </button>
                                <div className="space-y-1">
                                    <label className="text-[10px] font-bold text-slate-500 uppercase">Select Sheet</label>
                                    <select value={selectedSheet} onChange={e => handleLoadSheet(e.target.value)} disabled={ptDataSheets.length === 0}
                                        className="w-full bg-violet-50 border border-violet-200 text-violet-700 text-sm rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-violet-500 disabled:opacity-50 font-medium">
                                        <option value="">{ptDataSheets.length > 0 ? "Select sheet..." : "Connect first..."}</option>
                                        {ptDataSheets.map(n => <option key={n} value={n}>{n.replace('Data_', 'PT Data - ')}</option>)}
                                    </select>
                                </div>
                            </div>

                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5 space-y-4 animate-fade-in" style={{ animationDelay: '0.1s' }}>
                                <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2">Configuration</h3>
                                <div className="bg-blue-50 border border-blue-100 rounded-lg p-3">
                                    <p className="text-[10px] text-blue-600 font-bold">API Access Bridged</p>
                                    <p className="text-[10px] text-blue-500">Gemini Key provided by Canvas Environment</p>
                                </div>
                                <div className="space-y-1">
                                    <label className="text-[10px] font-bold text-slate-500 uppercase">GS Admin Password</label>
                                    <input type="password" value={gsPassword} onChange={e => setGsPassword(e.target.value)} placeholder="557..."
                                        className="w-full bg-slate-50 border border-slate-200 text-slate-600 text-xs rounded-lg p-2 font-mono" />
                                </div>
                                <label className="flex items-center gap-2 cursor-pointer pt-2">
                                    <input type="checkbox" checked={onlyEmptyAccessories} onChange={e => setOnlyEmptyAccessories(e.target.checked)}
                                        className="w-4 h-4 text-violet-600 bg-slate-100 border-slate-300 rounded focus:ring-violet-500" />
                                    <span className="text-xs text-slate-600 font-medium">Process Missing Info Only</span>
                                </label>
                            </div>

                            <button onClick={startAudit} disabled={isProcessing || !selectedSheet}
                                className={`w-full py-4 rounded-xl shadow-lg font-black text-sm tracking-wide transition-all transform hover:scale-[1.02] active:scale-[0.98] ${isProcessing ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white hover:shadow-indigo-200'}`}>
                                {isProcessing ? (
                                    <div className="flex flex-col items-center gap-1">
                                        <div className="w-4 h-4 border-2 border-slate-300 border-t-indigo-500 rounded-full animate-spin"></div>
                                        <span className="text-[10px] font-mono">{progress.status}</span>
                                    </div>
                                ) : <span className="flex items-center justify-center gap-2">START AUDIT PROCESS <span>‚ûî</span></span>}
                            </button>
                        </aside>

                        <main className="lg:col-span-9 space-y-6">
                            <div className="bg-white rounded-xl p-2 border border-slate-200 shadow-sm flex flex-wrap gap-2 items-center justify-between">
                                <div className="flex gap-2">
                                    <button onClick={() => setLogViewer(p => ({ ...p, isOpen: !p.isOpen }))} className="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg text-xs font-bold transition-colors">
                                        {logViewer.isOpen ? 'Hide Logs' : 'Show Logs'}
                                    </button>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={handleCopy} className="px-5 py-2 bg-purple-50 text-purple-600 border border-purple-100 hover:bg-purple-100 rounded-lg text-xs font-bold transition-colors shadow-sm flex items-center gap-2">
                                        <span>Copy Data</span><span className="bg-purple-200/50 px-1.5 rounded text-[9px]">Full</span>
                                    </button>
                                    <button onClick={handleDownloadCSV} disabled={rawRows.length === 0} className="px-4 py-2 bg-purple-50 text-purple-600 border border-purple-100 hover:bg-purple-100 rounded-lg text-xs font-bold transition-colors disabled:opacity-50 shadow-sm">Download CSV</button>
                                    <button onClick={handleUpdateSheet}
                                        disabled={isProcessing || !selectedSheet}
                                        className={`px-4 py-2 rounded-lg text-xs font-bold transition-colors shadow-md flex items-center gap-2 border border-transparent ${isProcessing || !selectedSheet ? "bg-slate-100 text-slate-400 cursor-not-allowed" : "bg-purple-600 hover:bg-purple-700 text-white shadow-purple-200"}`}>
                                        <span>üìù Update Sheet</span>
                                    </button>
                                </div>
                            </div>

                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[600px] relative">
                                <div className="bg-slate-50 border-b border-slate-200 px-4 py-2 flex justify-between items-center">
                                    <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{processedBatches.length > 0 ? 'Audit Results' : 'Preview / Raw Data'}</div>
                                    {isProcessing && (
                                        <div className="flex items-center gap-3">
                                            <div className="w-32 h-1.5 bg-slate-200 rounded-full overflow-hidden"><div className="h-full bg-indigo-500 transition-all duration-300" style={{ width: `${progress.percent}%` }}></div></div>
                                            <span className="text-[10px] font-bold text-indigo-600">{progress.percent}%</span>
                                        </div>
                                    )}
                                </div>

                                <div className="flex-1 overflow-auto bg-white scrollbar-thin">
                                    <table className="w-full text-[11px] border-collapse min-w-[1000px]">
                                        <thead className="bg-slate-50 sticky top-0 z-10 shadow-sm">
                                            <tr>
                                                {displayHeaders.map(h => (
                                                    <th key={h} className="p-3 text-left font-bold text-slate-600 border-r border-slate-200 last:border-0 whitespace-nowrap bg-slate-50">{h}</th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {(processedBatches.length > 0 ? processedBatches.flatMap(b => b.corrected) : rawRows).length === 0 ? (
                                                <tr><td colSpan={displayHeaders.length} className="p-20 text-center text-slate-300 font-bold uppercase tracking-widest">No Data Loaded</td></tr>
                                            ) : (
                                                (processedBatches.length > 0 ? processedBatches.flatMap(b => b.corrected) : rawRows).map((row, i) => {
                                                    const status = row["Audit Status"];
                                                    return (
                                                        <tr key={i} className="hover:bg-slate-50 transition-colors">
                                                            {displayHeaders.map(h => {
                                                                let cellClass = "p-2 border-r border-slate-100 text-slate-600 whitespace-nowrap overflow-hidden text-ellipsis max-w-[200px]";
                                                                let cellStyle = {};
                                                                if (h === "Audit Status") {
                                                                    if (status === "OK") cellClass += " bg-emerald-50 text-emerald-700 font-bold";
                                                                    else if (status === "Mismatch") cellClass += " bg-red-50 text-red-700 font-bold";
                                                                    else if (status === "Invalid URL") cellClass += " bg-amber-50 text-amber-700 font-bold";
                                                                }
                                                                if (h === "Brand" && (row['_brandCorrected'] || row['_brandInvalid'])) {
                                                                    cellClass += " font-bold";
                                                                    cellStyle = { color: '#dc2626', backgroundColor: '#fef2f2' };
                                                                }
                                                                if (h === "Model #" && (row['_modelCorrected'] || row['_modelInvalid'])) {
                                                                    cellClass += " font-bold";
                                                                    cellStyle = { color: '#dc2626', backgroundColor: '#fef2f2' };
                                                                }
                                                                return <td key={h} className={cellClass} style={cellStyle}>{row[h]}</td>;
                                                            })}
                                                        </tr>
                                                    );
                                                })
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {logViewer.isOpen && logHistory.length > 0 && (
                                <div className="bg-slate-900 rounded-xl p-0 overflow-hidden shadow-2xl animate-fade-in border border-slate-800 absolute bottom-0 right-0 w-full max-h-[500px] z-50 flex flex-col">
                                    <div className="bg-slate-800 px-4 py-3 flex justify-between items-center border-b border-slate-700">
                                        <h3 className="text-indigo-400 font-black text-xs uppercase tracking-widest">System Logs ({logHistory.length})</h3>
                                        <button onClick={() => setLogViewer(p => ({ ...p, isOpen: false }))} className="text-slate-400 hover:text-white transition-colors">‚úï</button>
                                    </div>
                                    <div className="p-4 overflow-y-auto bg-slate-900 scrollbar-thin flex-1">
                                        {logHistory.map((log, idx) => (
                                            <div key={idx} className="mb-4 border-b border-slate-800 pb-2 last:border-0">
                                                <div className="flex gap-2 items-center mb-1">
                                                    <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${log.type === 'validation' ? 'bg-amber-900/50 text-amber-500' :
                                                            log.type === 'error' ? 'bg-red-900/50 text-red-500' :
                                                                log.type === 'info' ? 'bg-blue-900/50 text-blue-500' :
                                                                    'bg-slate-800 text-slate-400'
                                                        }`}>{log.type?.toUpperCase() || 'INFO'}</span>
                                                    <span className="text-[10px] text-slate-500">{new Date(log.id).toLocaleTimeString()}</span>
                                                </div>

                                                {log.messages ? (
                                                    <ul className="list-disc pl-4 space-y-1">
                                                        {log.messages.map((msg, mIdx) => (
                                                            <li key={mIdx} className="text-[11px] font-mono text-amber-200/90">{msg}</li>
                                                        ))}
                                                    </ul>
                                                ) : (
                                                    <pre className="text-[10px] font-mono text-slate-300 whitespace-pre-wrap">{
                                                        typeof log.data === 'object' ? JSON.stringify(log.data, null, 2) :
                                                            log.message || JSON.stringify(log)
                                                    }</pre>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>