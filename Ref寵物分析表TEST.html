<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨ç´åˆ†æå„€è¡¨æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <!-- Font Awesome for swap icon/settings icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- ** å¼•å…¥ D3.js å’Œ D3-Sankey (æ–°å¢) ** -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <!-- ** æˆªåœ–åŠŸèƒ½ ** -->
    <!-- ** æ–°å¢ï¼šå¼•å…¥ Plotly.js ç”¨æ–¼ç›¸ä¼¼åº¦åˆ†æ ** -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        .chart-container {
            position: relative;
            width: 100%;
            transition: height 0.3s ease-in-out;
            min-height: 500px;
        }
        /* -- é‚„åŸï¼šå–®ä¸€æ¬„ä½åœ–è¡¨å®¹å™¨ (é•·æ¢åœ–) -- */
        .small-chart-container {
            position: relative;
            width: 100%;
            /* ä¿®æ­£ï¼šç§»é™¤å›ºå®šé«˜åº¦ï¼Œäº¤çµ¦ JS å‹•æ…‹è¨ˆç®— */
        }
        
        /* --- ç¯©é¸å™¨æ¨£å¼ --- */
        .filter-dropdown summary {
            cursor: pointer; padding: 0.5rem 1rem; border: 1px solid #d1d5db;
            border-radius: 0.375rem; background-color: white;
            transition: background-color 0.2s, border-color 0.2s;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .filter-dropdown summary:hover { background-color: #f9fafb; }
        .filter-dropdown[open] summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .filter-dropdown .filter-panel {
            max-height: 250px; overflow-y: auto; border: 1px solid #d1d5db; border-top: none;
            padding: 0.75rem; background-color: white; z-index: 10; position: absolute;
            width: 100%; border-bottom-left-radius: 0.375rem; border-bottom-right-radius: 0.375rem;
        }
        .filter-dropdown { position: relative; }
        
        /* å¤šé‡é¸å–æ¡†æ¨£å¼ */
        .multi-select-box {
            border: 1px solid #d1d5db; border-radius: 0.375rem;
            padding: 0.5rem; max-height: 150px; overflow-y: auto;
            background-color: white;
        }
        .multi-select-box label { display: block; margin-bottom: 0.25rem; }
        
        .question-annotation {
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #4b5563;
            min-height: 40px;
            font-style: italic;
        }
        .filter-active {
            background-color: #fefce8 !important; /* bg-yellow-50 */
            border-color: #fde047 !important; /* border-yellow-300 */
            font-weight: 600; /* semibold */
        }
        
        /* --- æ¨™è¨˜æ¨£å¼ (ç®­é ­/åˆ†ä½æ•¸/å¹³å‡) --- */
        #markerContainer {
             position: absolute; top: 0; left: 0; width: 100%; height: 100%;
             pointer-events: none; overflow: hidden;
        }
        /* 1. ä¸Šæ–¹åœ–ä¾‹ç®­é ­ (è—è‰²) */
        .chart-arrow {
            position: absolute; display: none; pointer-events: none; z-index: 10;
            width: 0; height: 0;
            border-left: 6px solid transparent; border-right: 6px solid transparent; 
            border-top: 8px solid #2563eb; /* blue-600 */
            transform: translateX(-50%);
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.2));
        }
        /* 2. ä¸‹æ–¹åˆ†ä½æ•¸æ¨™è¨˜ (ç´…è‰²/ç²‰è‰²) */
        .quantile-marker {
            position: absolute; display: none; pointer-events: none; z-index: 10;
            width: 0; height: 0;
            border-left: 6px solid transparent; border-right: 6px solid transparent;
            border-bottom: 8px solid #dc2626; /* red-600 */
            transform: translateX(-50%);
        }
        .quantile-marker-q2 { /* ä¸­ä½æ•¸ Q2 */
            border-left-width: 8px; border-right-width: 8px;
            border-bottom-width: 10px;
            border-bottom-color: #f472b6; /* pink-400 */
        }
         /* 3. å¹³å‡æ•¸æ¨™ç±¤ (é•·æ¢åœ–æœ«ç«¯å¤–å´) */
        .average-label {
            position: absolute; display: none; pointer-events: none; z-index: 10;
            background-color: rgba(255, 255, 255, 0.9); /* ç™½è‰²åŠé€æ˜èƒŒæ™¯ */
            color: black; /* é»‘è‰²æ–‡å­— */
            padding: 2px 6px;
            font-size: 0.75rem;
            font-weight: bold;
            transform: translateY(-50%); /* å‚ç›´ç½®ä¸­ */
            border-radius: 3px;
            border: 1px solid #e5e7eb; /* æ·¡ç°è‰²é‚Šæ¡† */
            white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ›è¡Œ */
        }
        /* --- çµæŸæ¨™è¨˜æ¨£å¼ --- */

        /* åœ–ä¾‹æ¨£å¼ */
        #arrowSelectContainer label { font-size: 0.875rem; font-weight: 600; color: #4b5563; }
        #arrowSelect { margin-left: 0.5rem; padding: 0.25rem 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
        .legend-item { cursor: pointer; transition: opacity 0.2s; }
        .legend-item-hidden { opacity: 0.5; text-decoration: line-through; }
        
        /* -- æ”¶æŠ˜å€å¡Šæ¨£å¼ -- */
        details summary {
            cursor: pointer;
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e3a8a; /* text-blue-900 */
            background-color: #eef2ff; /* bg-indigo-50 */
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        details[open] summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        details summary:hover {
            background-color: #e0e7ff; /* bg-indigo-100 */
        }
        details > div {
            border: 1px solid #e0e7ff;
            border-top: none;
            padding: 1.5rem;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }

        /* --- è¨­å®š Modal æ¨£å¼ --- */
        .modal {
            display: none; position: fixed; z-index: 50; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.4); 
        }
        .modal-content {
            background-color: #fefefe; margin: 10% auto; padding: 20px;
            border: 1px solid #888; width: 90%; max-width: 500px;
            border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .close-button {
            color: #aaa; float: right; font-size: 28px; font-weight: bold;
            line-height: 1; cursor: pointer; transition: color 0.2s;
        }
        .close-button:hover, .close-button:focus { color: #000; text-decoration: none; }

        /* --- Sankey å°ˆç”¨æ¨£å¼ (å„ªåŒ–) --- */
        #sankeyChart svg { 
            width: 100%; 
            height: 100%; 
            max-height: 600px; /* é™åˆ¶æ¡‘åŸºåœ–æœ€å¤§é«˜åº¦ */
        }
        .sankey-link {
            fill: none;
            stroke-opacity: 0.4; /* èª¿æ•´é€æ˜åº¦ï¼Œè®“æµå‹•æ„Ÿæ›´å¼· */
            transition: stroke-opacity 0.2s;
        }
        .sankey-link:hover {
            stroke-opacity: 0.7; /* æ»‘é¼ æ‡¸åœæ™‚æ›´æ˜é¡¯ */
        }
        .sankey-node rect {
            fill-opacity: 1; /* ç¯€é»å¯¦è‰² */
            shape-rendering: crispEdges;
            cursor: pointer;
            border-radius: 4px; /* å¢åŠ åœ“è§’ */
            transition: fill-opacity 0.2s;
            /* ä¿®æ­£ï¼šç§»é™¤ç¯€é»æ¡†ç·š */
            stroke-width: 0; 
        }
        /* ä¿®æ­£ Sankey æ¨™ç±¤ï¼Œè®“åœ–ä¾‹å–ä»£åŸæœ¬çš„æ¨™ç±¤ */
        .sankey-node text {
            display: none; /* éš±è— D3 å…§å»ºçš„æ¨™ç±¤ */
        }
        /* æ–°å¢ Sankey åœ–ä¾‹æ¨£å¼ */
        .sankey-legend-item {
            font-size: 0.875rem;
            color: #4b5563;
            margin-bottom: 0.25rem;
            word-break: break-word;
        }

        /* --- å–®æ¬„åˆ†ææ’ç‰ˆä¿®æ­£æ¨£å¼ --- */
        .small-chart-header {
             /* ç¢ºä¿æ¨™é¡Œå’Œåœ–ä¾‹å°é½Š */
             min-height: 20px;
             line-height: 1.2;
        }

        /* --- çµæ§‹å·®ç•°åˆ†ææ¨£å¼ --- */
        .comparison-chart-card {
            break-inside: avoid;
            transition: all 0.3s ease;
        }
        .comparison-legend-table th { font-weight: 600; color: #64748b; }
        .comparison-legend-table td { color: #334155; }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .comparison-sub-chart-container {
            position: relative;
            /* height: 120px; */ /* ç§»é™¤å›ºå®šé«˜åº¦ï¼Œæ”¹ç”± JS å‹•æ…‹è¨­å®š */
        }

        /* --- ç›¸ä¼¼åº¦åˆ†æå€å¡Šæ¨£å¼ (å¾ç›¸ä¼¼åº¦å°ç…§åœ–.html å€Ÿé‘’) --- */
        .sim-diff-table th { background-color: #f9fafb; color: #374151; font-weight: 600; padding: 12px; text-align: left; font-size: 0.875rem; border-bottom: 2px solid #e5e7eb; }
        .sim-diff-table td { padding: 12px; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem; color: #1f2937; }
        .sim-diff-table tr:hover { background-color: #f3f4f6; }
        .sim-diff-positive { color: #059669; font-weight: bold; }
        .sim-diff-negative { color: #dc2626; font-weight: bold; }
        .sim-bar-container { width: 100px; height: 6px; background-color: #e5e7eb; border-radius: 3px; overflow: hidden; display: inline-block; vertical-align: middle; margin-right: 8px; }
        .sim-bar-fill { height: 100%; border-radius: 3px; }
        .sim-stats-card {
            background-color: #f9fafb; /* bg-gray-50 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1rem; /* p-4 */
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    
    <!-- é ‚éƒ¨è¨­å®šæŒ‰éˆ• -->
    <div class="fixed top-4 right-4 z-40">
        <!-- ** ä¿®æ­£ï¼šä½¿ç”¨ w-10 h-10 ç¢ºä¿æ­£åœ“å½¢ ** -->
        <button id="settingsButton" class="w-10 h-10 flex justify-center items-center bg-white rounded-full shadow-lg text-blue-600 hover:bg-gray-50 transition" title="è¨­å®š"><i class="fas fa-cog text-xl"></i></button>
    </div>

    <!-- è¨­å®š Modal è¦–çª— -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeSettingsModal">&times;</span>
            <h2 class="text-2xl font-bold text-blue-800 mb-6">åœ–è¡¨å¤–è§€è¨­å®š</h2>

            <div class="space-y-6">
                <!-- 1. æ•¸å€¼æ¨™ç±¤å­—é«”å¤§å° -->
                <div>
                    <label for="datalabelsSize" class="block text-lg font-medium text-gray-700 mb-2">
                        æ•¸å€¼æ¨™ç±¤å­—é«”å¤§å° (<span id="datalabelsSizeValue">13</span> px)
                    </label>
                    <input type="range" id="datalabelsSize" min="8" max="16" value="13" step="1" 
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg">
                    <p class="text-sm text-gray-500 mt-1">æ§åˆ¶é•·æ¢åœ–ä¸Šç™¾åˆ†æ¯”/ç­†æ•¸æ–‡å­—çš„å¤§å°ã€‚</p>
                </div>
                
                <!-- 2. BAR çš„é«˜åº¦ (å›ºå®šåƒç´ ) -->
                <div>
                    <label for="barThickness" class="block text-lg font-medium text-gray-700 mb-2">
                        å–®æ¬„åˆ†æé•·æ¢åœ–é«˜åº¦ (<span id="barThicknessValue">4</span> px)
                    </label>
                    <!-- å›ºå®šåƒç´ é«˜åº¦ï¼š4px åˆ° 25px -->
                    <input type="range" id="barThickness" min="4" max="25" value="4" step="1" 
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg">
                    <p class="text-sm text-gray-500 mt-1">è¨­å®šå–®æ¬„åˆ†æçš„é•·æ¢åœ–é«˜åº¦ï¼ˆ4-25 åƒç´ ï¼‰ã€‚</p>
                </div>
            </div>
        </div>
    </div>


    <div class="w-full p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-800">æ¨ç´åˆ†æå„€è¡¨æ¿</h1>
            <p class="text-gray-600 mt-2">å‹•æ…‹é•·æ¢åœ–åˆ†æ</p>
        </header>

        <!-- è¨­å®šæ­¥é©Ÿ -->
        <div id="setupInstructions" class="max-w-4xl mx-auto mb-8 p-6 bg-blue-50 border-2 border-blue-200 rounded-lg">
            <h2 class="text-xl font-bold text-blue-800 mb-4">ğŸ“‹ è¨­å®šç‹€æ…‹</h2>
            <p class="text-gray-700">è³‡æ–™å°‡æ–¼é é¢é–‹å•Ÿæ™‚è‡ªå‹•è¼‰å…¥ã€‚å¦‚éœ€è®Šæ›´è³‡æ–™ä¾†æºï¼Œè«‹ä¿®æ”¹ç¨‹å¼ç¢¼å…§ <code>DEFAULT_SCRIPT_URL</code> è®Šæ•¸ã€‚</p>
        </div>

        <!-- è¼‰å…¥ä¸­ -->
        <!-- ä¿®æ­£ 2.1: åˆå§‹æ™‚ç§»é™¤ hiddenï¼Œè®“è¼‰å…¥ç•«é¢é¡¯ç¤º -->
        <div id="loading" class="text-center p-8"> 
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-lg" id="loadingMessage">æ­£åœ¨è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¨å€™...</p>
            <!-- ä¿®æ­£ 2.3: æ–°å¢éŒ¯èª¤è³‡è¨Šé¡¯ç¤ºå€å¡Š (åˆå§‹éš±è—) -->
            <div id="debugInfoContainer" class="hidden mt-4 max-w-xl mx-auto">
                <h3 class="font-bold text-gray-700">è¼‰å…¥æ—¥èªŒ:</h3>
                <div id="debugInfo" class="mt-2 text-sm text-red-600 text-left bg-white p-4 rounded shadow border border-gray-200"></div>
            </div>
        </div>

        <!-- å„€è¡¨æ¿ -->
        <main id="dashboard" class="hidden lg:grid lg:grid-cols-12 lg:gap-6">
            <div class="lg:col-span-10 space-y-6">
                
                <!-- 
                  =================================
                  æ–°å¢: æ¨ç´åœ–è¡¨åˆ†æ
                  =================================
                -->
                <details id="pivotTableSection">
                    <summary>æ¨ç´åœ–è¡¨åˆ†æ</summary>
                    <div class="space-y-6">
                        <div class="p-4 bg-white rounded-lg shadow-md">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <!-- åˆ—è¨­å®š -->
                                <div class="space-y-3">
                                    <h3 class="text-sm font-semibold text-gray-700 border-b pb-1">åˆ— (Row)</h3>
                                    
                                    <!-- ä¸»è¦åˆ— -->
                                    <div>
                                        <label for="pivotRowMainSelect" class="block text-xs font-medium text-gray-600">ä¸»è¦åˆ†çµ„</label>
                                        <select id="pivotRowMainSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                            <option value="">ç„¡</option>
                                        </select>
                                    </div>
                                    
                                    <!-- æ¬¡è¦åˆ— -->
                                    <div>
                                        <label for="pivotRowSubSelect" class="block text-xs font-medium text-gray-600">æ¬¡è¦åˆ†çµ„ï¼ˆå¯é¸ï¼‰</label>
                                        <select id="pivotRowSubSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                            <option value="">ç„¡</option>
                                        </select>
                                    </div>

                                    <!-- ç¬¬ä¸‰å±¤ -->
                                    <div>
                                        <label for="pivotRowLevel3Select" class="block text-xs font-medium text-gray-600">ç¬¬ä¸‰å±¤åˆ†çµ„ï¼ˆå¯é¸ï¼‰</label>
                                        <select id="pivotRowLevel3Select" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                            <option value="">ç„¡</option>
                                        </select>
                                    </div>
                                    <!-- ç¬¬å››å±¤ -->
                                    <div>
                                        <label for="pivotRowLevel4Select" class="block text-xs font-medium text-gray-600">ç¬¬å››å±¤åˆ†çµ„ï¼ˆå¯é¸ï¼‰</label>
                                        <select id="pivotRowLevel4Select" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                            <option value="">ç„¡</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- æ¬„è¨­å®š -->
                                <div class="space-y-3">
                                    <h3 class="text-sm font-semibold text-gray-700 border-b pb-1">æ¬„ (Column) - æ•¸æ“šæ¬„ä½</h3>
                                    <div id="pivotColumnsContainer" class="space-y-2 max-h-64 overflow-y-auto">
                                        <!-- å‹•æ…‹ç”Ÿæˆçš„æ¬„ä½é¸æ“‡å™¨å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                                    </div>
                                    <button id="addPivotColumn" class="w-full py-1.5 px-3 text-sm bg-indigo-50 hover:bg-indigo-100 text-indigo-700 rounded-md border border-indigo-200">
                                        + æ–°å¢æ•¸æ“šæ¬„
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è¨­å®šæª”ç®¡ç†æŒ‰éˆ• -->
                        <div class="bg-gray-50 p-3 rounded-lg mb-4 border border-gray-200">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-gray-700">è¨­å®šæª”ç®¡ç†</span>
                            </div>
                            <div class="flex gap-2">
                                <button id="pivotTable-export-config" class="text-xs bg-amber-600 text-white px-3 py-1.5 rounded hover:bg-amber-700 flex-1">
                                    <i class="fas fa-download mr-1"></i> åŒ¯å‡ºè¨­å®šæª”
                                </button>
                                <button id="pivotTable-import-config" class="text-xs bg-teal-600 text-white px-3 py-1.5 rounded hover:bg-teal-700 flex-1">
                                    <i class="fas fa-upload mr-1"></i> åŒ¯å…¥è¨­å®šæª”
                                </button>
                                <button id="pivotTable-clear-config" class="text-xs bg-red-600 text-white px-3 py-1.5 rounded hover:bg-red-700 flex-1">
                                    <i class="fas fa-times mr-1"></i> æ¸…é™¤è¨­å®š
                                </button>
                                <input type="file" id="pivotTable-config-file" accept=".json" class="hidden">
                            </div>
                        </div>
                        
                        <!-- æ¨ç´åˆ†æè¡¨æ ¼é¡¯ç¤ºå€ -->
                        <div class="bg-white p-4 rounded-lg shadow-lg overflow-x-auto">
                            <!-- åŠŸèƒ½æŒ‰éˆ• -->
                            <div class="flex justify-end mb-2 gap-2">
                                <button id="pivotTable-export-csv" class="text-xs bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700">
                                    <i class="fas fa-file-csv mr-1"></i> åŒ¯å‡º CSV
                                </button>
                                <button id="pivotTable-add-all-columns" class="text-xs bg-purple-600 text-white px-3 py-1.5 rounded hover:bg-purple-700">
                                    <i class="fas fa-plus-circle mr-1"></i> æ·»åŠ å…¨éƒ¨æ¬„ä½
                                </button>
                                <button id="pivotTable-download-screenshot" class="text-xs bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700">
                                    <i class="fas fa-camera mr-1"></i> ä¸‹è¼‰æˆªåœ–
                                </button>
                            </div>
                            <div id="pivotTable-screenshot-status" class="text-sm text-green-700 hidden mb-2 text-right"></div>
                            
                            <div id="pivotTableContainer" class="text-sm">
                                <p class="text-gray-500">è«‹é¸æ“‡åˆ—å’Œæ¬„ä»¥ç”Ÿæˆæ¨ç´åˆ†æè¡¨</p>
                            </div>
                        </div>
                    </div>
                </details>
                
                <!-- 
                  =================================
                  å€å¡Š 1: äº¤å‰é•·æ¢åœ–åˆ†æ (äº¤å‰æ¯”è¼ƒ)
                  =================================
                -->
                <details id="pivotSection">
                    <!-- ä¿®æ­£åç¨± -->
                    <summary>äº¤å‰é•·æ¢åœ–åˆ†æ</summary>
                    <div class="space-y-6">
                        <div class="p-4 bg-white rounded-lg shadow-md">
                            <div class="flex flex-col md:flex-row items-start md:items-center gap-4 mb-4">
                                <div class="w-full md:flex-1">
                                    <div id="yAxisQuestion" class="question-annotation">è«‹é¸æ“‡ã€Œåˆ—ã€æ¬„ä½...</div>
                                    <label for="yAxisSelect" class="block text-sm font-medium text-gray-700">æ¨ç´åˆ†æã€Œåˆ—ã€</label>
                                    <select id="yAxisSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                                </div>
                                <div class="w-full md:w-auto flex justify-center">
                                    <button id="swapAxesButton" class="p-2 mt-0 md:mt-10 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition" title="äº¤æ›ã€Œåˆ—ã€èˆ‡ã€Œæ¬„ã€"><i class="fas fa-exchange-alt"></i></button>
                                </div>
                                <div class="w-full md:flex-1">
                                    <div id="colorByQuestion" class="question-annotation">è«‹é¸æ“‡ã€Œæ¬„ã€æ¬„ä½...</div>
                                    <label for="colorBySelectContainer" class="block text-sm font-medium text-gray-700">æ¨ç´åˆ†æã€Œæ¬„ã€</label>
                                    <!-- ã€Œæ¬„ã€çš„å®¹å™¨ (å–®é¸) -->
                                    <div id="colorBySelectContainer" class="mt-1">
                                        <select id="colorBySelect" class="block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                            <option value="none">ä¸åˆ†çµ„ (å–®ä¸€é¡è‰²)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="valueSelect" class="block text-sm font-medium text-gray-700">æ¨ç´åˆ†æã€Œå€¼ã€ (Value)</label>
                                <select id="valueSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="count" selected>ç­†æ•¸ (COUNTA)</option>
                                    <option value="percent">å„åˆ—ä½”æ¯” (%)</option>
                                </select>
                                <!-- ** ä¿®æ­£ 2ï¼šç§»é™¤å…±ç”¨æç¤º ** -->
                                <!-- <p class="mt-1 text-xs text-gray-500">æ­¤é¸é …æœƒåŒæ™‚å¥—ç”¨åˆ°ä¸‹æ–¹çš„ã€Œå–®ä¸€æ¬„ä½åˆ†æã€ã€‚</p> -->
                            </div>
                        </div>
                        <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                            <!-- æ·»åŠ æˆªåœ–æŒ‰éˆ• -->
                            <div class="flex justify-end mb-2 gap-2">
                                <button id="pivot-export-csv" class="text-xs bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700">
                                    <i class="fas fa-file-csv mr-1"></i> åŒ¯å‡º CSV
                                </button>
                                <button id="pivot-add-all-columns" class="text-xs bg-purple-600 text-white px-3 py-1.5 rounded hover:bg-purple-700">
                                    <i class="fas fa-plus-circle mr-1"></i> æ·»åŠ å…¨éƒ¨æ¬„ä½
                                </button>
                                <button id="pivot-download-screenshot" class="text-xs bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700">
                                    <i class="fas fa-camera mr-1"></i> ä¸‹è¼‰æˆªåœ–
                                </button>
                            </div>
                            <div id="pivot-screenshot-status" class="text-sm text-green-700 hidden mb-2 text-right"></div>
                            
                            <div id="chartHeader" class="mb-2 space-y-2">
                                <!-- æ¨™é¡Œåˆ— -->
                                <div class="flex justify-between items-center">
                                    <h3 id="yAxisChartTitle" class="text-lg font-bold text-gray-800"></h3>
                                    <h3 id="cAxisChartTitle" class="text-lg font-bold text-gray-800"></h3>
                                </div>
                                
                                <!-- æ§åˆ¶é …å’Œåœ–ä¾‹åˆ— -->
                                <div class="flex justify-between items-start gap-4">
                                    <div class="flex-shrink-0">
                                        <!-- æ¬¡è¦åˆ†çµ„é¸å–® -->
                                        <div id="subGroupContainer" class="hidden">
                                            <label for="subGroupSelect" class="text-xs font-medium text-gray-600 mr-2">æ¬¡è¦åˆ†çµ„:</label>
                                            <select id="subGroupSelect" class="text-xs py-1 px-2 border border-gray-300 bg-white rounded shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                                <option value="">ç„¡</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="flex-1 flex flex-col items-end gap-2">
                                        <div id="customLegend" class="flex flex-wrap gap-x-4 gap-y-1 justify-end max-h-32 overflow-y-auto pr-1 w-full"></div>
                                        <div id="arrowSelectContainer" class="text-right hidden">
                                            <label for="arrowSelect" class="text-xs mr-1">ç®­é ­:</label>
                                            <select id="arrowSelect" class="text-xs py-1 px-2 border border-gray-300 bg-white rounded shadow-sm"><option value="">è«‹é¸æ“‡</option></select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container" id="pivotChartContainer">
                                <canvas id="mainChart"></canvas>
                                <!-- å®¹å™¨ï¼šæ”¾ç½®æ‰€æœ‰æ¨™è¨˜ (ç®­é ­/åˆ†ä½æ•¸/å¹³å‡) -->
                                <div id="markerContainer"></div>
                            </div>
                        </div>
                    </div>
                </details>
                
                <!-- 
                  =================================
                  å€å¡Š 3: æ¡‘åŸºåœ– (Sankey Diagram)
                  =================================
                -->
                <details id="sankeySection">
                    <!-- ä¿®æ­£åç¨± -->
                    <summary>æ¡‘åŸºåˆ†æ</summary>
                    <div class="space-y-6" id="sankeyContentArea">
                        <div class="p-4 bg-white rounded-lg shadow-md">
                            <!-- Full Screen Button & Download Button -->
                            <div class="flex justify-end mb-2 gap-2">
                                <span id="sankey-screenshot-status" class="text-sm text-gray-600 hidden self-center"></span>
                                <button id="sankey-download-screenshot" class="text-sm bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700 transition">
                                    <i class="fas fa-camera mr-1"></i> ä¸‹è¼‰æˆªåœ–
                                </button>
                                <button id="sankeyFullScreenBtn" class="text-sm bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700 transition">
                                    <i class="fas fa-expand mr-1"></i> å…¨è¢å¹•æ¨¡å¼
                                </button>
                            </div>

                            <div class="flex flex-col md:flex-row items-start md:items-center gap-4 mb-4">
                                <div class="w-full md:flex-1">
                                    <label for="sankeySourceSelect" class="block text-sm font-medium text-gray-700">èµ·é» (A)</label>
                                    <select id="sankeySourceSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                                </div>
                                
                                <div class="w-full md:w-auto flex justify-center pt-6">
                                    <i class="fas fa-arrow-right text-gray-400"></i>
                                </div>

                                <div class="w-full md:flex-1">
                                    <label for="sankeyIntermediateSelect" class="block text-sm font-medium text-gray-700">ä¸­ç¹¼é» (B) (é¸å¡«)</label>
                                    <select id="sankeyIntermediateSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                        <option value="">ç„¡ (ç›´æ¥æµå‘çµ‚é»)</option>
                                    </select>
                                </div>

                                <div class="w-full md:w-auto flex justify-center pt-6">
                                    <i class="fas fa-arrow-right text-gray-400"></i>
                                </div>

                                <div class="w-full md:flex-1">
                                    <label for="sankeyTargetSelect" class="block text-sm font-medium text-gray-700">çµ‚é» (C)</label>
                                    <select id="sankeyTargetSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="sankeyMinThreshold" class="block text-sm font-medium text-gray-700">æœ€å°ç­†æ•¸é–€æª» (Min Count: <span id="sankeyMinThresholdValue">3</span>)</label>
                                <input type="range" id="sankeyMinThreshold" min="1" max="10" value="3" step="1" 
                                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg">
                                <p class="text-xs text-gray-500 mt-1">ä½æ–¼æ­¤é–€æª»çš„é€£ç·šå°‡è¢«å¿½ç•¥ï¼Œä»¥ç°¡åŒ–åœ–è¡¨ã€‚</p>
                            </div>
                        </div>

                        <div id="sankeyChartContainer" class="bg-white p-4 md:p-6 rounded-lg shadow-lg relative">
                            <!-- Close Full Screen Button (Hidden by default) -->
                            <button id="exitSankeyFullScreenBtn" class="hidden absolute top-4 right-4 text-gray-600 hover:text-gray-900 z-50 bg-white rounded-full p-2 shadow-md">
                                <i class="fas fa-times text-xl"></i>
                            </button>

                            <h3 class="text-lg font-bold text-gray-800 mb-4">è³‡æ–™æµå‹•è·¯å¾‘</h3>
                            <!-- æ¡‘åŸºåœ–ä¾‹ -->
                            <div class="flex flex-col md:flex-row justify-between mb-4 gap-4">
                                <div id="sankeySourceLegend" class="w-full md:w-1/3 space-y-1">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-2" id="sourceLegendTitle">èµ·é»åœ–ä¾‹ (A)</h4>
                                </div>
                                <div id="sankeyIntermediateLegend" class="w-full md:w-1/3 space-y-1">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-2" id="intermediateLegendTitle">ä¸­ç¹¼é»åœ–ä¾‹ (B)</h4>
                                </div>
                                <div id="sankeyTargetLegend" class="w-full md:w-1/3 space-y-1 md:text-right">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-2" id="targetLegendTitle">çµ‚é»åœ–ä¾‹ (C)</h4>
                                </div>
                            </div>

                            <div id="sankeyChart" class="w-full overflow-x-auto">
                                <!-- D3 ç¹ªè£½ SVG å€å¡Š -->
                            </div>
                        </div>
                    </div>
                </details>

                <!-- 
                  =================================
                  æ–°å¢: çµæ§‹å·®ç•°åˆ†æ
                  =================================
                -->
                <details id="comparisonSection">
                    <summary>çµæ§‹å·®ç•°åˆ†æ (TA vs éTA)</summary>
                    <div>
                        <!-- æ§åˆ¶é … (æ–°ç‰ˆ) -->
                        <div class="p-4 bg-white rounded-lg shadow-md mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4 border-b pb-4">
                                <div class="md:col-span-1">
                                    <label for="compDefineSelect" class="block text-sm font-medium text-gray-700">æ¯”è¼ƒæ¬„ä½</label>
                                    <select id="compDefineSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                                </div>
                                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                                    <label for="compName1" class="block text-xs font-bold text-gray-500 mb-1">ç¾¤çµ„ 1 åç¨±</label>
                                    <input type="text" id="compName1" value="ç¾¤çµ„1" class="w-full p-1.5 border rounded text-sm mb-2">
                                    <label for="compValue1" class="block text-xs font-bold text-gray-500 mb-1">ç¾¤çµ„ 1 ç¯©é¸å€¼</label>
                                    <select id="compValue1" class="w-full p-1.5 border rounded text-sm bg-white"></select>
                                </div>
                                <div class="bg-green-50 p-3 rounded-lg border border-green-100">
                                    <label for="compName2" class="block text-xs font-bold text-gray-500 mb-1">ç¾¤çµ„ 2 åç¨±</label>
                                    <input type="text" id="compName2" value="ç¾¤çµ„2" class="w-full p-1.5 border rounded text-sm mb-2">
                                    <label for="compValue2" class="block text-xs font-bold text-gray-500 mb-1">ç¾¤çµ„ 2 ç¯©é¸å€¼</label>
                                    <select id="compValue2" class="w-full p-1.5 border rounded text-sm bg-white"></select>
                                </div>
                            </div>
                            <!-- æ’ç‰ˆåˆ‡æ› -->
                            <div class="flex items-center justify-end gap-4 mb-2">
                                <span class="text-sm font-medium text-gray-600">åœ–è¡¨æ’ç‰ˆ:</span>
                                <div class="flex bg-slate-100 p-1 rounded-lg">
                                    <button onclick="setComparisonGridColumns(1)" class="comparison-grid-btn px-3 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:bg-white hover:shadow-sm transition-all" data-cols="1">1æ¬„</button>
                                    <button onclick="setComparisonGridColumns(2)" class="comparison-grid-btn px-3 py-1.5 rounded-md text-xs font-medium bg-white shadow-sm text-indigo-600 transition-all" data-cols="2">2æ¬„</button>
                                    <button onclick="setComparisonGridColumns(3)" class="comparison-grid-btn px-3 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:bg-white hover:shadow-sm transition-all" data-cols="3">3æ¬„</button>
                                </div>
                            </div>
                            <!-- åŠŸèƒ½æŒ‰éˆ• -->
                            <div class="flex justify-end gap-2 mb-2">
                                <button id="comp-export-csv" class="text-xs bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700"><i class="fas fa-file-csv mr-1"></i> åŒ¯å‡º CSV</button>
                                <button id="comp-download-screenshot" class="text-xs bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700"><i class="fas fa-camera mr-1"></i> ä¸‹è¼‰æˆªåœ–</button>
                            </div>
                            <div id="comp-screenshot-status" class="text-sm text-green-700 hidden mb-2 text-right"></div>

                            <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡è¦æ¯”è¼ƒçš„åˆ†æé¡Œç›® (å¯è¤‡é¸)</label>
                            
                            <div class="flex flex-wrap gap-2 mb-2">
                                <button id="comp-select-all" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">å…¨é¸</button>
                                <button id="comp-deselect-all" class="text-xs bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600">å…¨éƒ¨æ¸…é™¤</button>
                                <span id="comp-selected-count" class="bg-indigo-100 text-indigo-700 text-xs px-2 py-0.5 rounded-full ml-auto self-center">å·²é¸ 0 é …</span>
                            </div>
                            
                            <div id="comparisonControls" class="multi-select-box custom-scrollbar max-h-48">
                                <!-- JS æœƒå‹•æ…‹å¡«å…¥æ­¤è™• -->
                            </div>
                        </div>
                        
                        <!-- åœ–è¡¨å®¹å™¨ -->
                        <div id="comparisonChartContainer" class="grid grid-cols-1 xl:grid-cols-2 gap-6 transition-all duration-300">
                            <!-- Loading or initial message -->
                            <div id="comparison-loading-message" class="col-span-full flex flex-col items-center justify-center p-20 bg-white rounded-2xl shadow-sm border border-slate-100">
                                <svg class="w-10 h-10 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                                <div class="mt-4 text-lg font-medium text-slate-600">è«‹å…ˆé¸æ“‡æ¯”è¼ƒæ¬„ä½ã€æ­£å€¼ï¼Œä¸¦å‹¾é¸åˆ†æé¡Œç›®</div>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- 
                  =================================
                  æ–°å¢: ç›¸ä¼¼åº¦å°ç…§åˆ†æ
                  =================================
                -->
                <details id="similaritySection">
                    <summary>ç›¸ä¼¼åº¦å°ç…§åˆ†æ</summary>
                    <div>
                        <!-- æ§åˆ¶é … -->
                        <div class="p-4 bg-white rounded-lg shadow-md mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Group 1 (X-axis) Settings -->
                                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                    <h3 class="font-bold text-blue-800 mb-3 border-b border-blue-200 pb-1">X è»¸å®šç¾© (åŸºæº–ç¾¤çµ„)</h3>
                                    <div class="mb-3">
                                        <label for="simColX" class="block text-xs font-bold text-gray-500 mb-1">1. ç¯©é¸æ¬„ä½ (Column)</label>
                                        <select id="simColX" class="w-full p-2 border rounded text-sm bg-white"></select>
                                    </div>
                                    <div>
                                        <label for="simValX" class="block text-xs font-bold text-gray-500 mb-1">2. ç¯©é¸å€¼ (Value)</label>
                                        <select id="simValX" class="w-full p-2 border rounded text-sm bg-white"></select>
                                    </div>
                                    <div class="mt-2 text-xs text-blue-600 font-bold" id="simCountDisplayX"></div>
                                </div>

                                <!-- Group 2 (Y-axis) Settings -->
                                <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                                    <h3 class="font-bold text-green-800 mb-3 border-b border-green-200 pb-1">Y è»¸å®šç¾© (æ¯”è¼ƒç¾¤çµ„)</h3>
                                    <div class="mb-3">
                                        <label for="simColY" class="block text-xs font-bold text-gray-500 mb-1">1. ç¯©é¸æ¬„ä½ (Column)</label>
                                        <select id="simColY" class="w-full p-2 border rounded text-sm bg-white"></select>
                                    </div>
                                    <div>
                                        <label for="simValY" class="block text-xs font-bold text-gray-500 mb-1">2. ç¯©é¸å€¼ (Value)</label>
                                        <select id="simValY" class="w-full p-2 border rounded text-sm bg-white"></select>
                                    </div>
                                    <div class="mt-2 text-xs text-green-600 font-bold" id="simCountDisplayY"></div>
                                </div>
                            </div>
                            <button id="btnCalcSimilarity" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition shadow-lg">
                                ç”¢ç”Ÿåˆ†æåœ–è¡¨
                            </button>
                        </div>

                        <!-- åœ–è¡¨èˆ‡çµ±è¨ˆ -->
                        <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">åˆ†æåœ–è¡¨ (Scatter Plot)</h3>
                            <div id="similarityChartContainer" class="w-full h-[500px] text-gray-400 flex items-center justify-center">è«‹è¨­å®šç¾¤çµ„ä¸¦é»æ“ŠæŒ‰éˆ•ä»¥ç”¢ç”Ÿåœ–è¡¨</div>
                            <div id="similarityStats" class="mt-4 sim-stats-card hidden"></div>
                        </div>

                        <!-- è©³ç´°å·®ç•°è¡¨æ ¼ -->
                        <div id="similarityTableCard" class="bg-white p-4 md:p-6 rounded-lg shadow-lg hidden">
                            <div class="flex justify-between items-center mb-4 pb-2 border-b flex-wrap gap-2">
                                <h3 class="text-lg font-bold text-gray-800">è©³ç´°å·®ç•°æ¯”è¼ƒè¡¨</h3>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm text-gray-600 font-bold">æœ€å°å·®ç•°éæ¿¾ï¼š</label>
                                    <select id="simFilterDiff" class="border rounded p-1 text-sm bg-gray-50">
                                        <option value="0">é¡¯ç¤ºå…¨éƒ¨</option>
                                        <option value="5" selected>åªé¡¯ç¤º > 5% å·®ç•°</option>
                                        <option value="10">åªé¡¯ç¤º > 10% å·®ç•°</option>
                                    </select>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table id="similarityDiffTable" class="w-full sim-diff-table">
                                    <!-- è¡¨é ­å’Œå…§å®¹å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                                </table>
                            </div>
                            <div id="simNoDataMsg" class="hidden text-center py-8 text-gray-500">æ²’æœ‰ç¬¦åˆéæ¿¾æ¢ä»¶çš„è³‡æ–™ã€‚</div>
                        </div>
                    </div>
                </details>

                <!-- 
                  =================================
                  å€å¡Š 2: å–®ä¸€æ¬„ä½åˆ†æ (å„€è¡¨æ¿)
                  =================================
                -->
                <details id="smallMultiplesSection" class="mt-6">
                    <!-- ä¿®æ­£åç¨± -->
                    <summary>å–®æ¬„åˆ†æ</summary>
                    <div>
                        <!-- ** ä¿®æ­£ 2ï¼šæ–°å¢ç¨ç«‹çš„ã€Œå€¼ã€åˆ‡æ›å™¨ ** -->
                        <div class="p-4 bg-white rounded-lg shadow-md mb-6">
                            <div class="mb-4">
                                <label for="smallValueSelect" class="block text-sm font-medium text-gray-700">æ¨ç´åˆ†æã€Œå€¼ã€ (Value)</label>
                                <select id="smallValueSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="count" selected>ç­†æ•¸ (COUNTA)</option>
                                    <option value="percent">å„åˆ—ä½”æ¯” (%)</option>
                                </select>
                            </div>

                            <label class="block text-sm font-medium text-gray-700 mb-2">è«‹é¸æ“‡è¦åˆ†æçš„æ¬„ä½ (å¯è¤‡é¸)</label>
                            
                            <!-- ** æ–°å¢ Q2 & Q3ï¼šåŠŸèƒ½æŒ‰éˆ• ** -->
                            <div class="flex flex-wrap gap-2 mb-2">
                                <button id="sm-select-all" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">å…¨é¸</button>
                                <button id="sm-deselect-all" class="text-xs bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600">å…¨éƒ¨æ¸…é™¤</button>
                                <button id="sm-export-csv" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">
                                    <i class="fas fa-file-csv mr-1"></i> åŒ¯å‡ºå–®æ¬„CSV
                                </button>
                                <button id="sm-download-screenshot" class="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700 ml-auto">
                                    <i class="fas fa-camera mr-1"></i> ä¸‹è¼‰æˆªåœ–
                                </button>
                            </div>
                            <div id="sm-screenshot-status" class="text-sm text-green-700 hidden mb-2"></div>
                            
                            <div id="smallMultiplesControls" class="multi-select-box">
                                <!-- JS æœƒå‹•æ…‹å¡«å…¥æ­¤è™• -->
                            </div>
                        </div>
                        
                        <!-- æ”¾ç½®å¤šå€‹å°åœ–è¡¨ -->
                        <!-- ** ä¿®æ­£ 1ï¼šç§»é™¤é–“è· ** -->
                        <div id="smallMultiplesContainer" class="space-y-0">
                            <!-- JS æœƒå‹•æ…‹å¡«å…¥åœ–è¡¨ -->
                        </div>
                    </div>
                </details>
                
            </div>
            
            <!-- 
              =================================
              å´é‚Šæ¬„: ç¯©é¸å™¨ (å…±ç”¨)
              =================================
            -->
            <div class="lg:col-span-2">
                <div class="bg-white p-4 rounded-lg shadow-md sticky top-8">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">æ™ºæ…§ç¯©é¸ (å¯è¤‡é¸)</h3>
                    <div id="filtersContainer" class="space-y-4 max-h-[80vh] overflow-y-auto pr-2"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        Chart.register(ChartDataLabels);

        // ** ä¿®æ­£ 1.1: è¨­å®šé è¨­ Apps Script ç¶²å€ **
        const DEFAULT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzVl2FD6dB21BP1qewDkspeyLLMebQy1cMF-byarAQj1hqfkeCSMS9ZlvZE6r6bmIrfLg/exec';
        
        // --- è¨­å®šé è¨­å€¼ (å·²ä¿®æ”¹) ---
        let DATALABELS_FONT_SIZE = 13; // é è¨­æ”¹ç‚º 13px
        let SMALL_CHART_BAR_HEIGHT = 4; // å–®æ¬„åˆ†æBARé«˜åº¦ï¼ˆåƒç´ ï¼‰- æ”¹ç‚º4px
        // æ¨ç´åˆ†æä½¿ç”¨çš„æ¯”ä¾‹è¨­å®š
        let BAR_CATEGORY_PERCENTAGE = 0.5; 
        let BAR_PERCENTAGE = 0.5;

        // 1. é«˜å°æ¯”åº¦çš„ã€Œé¡åˆ¥ã€èª¿è‰²ç›¤ (ç”¨æ–¼æ–‡å­—é¡åˆ¥ï¼Œæˆ–å°‘é‡çš„æ•¸å€¼é¡åˆ¥)
        const CATEGORICAL_PALETTE = ['#1e40af','#dc2626','#16a34a','#ea580c','#9333ea','#0891b2','#ca8a04','#db2777','#65a30d','#7c3aed','#0d9488','#c026d3','#475569','#f59e0b','#059669','#be185d'];
        // 2. ã€Œå†·è‡³æš–ã€æ¼¸å±¤èª¿è‰²ç›¤ (ç”¨æ–¼ 4 å€‹ä»¥ä¸Šçš„æ•¸å€¼é¡åˆ¥)
        const GRADIENT_PALETTE = ['#2563eb','#3b82f6','#06b6d4','#10b981','#84cc16','#eab308','#f59e0b','#f97316','#ef4444','#dc2626']; // 10-step cold-to-warm
        
        // ** FIXED_ANSWER_COLORS: æ ¹æ“šã€Œåˆ†æé¡Œç›®åœ–ä¾‹æ•´ç†ã€æ–‡ä»¶å…¨é¢æ›´æ–° **
        const FIXED_ANSWER_COLORS = {
            // 1.1 å¯µç‰©é¡å‹
            "çŠ¬": "#9AD8F5", // (1)
            "è²“": "#F35555", // (10)
            "éƒ½æœ‰": "#023047", // (5)

            // å¿™ç¢Œå‹é£¼ä¸»
            "å¿™ç¢Œå‹": "#9AD8F5",
            "ç©ºé–’å‹": "#F35555",

            // é«˜æ¶ˆè²»æ—ç¾¤
            "é«˜æ¶ˆè²»": "#9AD8F5",
            "ä½æ¶ˆè²»": "#F35555",

            // TA
            "TA": "#9AD8F5",
            "éTA": "#F35555",
            
            // 1.2 é£¼é¤Šæ•¸é‡
            "1 éš»": "#9AD8F5",
            "2 éš»": "#023047", // (5)
            "2+ éš»": "#F35555", // (10)
            
            // 1.3 å¹´é½¡
            "0-1æ­²": "#9AD8F5", // (1)
            "1-3æ­²": "#22BDB5", // (3)
            "3-6æ­²": "#023047", // (5)
            "6-9æ­²": "#FFB703", // (8)
            "10æ­²ä»¥ä¸Š": "#F35555", // (10)
            
            // 1.4 é«”æ…‹è‚¥èƒ–ã€è‚ŒåŠ›ä¸è¶³ã€å¿ƒæƒ…ç„¦æ…®ã€å¿ƒè‚ºå•é¡Œã€ä»¥ä¸Šçš†ç„¡ (Y/N)
            "Y": "#9AD8F5", // (1)
            "N": "#F35555", // (10)
            
            // 2.x, 3.x, 4.1, 4.2, 5.2 (Likert Scale)
            "1": "#9AD8F5", // éå¸¸ä¸åŒæ„ (1)
            "2": "#22BDB5", // ä¸åŒæ„ (3)
            "3": "#023047", // æ™®é€š (5)
            "4": "#FFB703", // åŒæ„ (8)
            "5": "#F35555", // éå¸¸åŒæ„ (10)
            
            // 3.x (Likert Scale - æ“ä½œ)
            "éå¸¸ä¸æ“ä½œ": "#9AD8F5", // (1)
            "ä¸æ“ä½œ": "#22BDB5", // (3)
            "æ™®é€š": "#023047", // (5)
            "æ“ä½œ": "#FFB703", // (8)
            "éå¸¸æ“ä½œ": "#F35555", // (10)

            // 4.3 ç„¡æ³•é™ªä¼´é »ç‡
            "0æ—¥": "#9AD8F5", // (1)
            "1æ—¥": "#5ECBD5", // (2)
            "2æ—¥": "#22BDB5", // (3)
            "3æ—¥": "#023047", // (5)
            "4æ—¥": "#425236", // (6)
            "5æ—¥": "#FFB703", // (8)
            "6æ—¥": "#F9862C", // (9)
            "7æ—¥": "#F35555", // (10)

            // 4.4, 4.5 å¹³å‡/ç„¡é™é™ªä¼´æ™‚é–“
            "0 å°æ™‚": "#9AD8F5", // (1)
            "1 å°æ™‚": "#22BDB5", // (3)
            "2 å°æ™‚": "#023047", // (5)
            "3 å°æ™‚": "#FFB703", // (8)
            "4 å°æ™‚": "#F9862C", // (9)
            "5 å°æ™‚": "#F35555", // (10)

            // 5.1, 5.3, 5.4, 5.6, 6.3 (é‡‘é¡å€é–“)
            "$0": "#BED1DB", // (0)
            "$1,000 ~ $3,000": "#9AD8F5", // (1)
            "$4,000 ~ $6,000": "#5ECBD5", // (2)
            "$7,000 ~ $9,000": "#22BDB5", // (3)
            "$10,000 ~ $12,000": "#12777E", // (4)
            "$13,000 ~ $15,000": "#023047", // (5)
            "$16,000 ~ $18,000": "#425236", // (6)
            "$19,000 ~ $21,000": "#817425", // (7)
            "$22,000 ~ $24,000": "#FFB703", // (8)
            "$25,000 ~ $27,000": "#F9862C", // (9)
            "$28,000+": "#F35555", // (10)

            // 5.5, 6.2, 7.3, 7.4, 7.7 (æ˜¯/å¦)
            "æ˜¯": "#9AD8F5", // (1)
            "å¦": "#F35555", // (10)

            // 5.7 å¹´åº¦ç¸½æŠ•å…¥å¢æ¸›
            "-$15,000 ~ -$13,000": "#BED1DB", // (0)
            "-$12,000 ~ -$10,000": "#9AD8F5", // (1)
            "-$9,000 ~ -$7,000": "#5ECBD5", // (2)
            "-$6,000 ~ -$4,000": "#22BDB5", // (3)
            "-$3,000 ~ -$1,000": "#12777E", // (4)
            "$0 (ä¸è®Š)": "#023047", // (5)
            "+$1,000 ~ +$3,000": "#425236", // (6)
            "+$4,000 ~ +$6,000": "#817425", // (7)
            "+$7,000 ~ +$9,000": "#FFB703", // (8)
            "+$10,000 ~ +$12,000": "#F9862C", // (9)
            "+$13,000 ~ +$15,000": "#F35555", // (10)

            // 6.1 ä¸å¥½ç¶“é©—
            "å¾æœªè³¼è²·é": "#9AD8F5", // (1)
            "å¹¾ä¹æ²’æœ‰": "#22BDB5", // (3)
            "å¶çˆ¾æœ‰": "#FFB703", // (8)
            "ç¶“å¸¸æœ‰": "#F35555", // (10)

            // 6.4 åå¥½è€ƒé‡
            "å¯µç‰©èƒ½é•·ä¹…ä½¿ç”¨": "#9AD8F5", // (1)
            "å¯µç‰©èƒ½å®‰å…¨ä½¿ç”¨": "#22BDB5", // (3)
            "ç°¡å–®å¥½ç”¨": "#023047", // (5)
            "ç”¢å“æŒä¹…è€ç”¨": "#FFB703", // (8)
            "ç”¢å“å®¹æ˜“æ¸…æ½”": "#F9862C", // (9)
            "ç°¡å–®å¥½æ¸…ç†": "#F35555", // (10)
            
            // 7.1 æ€§åˆ¥
            "ç”·æ€§": "#9AD8F5", // (1)
            "å¥³æ€§": "#F35555", // (10)
            "å…¶ä»–": "#023047", // (5)
            
            // 7.2 å¹´é½¡
            "24æ­²ä»¥ä¸‹": "#9AD8F5", // (1)
            "25-34æ­²": "#22BDB5", // (3)
            "35-44æ­²": "#023047", // (5)
            "45-54æ­²": "#FFB703", // (8)
            "55æ­²ä»¥ä¸Š": "#F35555", // (10)
            
            // 7.5 å±…ä½å‹æ…‹
            "å–®é–“(3-10åª)": "#9AD8F5", // (1)
            "å¤šé–“(å«å®¢å»³)": "#22BDB5", // (3)
            "é€å¤©(ç¨æ£Ÿ)": "#FFB703", // (8)
            "åˆ¥å¢…(æœ‰åº­é™¢)": "#F35555", // (10)

            // 7.6 æœ‰ç„¡å­å¥³
            "æœ‰": "#9AD8F5", // (1)
            "ç„¡": "#F35555", // (10)
            
            // 7.8 å¯æ”¯é…æ¶ˆè²»é¡
            "1è¬": "#9AD8F5", // (1)
            "2è¬": "#5ECBD5", // (2)
            "3è¬": "#22BDB5", // (3)
            "4è¬": "#12777E", // (4)
            "5è¬": "#023047", // (5)
            "6è¬": "#425236", // (6)
            "7è¬": "#817425", // (7)
            "8è¬": "#FFB703", // (8)
            "9è¬": "#F9862C", // (9)
            "10è¬": "#F35555", // (10)
        };
        
        const QUESTION_MAP = {
            '1.1_å¯µç‰©é¡å‹': 'æ‚¨çš„å¯µç‰©é¡å‹æ˜¯?',
            '1.2_é£¼é¤Šæ•¸é‡': 'æ‚¨ç¸½å…±é¤Šäº†å¹¾éš»ç‹—/è²“?',
            '1.3_Age_Oldest': 'æ‚¨çš„å¯µç‰©ä¸­ï¼Œæœ€å¹´é•·çš„å¹´ç´€ç‚ºï¼Ÿ',
            '1.3_Age_Youngest': 'æ‚¨çš„å¯µç‰©ä¸­ï¼Œæœ€å¹´å¹¼çš„å¹´ç´€ç‚ºï¼Ÿ',
            '1.4_å¥åº·éš±æ†‚': 'æ‚¨çš„å¯µç‰©æ˜¯å¦æœ‰ä»¥ä¸‹å¥åº·éš±æ†‚?',
            '2.1_è¦–ç‚ºå®¶äºº': 'æˆ‘è¦–æˆ‘çš„å¯µç‰©ç‚ºå®¶äººï¼Œè€Œä¸åƒ…åƒ…æ˜¯å‹•ç‰©ã€‚',
            '2.2_åƒå­©å­': 'æˆ‘å¸¸è¦ºå¾—æˆ‘çš„å¯µç‰©åƒæˆ‘çš„å­©å­ã€‚',
            '2.3_å¡«è£œç©ºç¼º': 'å¯µç‰©å¡«è£œäº†æˆ‘ç”Ÿæ´»ä¸­çš„ç©ºç¼ºã€‚',
            '2.4_æ„Ÿåˆ°ä¸å®‰': 'ç•¶æˆ‘ä¸åœ¨å¯µç‰©èº«é‚Šæ™‚ï¼Œæˆ‘æœƒæ„Ÿåˆ°ä¸å®‰ã€‚',
            '3.1_æ“”å¿ƒé¤“è‚šå­': 'æ‚¨æ˜¯å¦æ™‚å¸¸æ“”å¿ƒå¯µç‰©é¤“è‚šå­?',
            '3.2_æ“”å¿ƒé«’äº‚': 'æ‚¨æ˜¯å¦æ™‚å¸¸æ“”å¿ƒå¯µç‰©é€ æˆç’°å¢ƒé«’äº‚(å¤§å°ä¾¿ã€ç ´å£å‚¢ä¿±)?',
            '3.3_æ“”å¿ƒå­¤å–®': 'æ‚¨æ˜¯å¦æ™‚å¸¸æ“”å¿ƒå¯µç‰©ç¨è™•æ™‚æ„Ÿåˆ°å­¤å–®?',
            '3.4_æ“”å¿ƒæ²’æ´»å‹•': 'æ‚¨æ˜¯å¦æ™‚å¸¸æ“”å¿ƒå¯µç‰©ç¼ºä¹è¶³å¤ çš„æ´»å‹•é‡?',
            '4.1_é¡˜æ„èŠ±æ™‚é–“': 'æ‚¨åœ¨å®¶æ™‚ï¼Œæ˜¯å¦é¡˜æ„èŠ±æ›´å¤šæ™‚é–“é™ªä¼´å¯µç‰©?',
            '4.2_æ›¾ç„¡æ³•é™ªä¼´': 'æ‚¨æ˜¯å¦æ›¾ç¶“å› å¿™ç¢Œè€Œç„¡æ³•é™ªä¼´å¯µç‰©?',
            '4.3_ç„¡æ³•é™ªä¼´é »ç‡': 'æ‚¨éå»ä¸€é€±å¹³å‡æœ‰å¹¾å¤©ç„¡æ³•é™ªä¼´å¯µç‰©?',
            '4.4_å¹³å‡é™ªä¼´æ™‚é–“': 'æ‚¨å¹³å‡æ¯æ—¥èŠ±å¤šå°‘æ™‚é–“é™ªä¼´å¯µç‰©ç©æ¨‚ã€æ•£æ­¥?',
            '4.5_ç„¡é™é™ªä¼´æ™‚é–“': 'è‹¥æ™‚é–“å…è¨±ï¼Œæ‚¨å¸Œæœ›æ¯å¤©èŠ±å¤šå°‘æ™‚é–“é™ªä¼´å¯µç‰©ç©æ¨‚ã€æ•£æ­¥?',
            '5.1_é£Ÿå“ä¿å¥èŠ±è²»': 'æ‚¨å¹³å‡æ¯æœˆèŠ±è²»åœ¨ã€Œå¯µç‰©é£Ÿå“èˆ‡ä¿å¥å“ã€çš„é‡‘é¡ç´„?',
            '5.2_æŒ‘é¸å¥åº·å“': 'æ‚¨æ˜¯å¦æœƒç‰¹åˆ¥æŒ‘é¸å°å¯µç‰©å¥åº·æœ‰ç›Šçš„ç”¢å“?',
            '5.3_ç©å…·å¨›æ¨‚èŠ±è²»': 'æ‚¨å¹³å‡æ¯æœˆèŠ±è²»åœ¨ã€Œå¯µç‰©ç©å…·ã€å¨›æ¨‚ç”¨å“ã€ç­‰éé£Ÿå“é¡ç”¢å“çš„é‡‘é¡ç´„?',
            '5.4_æœ€é«˜ç”¢å“é‡‘é¡': 'æ‚¨æ›¾è³¼è²·éçš„å–®ä¸€ã€Œå¯µç‰©ç§‘æŠ€ç”¢å“ã€æœ€é«˜é‡‘é¡ç´„ç‚º?',
            '5.5_è³¼è²·æ´»å‹•ç”¢å“': 'æ‚¨æ˜¯å¦è³¼è²·éèƒ½å¢åŠ å¯µç‰©æ´»å‹•é‡çš„ç”¢å“(ç©å…·ã€è·‘æ»¾è¼ªã€å®¶å…·)?',
            '5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡': 'æ‰¿ä¸Šé¡Œï¼Œè©²ç”¨å“çš„æœ€é«˜é‡‘é¡ç´„ç‚º?',
            '5.7_å¹´åº¦ç¸½æŠ•å…¥': 'æ‚¨æ¯å¹´é è¨ˆåœ¨å¯µç‰©èº«ä¸ŠæŠ•å…¥çš„ç¸½é‡‘é¡ç´„ç‚º?',
            '6.1_ä¸å¥½ç¶“é©—': 'åœ¨ç‚ºå¯µç‰©è³¼è²·æ˜‚è²´ç”¨å“æ™‚ï¼Œæ‚¨æ˜¯å¦æ›¾æœ‰éä¸å¥½çš„é«”é©—?',
            '6.2_é¡˜æ„æ·»è³¼': 'ç„¡é ˆé™ªä¼´å¯µç‰©æ™‚, æ˜¯å¦é¡˜æ„æ·»è³¼å¯å¢åŠ å¯µç‰©ã€å¢åŠ æ´»å‹•é‡çš„å®¶ç”¨ç”¢å“?',
            '6.3_é¡˜æ„è³¼è²·é‡‘é¡': 'æ‚¨é¡˜æ„è³¼è²·çš„é‡‘é¡ç¯„åœç‚º?',
            '6.4_åå¥½è€ƒé‡': 'å¦‚æœæ‚¨ç”¨12,000å…ƒé ç®—è³¼è²·ä¸€é …å¯µç‰©ç”¨å“æ™‚ï¼Œæ‚¨æœ€ä¸»è¦è€ƒé‡çš„åŠŸèƒ½æ˜¯?',
            '7.1_æ€§åˆ¥': 'æ‚¨çš„æ€§åˆ¥?',
            '7.2_å¹´é½¡': 'æ‚¨çš„å¹´é½¡ä»‹æ–¼?',
            '7.3_æœ‰ä¼´ä¾¶': 'æ‚¨æ˜¯å¦æœ‰ä¼´ä¾¶(ç”·å¥³æœ‹å‹ã€å¤«å¦»)?',
            '7.4_ç¨å±…': 'æ‚¨ç›®å‰æ˜¯å¦ç¨è‡ªå±…ä½?',
            '7.5_å±…ä½å‹æ…‹': 'æ‚¨çš„å±…ä½å‹æ…‹ç‚º?',
            '7.6_å­å¥³': 'æ‚¨æ˜¯å¦æœ‰å­å¥³?',
            '7.7_å¯µç‰©ç›¸é—œèƒŒæ™¯': 'æ‚¨æ˜¯å¦å…·æœ‰å¯µç‰©ç›¸é—œèƒŒæ™¯ (ä¾‹å¦‚ï¼šç¸é†«ã€ç¾å®¹ã€è¨­è¨ˆç­‰)?',
            '7.8_å¯æ”¯é…æ¶ˆè²»é¡': 'æ‚¨å€‹äººæ¯æœˆå¹³å‡å¯æ”¯é…æ¶ˆè²»é¡(æ‰£é™¤è²¸æ¬¾ã€ç”Ÿæ´»æ—¥å¸¸ç­‰)?'
        };
        
        // ** CUSTOM_SORT_ORDERS: æ ¹æ“šã€Œåˆ†æé¡Œç›®åœ–ä¾‹æ•´ç†ã€æ–‡ä»¶å…¨é¢æ›´æ–° **
        const CUSTOM_SORT_ORDERS = {
            '1.1_å¯µç‰©é¡å‹': ['çŠ¬', 'éƒ½æœ‰', 'è²“'],
            '1.1_å¿™ç¢Œå‹é£¼ä¸»': ["å¿™ç¢Œå‹", "ç©ºé–’å‹"],
            '1.1_é«˜æ¶ˆè²»æ—ç¾¤': ["é«˜æ¶ˆè²»", "ä½æ¶ˆè²»"],
            '1.1_TA': ["TA", "éTA"],
            '1.2_é£¼é¤Šæ•¸é‡': ['1 éš»', '2 éš»', '2+ éš»'],
            '1.3_Age_Oldest': ["0-1æ­²", "1-3æ­²", "3-6æ­²", "6-9æ­²", "10æ­²ä»¥ä¸Š"],
            '1.3_Age_Youngest': ["0-1æ­²", "1-3æ­²", "3-6æ­²", "6-9æ­²", "10æ­²ä»¥ä¸Š"],
            '1.4_é«”æ…‹è‚¥èƒ–': ["æ˜¯", "å¦"],
            '1.4_è‚ŒåŠ›ä¸è¶³': ["æ˜¯", "å¦"],
            '1.4_å¿ƒæƒ…ç„¦æ…®': ["æ˜¯", "å¦"],
            '1.4_å¿ƒè‚ºå•é¡Œ': ["æ˜¯", "å¦"],
            '1.4_ä»¥ä¸Šçš†ç„¡': ["æ˜¯", "å¦"],
            
            // Likert Scale (2.x, 3.x, 4.x)
            '2.1_è¦–ç‚ºå®¶äºº': ["1", "2", "3", "4", "5"],
            '2.2_åƒå­©å­': ["1", "2", "3", "4", "5"],
            '2.3_å¡«è£œç©ºç¼º': ["1", "2", "3", "4", "5"],
            '2.4_æ„Ÿåˆ°ä¸å®‰': ["1", "2", "3", "4", "5"],
            '3.1_æ“”å¿ƒé¤“è‚šå­': ["1", "2", "3", "4", "5"],
            '3.2_æ“”å¿ƒé«’äº‚': ["1", "2", "3", "4", "5"],
            '3.3_æ“”å¿ƒå­¤å–®': ["1", "2", "3", "4", "5"],
            '3.4_æ“”å¿ƒæ²’æ´»å‹•': ["1", "2", "3", "4", "5"],
            '4.1_é¡˜æ„èŠ±æ™‚é–“': ["1", "2", "3", "4", "5"],
            '4.2_æ›¾ç„¡æ³•é™ªä¼´': ["1", "2", "3", "4", "5"],
            
            // 4.3 ç„¡æ³•é™ªä¼´é »ç‡
            '4.3_ç„¡æ³•é™ªä¼´é »ç‡': ["0æ—¥", "1æ—¥", "2æ—¥", "3æ—¥", "4æ—¥", "5æ—¥", "6æ—¥", "7æ—¥"],

            // 4.4 å¹³å‡é™ªä¼´æ™‚é–“
            '4.4_å¹³å‡é™ªä¼´æ™‚é–“': ["0 å°æ™‚", "1 å°æ™‚", "2 å°æ™‚", "3 å°æ™‚", "4 å°æ™‚", "5 å°æ™‚"],

            // 4.5 ç„¡é™é™ªä¼´æ™‚é–“
            '4.5_ç„¡é™é™ªä¼´æ™‚é–“': ["0 å°æ™‚", "1 å°æ™‚", "2 å°æ™‚", "3 å°æ™‚", "4 å°æ™‚", "5 å°æ™‚"],
            
            // 5.1, 5.3, 5.4, 5.6, 6.3 (é‡‘é¡å€é–“)
            '5.1_é£Ÿå“ä¿å¥èŠ±è²»': ["$0", "$1,000 ~ $3,000", "$4,000 ~ $6,000", "$7,000 ~ $9,000", "$10,000 ~ $12,000", "$13,000 ~ $15,000", "$16,000 ~ $18,000", "$19,000 ~ $21,000", "$22,000 ~ $24,000", "$25,000 ~ $27,000", "$28,000+"],
            '5.3_ç©å…·å¨›æ¨‚èŠ±è²»': ["$0", "$1,000 ~ $3,000", "$4,000 ~ $6,000", "$7,000 ~ $9,000", "$10,000 ~ $12,000", "$13,000 ~ $15,000", "$16,000 ~ $18,000", "$19,000 ~ $21,000", "$22,000 ~ $24,000", "$25,000 ~ $27,000", "$28,000+"],
            '5.4_æœ€é«˜ç”¢å“é‡‘é¡': ["$0", "$1,000 ~ $3,000", "$4,000 ~ $6,000", "$7,000 ~ $9,000", "$10,000 ~ $12,000", "$13,000 ~ $15,000", "$16,000 ~ $18,000", "$19,000 ~ $21,000", "$22,000 ~ $24,000", "$25,000 ~ $27,000", "$28,000+"],
            '5.6_æ´»å‹•ç”¢å“æœ€é«˜é‡‘é¡': ["$0", "$1,000 ~ $3,000", "$4,000 ~ $6,000", "$7,000 ~ $9,000", "$10,000 ~ $12,000", "$13,000 ~ $15,000", "$16,000 ~ $18,000", "$19,000 ~ $21,000", "$22,000 ~ $24,000", "$25,000 ~ $27,000", "$28,000+"],
            '6.3_é¡˜æ„è³¼è²·é‡‘é¡': ["$0", "$1,000 ~ $3,000", "$4,000 ~ $6,000", "$7,000 ~ $9,000", "$10,000 ~ $12,000", "$13,000 ~ $15,000", "$16,000 ~ $18,000", "$19,000 ~ $21,000", "$22,000 ~ $24,000", "$25,000 ~ $27,000", "$28,000+"],

            // 5.5 è³¼è²·æ´»å‹•ç”¢å“
            '5.5_è³¼è²·æ´»å‹•ç”¢å“': ["æ˜¯", "å¦"],
            
            // 5.7 å¹´åº¦ç¸½æŠ•å…¥å¢æ¸›
            '5.7_å¹´åº¦ç¸½æŠ•å…¥': ["-$15,000 ~ -$13,000", "-$12,000 ~ -$10,000", "-$9,000 ~ -$7,000", "-$6,000 ~ -$4,000", "-$3,000 ~ -$1,000", "$0 (ä¸è®Š)", "+$1,000 ~ +$3,000", "+$4,000 ~ +$6,000", "+$7,000 ~ +$9,000", "+$10,000 ~ +$12,000", "+$13,000 ~ +$15,000"],
            
            // 6.1 ä¸å¥½ç¶“é©—
            '6.1_ä¸å¥½ç¶“é©—': ["å¾æœªè³¼è²·é", "å¹¾ä¹æ²’æœ‰", "å¶çˆ¾æœ‰", "ç¶“å¸¸æœ‰"],
            
            // 6.2 é¡˜æ„æ·»è³¼
            '6.2_é¡˜æ„æ·»è³¼': ["æ˜¯", "å¦"],
            
            // 6.4 åå¥½è€ƒé‡
            '6.4_åå¥½è€ƒé‡': ["å¯µç‰©èƒ½é•·ä¹…ä½¿ç”¨", "å¯µç‰©èƒ½å®‰å…¨ä½¿ç”¨", "ç°¡å–®å¥½ç”¨", "ç”¢å“æŒä¹…è€ç”¨", "ç”¢å“å®¹æ˜“æ¸…æ½”", "ç°¡å–®å¥½æ¸…ç†"],
            
            // 7.x å€‹äººåŸºæœ¬è³‡è¨Š
            '7.1_æ€§åˆ¥': ["ç”·æ€§", "å¥³æ€§", "å…¶ä»–"],
            '7.2_å¹´é½¡': ["24æ­²ä»¥ä¸‹", "25-34æ­²", "35-44æ­²", "45-54æ­²", "55æ­²ä»¥ä¸Š"],
            '7.3_æœ‰ä¼´ä¾¶': ['æ˜¯', 'å¦'],
            '7.4_ç¨å±…': ['æ˜¯', 'å¦'],
            '7.5_å±…ä½å‹æ…‹': ["å–®é–“(3-10åª)", "å¤šé–“(å«å®¢å»³)", "é€å¤©(ç¨æ£Ÿ)", "åˆ¥å¢…(æœ‰åº­é™¢)"],
            '7.6_å­å¥³': ['æœ‰', 'ç„¡'],
            '7.7_å¯µç‰©ç›¸é—œèƒŒæ™¯': ['æ˜¯', 'å¦'],
            '7.8_å¯æ”¯é…æ¶ˆè²»é¡': ["1è¬", "2è¬", "3è¬", "4è¬", "5è¬", "6è¬", "7è¬", "8è¬", "9è¬", "10è¬"],
        };
        
        // --- ä½”æ¯”æ¨¡å¼ 25/50/75% è™›ç·šå¤–æ› ---
        const percentageGridLinesPlugin = {
            id: 'percentageGridLines',
            afterDraw: (chart) => {
                // ** ä¿®æ­£ï¼šæª¢æŸ¥åœ–è¡¨ IDï¼Œåªåœ¨ä¸»åœ–è¡¨ä¸Šé‹ä½œ **
                if (chart.canvas.id !== 'mainChart') return;
                
                const valueType = document.getElementById('valueSelect')?.value;
                if (valueType !== 'percent') {
                    return; // åªåœ¨ä½”æ¯”æ¨¡å¼ä¸‹ç¹ªè£½
                }
                const ctx = chart.ctx;
                const xAxis = chart.scales.x;
                const yAxis = chart.scales.y;
                const lines = [25, 50, 75]; // 25%, 50%, 75%

                ctx.save();
                ctx.strokeStyle = '#e0e0e0'; // æ·¡æ·¡çš„ç°è‰²
                ctx.lineWidth = 1;
                ctx.setLineDash([3, 3]); // è™›ç·š

                lines.forEach(value => {
                    const xPos = xAxis.getPixelForValue(value);
                    ctx.beginPath();
                    ctx.moveTo(xPos, yAxis.top);
                    ctx.lineTo(xPos, yAxis.bottom);
                    ctx.stroke();
                });

                ctx.restore();
            }
        };
        Chart.register(percentageGridLinesPlugin); // è¨»å†Šå¤–æ›

        
        // ä»¥è‡ªè¨‚é †åºæ’åºï¼›è‹¥æ‰¾ä¸åˆ°æ–¼é †åºè¡¨ï¼Œå‰‡å›é€€ç‚ºã€Œæ•¸å€¼ç”±å°åˆ°å¤§ã€ï¼›å†ä¸è¡Œå›åˆ°å­—ä¸²æ¯”è¼ƒ
        function compareWithOrder(a, b, orderArr) {
            const aRaw = String(a).trim();
            const bRaw = String(b).trim();
            const aNumStr = aRaw.replace(/[^0-9.+-]/g, '');
            const bNumStr = bRaw.replace(/[^0-9.+-]/g, '');
            const aIdx = orderArr.indexOf(aNumStr);
            const bIdx = orderArr.indexOf(bNumStr);
            if (aIdx !== -1 || bIdx !== -1) {
                const av = (aIdx === -1) ? Infinity : aIdx;
                const bv = (bIdx === -1) ? Infinity : bIdx;
                if (av !== bv) return av - bv;
            }
            const aNum = parseFloat(aNumStr);
            const bNum = parseFloat(bNumStr);
            if (!Number.isNaN(aNum) && !Number.isNaN(bNum)) {
                if (aNum !== bNum) return aNum - bNum;
            }
            return aRaw.localeCompare(bRaw);
        }
        function parseNumericValue(val) {
            const valStr = String(val).trim(); // ** ä¿®æ­£ï¼šTrim ç©ºç™½ **
            // ç§»é™¤ NT$ æˆ–å…¶ä»–è²¨å¹£ç¬¦è™Ÿ
            const cleanedStr = valStr.replace(/[$NT$]/g, '').trim(); 
            
            const hasPlusSuffix = cleanedStr.endsWith('+') || cleanedStr.includes('ä»¥ä¸Š');
            // åŒ¹é…åŒ…å«æ­£è² è™Ÿã€ç©ºæ ¼æˆ–é€—è™Ÿçš„æ•¸å­—
            const numMatch = cleanedStr.match(/([+-]?[\s]*[\d,]+(\.\d+)?)/); 
            
            if (numMatch) {
                const numStr = numMatch[1].replace(/[,]/g, '').replace(/\s/g, '');
                const num = parseFloat(numStr);
                if (!isNaN(num)) {
                    // å°æ–¼æœ‰ + è™Ÿçµå°¾æˆ–ã€Œä»¥ä¸Šã€çš„ï¼Œæ¨™è¨˜ç‚ºæœ‰å¾Œç¶´
                    if (hasPlusSuffix && num >= 0) {
                        return { num: num, hasPlus: true, original: valStr, isNumeric: true };
                    }
                    return { num: num, hasPlus: false, original: valStr, isNumeric: true };
                }
            }
            return { num: null, hasPlus: false, original: valStr, isNumeric: false };
        }
        function smartSort(a, b) {
            const valA = parseNumericValue(a);
            const valB = parseNumericValue(b);
            if (!valA.isNumeric && !valB.isNumeric) {
                return String(a).localeCompare(String(b));
            }
            if (!valA.isNumeric) return 1;
            if (!valB.isNumeric) return -1;
            if (valA.hasPlus && !valB.hasPlus) return 1;
            if (!valA.hasPlus && valB.hasPlus) return -1;
            if (valA.num !== valB.num) {
                return valA.num - valB.num;
            }
            return valA.original.localeCompare(valB.original);
        }

        // ** æ–°å¢ï¼šå…¨åŸŸæ’åºç´¢å¼•å‡½æ•¸ (å¼·åŒ–æ¯”å°) **
        function getSortIndex(val, customOrder) {
            if (!customOrder) return Infinity;
            
            const strVal = String(val).trim();
            
            // 1. å˜—è©¦ç›´æ¥æ¯”å° (å¿½ç•¥ç©ºç™½)
            const normalize = (str) => String(str).replace(/\s+/g, '');
            const valNormalized = normalize(strVal);
            let index = customOrder.findIndex(item => normalize(item) === valNormalized);
            if (index !== -1) return index;

            // 2. å˜—è©¦æ•¸å€¼æ¯”å° (é‡å°è³‡æ–™ç„¡å–®ä½ä½†æ’åºè¨­å®šæœ‰å–®ä½çš„æƒ…æ³)
            // ä¾‹å¦‚ val="2", customOrder=["0æ—¥", "1æ—¥", "2æ—¥"]
            const valNum = parseFloat(strVal);
            if (!isNaN(valNum)) {
                index = customOrder.findIndex(item => {
                    const itemNum = parseFloat(String(item));
                    return !isNaN(itemNum) && itemNum === valNum;
                });
                if (index !== -1) return index;
            }
            
            return Infinity;
        }

        // ** ä¿®æ­£ 1.1ï¼šæ–°å¢å–å¾—é¡Œç›®å‰ç¶´çš„å‡½æ•¸ **
        function getQuestionPrefix(key) {
            // Extracts '1.1' from '1.1_å¯µç‰©é¡å‹', or '6.5' from '6.5_å­å¥³'
            const match = key.match(/^(\d+\.\d+)/);
            return match ? match[1] : key; // Return the prefix or the whole key if no match
        }

        // ** æ–°å¢ Q1ï¼šDebounce å‡½æ•¸ **
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
        };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
        };
        }

        let chart; // ä¸»åœ–è¡¨ (æ¨ç´)
        let rawData = [];
        let allColumns = [];
        let controls = {};
        let isUpdatingFilters = false;
        let smallCharts = {}; // ** å„²å­˜å°åœ–è¡¨çš„ç‰©ä»¶ **
        
        // --- æ–°å¢ï¼šçµæ§‹å·®ç•°åˆ†æ ---
        let comparisonCharts = {};
        let activeComparisonFilters = new Set();
        
        // --- æ–°å¢ï¼šç›¸ä¼¼åº¦åˆ†æ ---
        let currentSimilarityData = [];
        let currentSimilarityMeta = {};


        // --- åˆå§‹åŒ– ---
        window.addEventListener('DOMContentLoaded', () => {
            // ä¿®æ­£ 1.2: ç§»é™¤è¼‰å…¥æŒ‰éˆ•ç›¸é—œçš„ DOM å…ƒç´ 
            document.getElementById('setupInstructions').classList.remove('max-w-4xl', 'mx-auto', 'mb-8', 'p-6', 'bg-blue-50', 'border-2', 'border-blue-200', 'rounded-lg');
            document.getElementById('setupInstructions').innerHTML = `<h2 class="text-xl font-bold text-blue-800 mb-4">ğŸ“‹ è¨­å®šç‹€æ…‹</h2><p class="text-gray-700">è³‡æ–™å°‡æ–¼é é¢é–‹å•Ÿæ™‚è‡ªå‹•è¼‰å…¥ã€‚å¦‚éœ€è®Šæ›´è³‡æ–™ä¾†æºï¼Œè«‹ä¿®æ”¹ç¨‹å¼ç¢¼å…§ <code>DEFAULT_SCRIPT_URL</code> è®Šæ•¸ã€‚</p>`;
            
            const settingsModal = document.getElementById('settingsModal');
            const settingsButton = document.getElementById('settingsButton');
            const closeSettingsModal = document.getElementById('closeSettingsModal');
            const datalabelsSize = document.getElementById('datalabelsSize');
            const datalabelsSizeValue = document.getElementById('datalabelsSizeValue');
            const barThickness = document.getElementById('barThickness');
            const barThicknessValue = document.getElementById('barThicknessValue');
            
            // æ¡‘åŸºåœ–æ§åˆ¶é …
            const sankeySourceSelect = document.getElementById('sankeySourceSelect');
            const sankeyTargetSelect = document.getElementById('sankeyTargetSelect');
            const sankeyIntermediateSelect = document.getElementById('sankeyIntermediateSelect'); // æ–°å¢ä¸­ç¹¼é»
            const sankeyMinThreshold = document.getElementById('sankeyMinThreshold');
            const sankeyMinThresholdValue = document.getElementById('sankeyMinThresholdValue');
            // æ–°å¢æ¡‘åŸºåœ–äº¤æ›æŒ‰éˆ•
            const swapSankeyAxesButton = document.getElementById('swapSankeyAxesButton');
            // å…¨è¢å¹•æŒ‰éˆ•
            const sankeyFullScreenBtn = document.getElementById('sankeyFullScreenBtn');
            const exitSankeyFullScreenBtn = document.getElementById('exitSankeyFullScreenBtn');

            settingsButton.addEventListener('click', () => settingsModal.style.display = 'block');
            closeSettingsModal.addEventListener('click', () => settingsModal.style.display = 'none');
            window.addEventListener('click', (event) => {
                if (event.target === settingsModal) {
                    settingsModal.style.display = 'none';
                }
            });

            // åˆå§‹åŒ–è¨­å®šå€¼é¡¯ç¤º (ä½¿ç”¨å…¨åŸŸè®Šæ•¸çš„é è¨­å€¼)
            datalabelsSize.value = DATALABELS_FONT_SIZE;
            datalabelsSizeValue.textContent = DATALABELS_FONT_SIZE;
            barThickness.value = SMALL_CHART_BAR_HEIGHT;
            barThicknessValue.textContent = SMALL_CHART_BAR_HEIGHT;
            sankeyMinThresholdValue.textContent = sankeyMinThreshold.value;

            // ç¶å®šè¨­å®šèª¿æ•´äº‹ä»¶
            datalabelsSize.addEventListener('input', () => {
                DATALABELS_FONT_SIZE = parseInt(datalabelsSize.value);
                datalabelsSizeValue.textContent = DATALABELS_FONT_SIZE;
                if (chart) updateChartSettings(true); 
                updateSmallMultiplesSettings(true);
                updateComparisonCharts(); // æ–°å¢ï¼šæ›´æ–°çµæ§‹å·®ç•°åˆ†æåœ–è¡¨
            });

            barThickness.addEventListener('input', () => {
                SMALL_CHART_BAR_HEIGHT = parseInt(barThickness.value);
                barThicknessValue.textContent = SMALL_CHART_BAR_HEIGHT;
                // ä¸å½±éŸ¿æ¨ç´åˆ†æï¼Œåªæ›´æ–°å–®æ¬„åˆ†æ
                updateSmallMultiplesSettings(true);
                updateComparisonCharts(); // æ–°å¢ï¼šæ›´æ–°çµæ§‹å·®ç•°åˆ†æåœ–è¡¨
            });
            
            // ç¶å®š Sankey æ§åˆ¶é …äº‹ä»¶
            sankeySourceSelect.addEventListener('change', updateSankeyChart);
            sankeyTargetSelect.addEventListener('change', updateSankeyChart);
            if (sankeyIntermediateSelect) {
                sankeyIntermediateSelect.addEventListener('change', updateSankeyChart);
            }
            sankeyMinThreshold.addEventListener('input', () => {
                sankeyMinThresholdValue.textContent = sankeyMinThreshold.value;
                debounce(updateSankeyChart, 300)();
            });
            
            // æ¡‘åŸºåœ–äº¤æ›æŒ‰éˆ•äº‹ä»¶
            if (swapSankeyAxesButton) {
                swapSankeyAxesButton.addEventListener('click', () => {
                    const sourceValue = sankeySourceSelect.value;
                    const targetValue = sankeyTargetSelect.value;
                    sankeySourceSelect.value = targetValue;
                    sankeyTargetSelect.value = sourceValue;
                    updateSankeyChart();
                });
            }

            // å…¨è¢å¹•æŒ‰éˆ•äº‹ä»¶
            if (sankeyFullScreenBtn) {
                sankeyFullScreenBtn.addEventListener('click', toggleSankeyFullScreen);
            }
            if (exitSankeyFullScreenBtn) {
                exitSankeyFullScreenBtn.addEventListener('click', toggleSankeyFullScreen);
            }

            // ** ä¿®æ­£ 1.4: é é¢è¼‰å…¥å¾Œè‡ªå‹•è¼‰å…¥æ•¸æ“š **
            initDashboard(DEFAULT_SCRIPT_URL);
        });

        document.addEventListener('click', (e) => {
            const openFilters = document.querySelectorAll('.filter-dropdown[open]');
            openFilters.forEach(filter => {
                if (!filter.contains(e.target)) {
                    filter.open = false;
                }
            });
        });

        async function loadData(scriptUrl) {
            const debugInfo = document.getElementById('debugInfo');
            const loadingMessage = document.getElementById('loadingMessage');
            try {
                loadingMessage.textContent = 'æ­£åœ¨å¾ Google Sheet æ“·å–è³‡æ–™...';
                
                const url = scriptUrl;
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`);
                }
                const jsonData = await response.json();
                if (jsonData.error) {
                    throw new Error(`Apps Script éŒ¯èª¤: ${jsonData.error}`);
                }
                if (!Array.isArray(jsonData) || jsonData.length === 0) {
                    throw new Error('æœªæ”¶åˆ°ä»»ä½•è³‡æ–™æˆ–è³‡æ–™æ ¼å¼ä¸ç¬¦ã€‚');
                }
                return jsonData;
            } catch (error) {
                // ä¿®æ­£ 2.2: å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤è³‡è¨Šï¼Œä¸¦å°‡ loading éš±è—
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('setupInstructions').classList.remove('hidden');
                const errorContainer = document.getElementById('debugInfo');
                if (errorContainer) {
                    errorContainer.innerHTML = `<p class="text-red-600 ml-4">âŒ <strong>è¼‰å…¥å¤±æ•—: ${error.message}</strong></p>`;
                    errorContainer.innerHTML += `<p class="text-red-700 ml-6 mt-2">è«‹æª¢æŸ¥ï¼š<br>1. ç¨‹å¼ç¢¼ä¸­ <code>DEFAULT_SCRIPT_URL</code> ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚<br>2. Apps Script éƒ¨ç½²æ¬Šé™æ˜¯å¦è¨­å®šç‚ºã€Œä»»ä½•äººã€ã€‚<br>3. Google Sheet çš„æ¬„ä½æ˜¯å¦æœ‰è³‡æ–™ã€‚</p>`;
                    document.getElementById('debugInfoContainer').classList.remove('hidden');
                }
                return [];
            }
        }

        async function initDashboard(scriptUrl) {
            rawData = await loadData(scriptUrl);
            if (rawData.length > 0) {
                allColumns = Object.keys(rawData[0]);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('setupInstructions').classList.remove('hidden'); // é¡¯ç¤ºè¨­å®šç‹€æ…‹
                // ä¿®æ­£ 2.4: æˆåŠŸè¼‰å…¥å¾Œï¼Œéš±è—éŒ¯èª¤è³‡è¨Š
                document.getElementById('debugInfoContainer').classList.add('hidden');
                setupControls();
                createChart(); // å»ºç«‹ä¸»åœ–è¡¨
                updateChart(); // æ›´æ–°ä¸»åœ–è¡¨
                updateSankeyChart(); // å»ºç«‹æ¡‘åŸºåœ–
                updateSmallMultiples(); // æ›´æ–°å°åœ–è¡¨
                updateComparisonCharts(); // æ›´æ–°çµæ§‹å·®ç•°åˆ†æåœ–è¡¨
                setupSimilarityControls(); // ** æ–°å¢ï¼šåˆå§‹åŒ–ç›¸ä¼¼åº¦åˆ†ææ§åˆ¶é … **
            }
        }

        function updateAnnotations() {
            // ** ç°¡åŒ–ï¼šåªæ›´æ–°ä¸»åœ–è¡¨çš„è¨»é‡‹ **
            const yKey = controls.yAxisSelect.value;
            const cKey = controls.colorBySelect.value;
            const yEl = document.getElementById('yAxisQuestion');
            const cEl = document.getElementById('colorByQuestion');
            
            yEl.textContent = QUESTION_MAP[yKey] || 'æœªæ‰¾åˆ°å•é¡Œæè¿°';
            if (cKey === 'none') {
                cEl.textContent = 'æœªåˆ†çµ„';
            } else {
                cEl.textContent = QUESTION_MAP[cKey] || 'æœªæ‰¾åˆ°å•é¡Œæè¿°';
            }
        }

        function setupControls() {
            controls.yAxisSelect = document.getElementById('yAxisSelect');
            controls.colorBySelect = document.getElementById('colorBySelect'); // ** ç°¡åŒ–ï¼šå›ºå®šç‚ºå–®é¸ **
            controls.valueSelect = document.getElementById('valueSelect');
            controls.smallValueSelect = document.getElementById('smallValueSelect'); // ** ä¿®æ­£ 2ï¼šåŠ å…¥æ–°çš„æ§åˆ¶å™¨ **
            controls.swapButton = document.getElementById('swapAxesButton');
            controls.arrowSelect = document.getElementById('arrowSelect');
            controls.subGroupSelect = document.getElementById('subGroupSelect'); // æ¬¡è¦åˆ†çµ„é¸å–®
            
            // Pivot Table Controls
            controls.pivotRowMainSelect = document.getElementById('pivotRowMainSelect');
            controls.pivotRowSubSelect = document.getElementById('pivotRowSubSelect');
            controls.pivotRowLevel3Select = document.getElementById('pivotRowLevel3Select');
            controls.pivotRowLevel4Select = document.getElementById('pivotRowLevel4Select');
            controls.addPivotColumnBtn = document.getElementById('addPivotColumn');
            controls.pivotColumns = []; // å­˜å„²å‹•æ…‹æ·»åŠ çš„æ¬„ä½é…ç½®
            
            // Sankey Controls
            controls.sankeySourceSelect = document.getElementById('sankeySourceSelect');
            controls.sankeyTargetSelect = document.getElementById('sankeyTargetSelect');
            controls.sankeyIntermediateSelect = document.getElementById('sankeyIntermediateSelect'); // æ–°å¢ä¸­ç¹¼é»

            // Comparison Chart Controls
            controls.compDefineSelect = document.getElementById('compDefineSelect');
            controls.compValue1 = document.getElementById('compValue1');
            controls.compName1 = document.getElementById('compName1');
            controls.compValue2 = document.getElementById('compValue2');
            controls.compName2 = document.getElementById('compName2');
            controls.comparisonControls = document.getElementById('comparisonControls');

            // ** æ–°å¢ï¼šç›¸ä¼¼åº¦åˆ†ææ§åˆ¶é … **
            controls.simColX = document.getElementById('simColX');
            controls.simValX = document.getElementById('simValX');
            controls.simColY = document.getElementById('simColY');
            controls.simValY = document.getElementById('simValY');
            controls.btnCalcSimilarity = document.getElementById('btnCalcSimilarity');
            // *** ä¿®æ­£ï¼šå°‡ comparisonControls çš„å®šç¾©æå‰ ***
            const comparisonControls = document.getElementById('comparisonControls');

            // ** ç°¡åŒ–ï¼šç§»é™¤ (ç¸½è¨ˆ) é¸é … **
            controls.yAxisSelect.innerHTML = '';
            controls.colorBySelect.innerHTML = '<option value="none">ä¸åˆ†çµ„ (å–®ä¸€é¡è‰²)</option>';
            controls.sankeySourceSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
            controls.sankeyTargetSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
            controls.sankeyIntermediateSelect.innerHTML = '<option value="">ç„¡ (ç›´æ¥æµå‘çµ‚é»)</option>'; // æ–°å¢ä¸­ç¹¼é»é è¨­
            controls.subGroupSelect.innerHTML = '<option value="">ç„¡</option>'; // æ¬¡è¦åˆ†çµ„é è¨­é¸é …
            controls.pivotRowMainSelect.innerHTML = '<option value="">ç„¡</option>';
            controls.pivotRowSubSelect.innerHTML = '<option value="">ç„¡</option>';
            controls.pivotRowLevel3Select.innerHTML = '<option value="">ç„¡</option>';
            controls.pivotRowLevel4Select.innerHTML = '<option value="">ç„¡</option>';
            controls.compDefineSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
            controls.compValue1.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡æ¬„ä½</option>';
            controls.compValue2.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡æ¬„ä½</option>';

            controls.simColX.innerHTML = '<option value="">è«‹é¸æ“‡æ¬„ä½...</option>';
            controls.simValX.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡å€¼...</option>';
            controls.simColY.innerHTML = '<option value="">è«‹é¸æ“‡æ¬„ä½...</option>';
            controls.simValY.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡å€¼...</option>';

            allColumns.forEach(key => {
                controls.yAxisSelect.innerHTML += `<option value="${key}">${key}</option>`;
                controls.colorBySelect.innerHTML += `<option value="${key}">${key}</option>`;
                controls.sankeySourceSelect.innerHTML += `<option value="${key}">${key}</option>`;
                controls.sankeyTargetSelect.innerHTML += `<option value="${key}">${key}</option>`;
                controls.sankeyIntermediateSelect.innerHTML += `<option value="${key}">${key}</option>`; // æ–°å¢ä¸­ç¹¼é»é¸é …
                controls.subGroupSelect.innerHTML += `<option value="${key}">${key}</option>`; // æ·»åŠ åˆ°æ¬¡è¦åˆ†çµ„é¸å–®
                controls.pivotRowMainSelect.innerHTML += `<option value="${key}">${key}</option>`;
                controls.pivotRowSubSelect.innerHTML += `<option value="${key}">${key}</option>`;
                controls.pivotRowLevel3Select.innerHTML += `<option value="${key}">${key}</option>`;
                controls.pivotRowLevel4Select.innerHTML += `<option value="${key}">${key}</option>`;
                controls.compDefineSelect.innerHTML += `<option value="${key}">${key}</option>`;
                controls.simColX.innerHTML += `<option value="${key}">${key}</option>`;
                controls.simColY.innerHTML += `<option value="${key}">${key}</option>`;
            });
            
            // ** æ–°å¢ï¼šè¨­å®šã€Œå–®ä¸€æ¬„ä½åˆ†æã€çš„è¤‡é¸æ¡† **
            const smallMultiplesControls = document.getElementById('smallMultiplesControls');
            let multiSelectHTML = '';
            allColumns.forEach(key => {
                multiSelectHTML += `
                    <label class="flex items-center">
                        <input type="checkbox" value="${key}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 small-multiple-checkbox">
                        <span class="ml-2 text-sm text-gray-900">${key}</span>
                    </label>
                `;
            });
            smallMultiplesControls.innerHTML = multiSelectHTML;
            
            // ** æ–°å¢ï¼šè¨­å®šã€Œçµæ§‹å·®ç•°åˆ†æã€çš„è¤‡é¸æ¡† **
            let comparisonSelectHTML = '';
            allColumns.forEach(key => {
                comparisonSelectHTML += `
                    <label class="flex items-center"><input type="checkbox" value="${key}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 comparison-checkbox"><span class="ml-2 text-sm text-gray-900">${key}</span></label>
                `;
            });
            comparisonControls.innerHTML = comparisonSelectHTML;


            // ** ç¶å®šæ–°è¤‡é¸æ¡†çš„äº‹ä»¶ **
            smallMultiplesControls.querySelectorAll('.small-multiple-checkbox').forEach(cb => {
                cb.addEventListener('change', updateSmallMultiples);
            });
            
            // ** æ–°å¢ Q2 & Q3ï¼šç¶å®šæŒ‰éˆ•äº‹ä»¶ **
            document.getElementById('sm-select-all').addEventListener('click', () => {
                smallMultiplesControls.querySelectorAll('.small-multiple-checkbox').forEach(cb => cb.checked = true);
                updateSmallMultiples();
            });
            document.getElementById('sm-deselect-all').addEventListener('click', (e) => {
                e.preventDefault();
                smallMultiplesControls.querySelectorAll('.small-multiple-checkbox').forEach(cb => cb.checked = false);
                updateSmallMultiples();
            });
            document.getElementById('sm-download-screenshot').addEventListener('click', downloadScreenshot);
            document.getElementById('sm-export-csv').addEventListener('click', exportSingleColumnToCSV);
            
            // ç¶å®šæ¡‘åŸºåœ–æˆªåœ–æŒ‰éˆ•
            const sankeyDownloadBtn = document.getElementById('sankey-download-screenshot');
            if (sankeyDownloadBtn) {
                sankeyDownloadBtn.addEventListener('click', downloadSankeyScreenshot);
            }

            // ç¶å®šæ¨ç´åˆ†ææŒ‰éˆ•
            document.getElementById('pivot-download-screenshot').addEventListener('click', downloadPivotScreenshot);
            document.getElementById('pivot-export-csv').addEventListener('click', exportPivotToCSV);
            document.getElementById('pivot-add-all-columns').addEventListener('click', addAllPivotColumns);
            
            // ç¶å®šæ¨ç´åœ–è¡¨åˆ†ææŒ‰éˆ•
            document.getElementById('pivotTable-download-screenshot').addEventListener('click', downloadPivotTableScreenshot);
            document.getElementById('pivotTable-export-csv').addEventListener('click', exportPivotTableToCSV);
            document.getElementById('pivotTable-add-all-columns').addEventListener('click', addAllPivotTableColumns);
            document.getElementById('pivotTable-export-config').addEventListener('click', exportPivotTableConfig);
            document.getElementById('pivotTable-import-config').addEventListener('click', () => {
                document.getElementById('pivotTable-config-file').click();
            });
            document.getElementById('pivotTable-config-file').addEventListener('change', importPivotTableConfig);
            document.getElementById('pivotTable-clear-config').addEventListener('click', clearPivotTableConfig);


            // --- ç¯©é¸å™¨ (å…±ç”¨) ---
            const filtersContainer = document.getElementById('filtersContainer');
            filtersContainer.innerHTML = '';
            allColumns.forEach(colKey => {
                const details = document.createElement('details');
                details.className = 'filter-dropdown';
                details.innerHTML = `<summary class="text-sm font-medium" title="${colKey}">${colKey}</summary><div class="filter-panel space-y-2" id="filter-${colKey}-panel"></div>`;
                filtersContainer.appendChild(details);
            });

            // --- ç¶å®šä¸»åœ–è¡¨äº‹ä»¶ ---
            controls.yAxisSelect.addEventListener('change', () => { 
                updateAnnotations(); 
                updateChart(); 
                updateSankeyChart(); // ç¯©é¸å™¨è®Šæ›´ä¹Ÿæ›´æ–° Sankey
            });
            controls.colorBySelect.addEventListener('change', () => {
                updateAnnotations();
                updateChart();
                updateSankeyChart(); // ç¯©é¸å™¨è®Šæ›´ä¹Ÿæ›´æ–° Sankey
            });
            controls.swapButton.addEventListener('click', () => {
                const yValue = controls.yAxisSelect.value;
                const cValue = controls.colorBySelect.value;
                controls.yAxisSelect.value = cValue;
                controls.colorBySelect.value = yValue;
                updateAnnotations();
                updateChart();
                updateSankeyChart(); // ç¯©é¸å™¨è®Šæ›´ä¹Ÿæ›´æ–° Sankey
            });
            controls.arrowSelect.addEventListener('change', () => {
                // ç«‹å³æ›´æ–°ä¸€æ¬¡
                updateArrowPosition();
                // å»¶é²å†æ›´æ–°ä¸€æ¬¡ï¼Œç¢ºä¿åœ–è¡¨å·²å®Œå…¨æ¸²æŸ“
                setTimeout(() => updateArrowPosition(), 50);
            });
            
            // æ¬¡è¦åˆ†çµ„é¸å–®äº‹ä»¶
            controls.subGroupSelect.addEventListener('change', () => {
                updateChart();
            });
            
            // æ¨ç´åœ–è¡¨åˆ†æäº‹ä»¶
            controls.pivotRowMainSelect.addEventListener('change', updatePivotTable);
            controls.pivotRowSubSelect.addEventListener('change', updatePivotTable);
            controls.pivotRowLevel3Select.addEventListener('change', updatePivotTable);
            controls.pivotRowLevel4Select.addEventListener('change', updatePivotTable);
            controls.addPivotColumnBtn.addEventListener('click', addPivotColumnField);
            
            // åˆå§‹åŒ–æ™‚æ·»åŠ ä¸€å€‹æ¬„ä½
            addPivotColumnField();

            // ** æ–°å¢ï¼šç¶å®šçµæ§‹å·®ç•°åˆ†æäº‹ä»¶ **
            controls.compDefineSelect.addEventListener('change', () => {
                const selectedCol = controls.compDefineSelect.value;
                const valueSelects = [controls.compValue1, controls.compValue2];
                if (selectedCol) {
                    const uniqueValues = [...new Set(rawData.map(d => d[selectedCol]))];
                    const optionsHTML = '<option value="">è«‹é¸æ“‡å€¼</option>' + uniqueValues.sort(smartSort).map(val => `<option value="${val}">${val}</option>`).join('');
                    valueSelects.forEach(sel => sel.innerHTML = optionsHTML);
                    // è‡ªå‹•é¸æ“‡å‰å…©å€‹
                    if (uniqueValues.length > 0) controls.compValue1.value = uniqueValues[0];
                    if (uniqueValues.length > 1) controls.compValue2.value = uniqueValues[1];
                } else {
                    const placeholder = '<option value="">è«‹å…ˆé¸æ“‡æ¬„ä½</option>';
                    valueSelects.forEach(sel => sel.innerHTML = placeholder);
                }
                updateComparisonCharts();
            });
            [controls.compValue1, controls.compValue2, controls.compName1, controls.compName2].forEach(el => {
                el.addEventListener('change', updateComparisonCharts);
            });
            
            comparisonControls.querySelectorAll('.comparison-checkbox').forEach(cb => {
                cb.addEventListener('change', () => {
                    updateComparisonCharts();
                });
            });

            document.getElementById('comp-select-all').addEventListener('click', () => {
                comparisonControls.querySelectorAll('.comparison-checkbox').forEach(cb => cb.checked = true);
                updateComparisonCharts();
            });
            document.getElementById('comp-deselect-all').addEventListener('click', () => {
                comparisonControls.querySelectorAll('.comparison-checkbox').forEach(cb => cb.checked = false);
                updateComparisonCharts();
            });

            // *** ä¿®æ­£ï¼šå°‡äº‹ä»¶ç¶å®šç§»è‡³æ­¤è™•ï¼Œç¢ºä¿ comparisonControls å·²å®šç¾© ***
            document.getElementById('comp-export-csv').addEventListener('click', exportComparisonToCSV);
            document.getElementById('comp-download-screenshot').addEventListener('click', downloadComparisonScreenshot);


            // ** ä¿®æ­£ 2ï¼šã€Œå€¼ã€å’Œã€Œç¯©é¸å™¨ã€éœ€è¦*åˆ†é–‹*æ›´æ–°å…©å€‹åœ–è¡¨å€å¡Š **
            controls.valueSelect.addEventListener('change', updateChart); // ** åªæ›´æ–°ä¸»åœ–è¡¨ **
            controls.smallValueSelect.addEventListener('change', updateSmallMultiples); // ** åªæ›´æ–°å°åœ–è¡¨ **

            updateFilterOptions(true); // updateFilterOptions å…§éƒ¨æœƒç¶å®šç¯©é¸å™¨çš„ change äº‹ä»¶
            updateAnnotations();
        }

        
        function updateFilterOptions(isInitial = false) {
            if (isUpdatingFilters) return;
            const selections = {};
            allColumns.forEach(key => {
                const panel = document.getElementById(`filter-${key}-panel`);
                if (panel) {
                    const checkedCbs = panel.querySelectorAll('input:checked');
                    selections[key] = Array.from(checkedCbs).map(cb => cb.value);
                }
            });

            allColumns.forEach(targetKey => {
                let availableValues = [...new Set(rawData.map(d => d[targetKey]))];
                
                // ** ä¿®æ­£ï¼šä½¿ç”¨ .trim() é€²è¡Œæ’åºåˆ—è¡¨æ¯”å° **
                if (CUSTOM_SORT_ORDERS[targetKey]) {
                    availableValues.sort((a, b) => getSortIndex(a, CUSTOM_SORT_ORDERS[targetKey]) - getSortIndex(b, CUSTOM_SORT_ORDERS[targetKey]));
                } else {
                    availableValues.sort(smartSort);
                }
                
                const panel = document.getElementById(`filter-${targetKey}-panel`);
                if (!panel) return;
                const currentSelections = selections[targetKey] || [];
                panel.innerHTML = '';
                
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'flex gap-2 mb-2 sticky top-0 bg-white py-1';
                buttonsDiv.innerHTML = `
                    <button class="select-all-btn text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">å…¨é¸</button>
                    <button class="deselect-all-btn text-xs bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600">æ¸…é™¤</button>
                `;
                panel.appendChild(buttonsDiv);
                
                availableValues.forEach(val => {
                    const valAsString = String(val);
                    const checkboxId = `cb-${targetKey}-${valAsString.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    const isChecked = isInitial || currentSelections.includes(valAsString);
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex items-center';
                    itemDiv.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" value="${valAsString}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 filter-checkbox" ${isChecked ? 'checked' : ''}>
                        <label for="${checkboxId}" class="ml-2 block text-sm text-gray-900">${valAsString}</label>
                    `;
                    panel.appendChild(itemDiv);
                });
                
                // ** ä¿®æ­£ 3ï¼šç¢ºèªç¯©é¸å™¨æœƒæ›´æ–°å››å€‹åœ–è¡¨ **
                panel.querySelector('.select-all-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    panel.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
                    updateChart();
                    updateSmallMultiples(); 
                    updateSankeyChart(); // ç¯©é¸å™¨è®Šæ›´ä¹Ÿæ›´æ–° Sankey
                    updatePivotTable(); // ç¯©é¸å™¨è®Šæ›´ä¹Ÿæ›´æ–°æ¨ç´è¡¨
                    updateComparisonCharts(); // æ›´æ–°çµæ§‹å·®ç•°åˆ†æ
                    // ç›¸ä¼¼åº¦åˆ†ææ˜¯æ‰‹å‹•è§¸ç™¼ï¼Œç¯©é¸å™¨è®Šæ›´æ™‚ä¸æ¸…ç©ºçµæœ
                });
                panel.querySelector('.deselect-all-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    panel.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    updateChart();
                    updateSmallMultiples(); 
                    updateSankeyChart(); // ç¯©é¸å™¨è®Šæ›´ä¹Ÿæ›´æ–° Sankey
                    updatePivotTable(); // ç¯©é¸å™¨è®Šæ›´ä¹Ÿæ›´æ–°æ¨ç´è¡¨
                    updateComparisonCharts(); // æ›´æ–°çµæ§‹å·®ç•°åˆ†æ
                    // ç›¸ä¼¼åº¦åˆ†ææ˜¯æ‰‹å‹•è§¸ç™¼ï¼Œç¯©é¸å™¨è®Šæ›´æ™‚ä¸æ¸…ç©ºçµæœ
                });
                panel.querySelectorAll('.filter-checkbox').forEach(cb => {
                    cb.addEventListener('change', () => {
                        updateChart();
                        updateSmallMultiples(); 
                        updateSankeyChart(); // ç¯©é¸å™¨è®Šæ›´ä¹Ÿæ›´æ–° Sankey
                        updatePivotTable(); // ç¯©é¸å™¨è®Šæ›´ä¹Ÿæ›´æ–°æ¨ç´è¡¨
                        updateComparisonCharts(); // æ›´æ–°çµæ§‹å·®ç•°åˆ†æ
                        // ç›¸ä¼¼åº¦åˆ†ææ˜¯æ‰‹å‹•è§¸ç™¼ï¼Œç¯©é¸å™¨è®Šæ›´æ™‚ä¸æ¸…ç©ºçµæœ
                    });
                });
            });
        }

        // --- æ¨™è¨˜å»ºç«‹å‡½æ•¸ (Marker Creation Functions) ---
        // (é€™äº›åªçµ¦ä¸»åœ–è¡¨ä½¿ç”¨)
        function createOrUpdateArrows(count) {
            const arrowContainer = document.getElementById('markerContainer');
            if (!arrowContainer) return;
            const existing = arrowContainer.querySelectorAll('.chart-arrow');
            
            for (let i = existing.length - 1; i >= count; i--) {
                arrowContainer.removeChild(existing[i]);
            }
            for (let i = existing.length; i < count; i++) {
                const arrowEl = document.createElement('div');
                arrowEl.id = `chartArrow-${i}`;
                arrowEl.className = 'chart-arrow';
                arrowContainer.appendChild(arrowEl);
            }
        }
        function createOrUpdateQuantileMarkers(count) {
            const container = document.getElementById('markerContainer');
            if (!container) return;
            const markers = ['q1', 'q2', 'q3']; 
            const existing = container.querySelectorAll('.quantile-marker');
            const targetCount = count * markers.length;
            for (let i = existing.length - 1; i >= targetCount; i--) container.removeChild(existing[i]);
            for (let i = existing.length; i < targetCount; i++) {
                const yIndex = Math.floor(i / markers.length);
                const markerType = markers[i % markers.length];
                const markerEl = document.createElement('div');
                markerEl.id = `quantileMarker-${yIndex}-${markerType}`;
                markerEl.className = `quantile-marker ${markerType === 'q2' ? 'quantile-marker-q2' : ''}`;
                container.appendChild(markerEl);
            }
        }
        function createOrUpdateAverageLabels(count) {
            const container = document.getElementById('markerContainer');
            if (!container) return;
            const existing = container.querySelectorAll('.average-label');
            for (let i = existing.length - 1; i >= count; i--) container.removeChild(existing[i]);
            for (let i = existing.length; i < count; i++) {
                const labelEl = document.createElement('div');
                labelEl.id = `averageLabel-${i}`;
                labelEl.className = 'average-label';
                container.appendChild(labelEl);
            }
        }

        // --- æ¨™è¨˜æ›´æ–°å‡½æ•¸ (Marker Update Functions) ---
        // (é€™äº›åªçµ¦ä¸»åœ–è¡¨ä½¿ç”¨)
        function updateArrowPosition(hide = false) {
            const container = document.getElementById('markerContainer');
            if (!container) return;
            const arrows = container.querySelectorAll('.chart-arrow');
            if (hide) {
                arrows.forEach(arrow => arrow.style.display = 'none');
                return;
            }
            const selectEl = document.getElementById('arrowSelect');
            const selectedLabelString = selectEl.value;
            arrows.forEach(arrow => arrow.style.display = 'none'); 
            if (!chart || !selectedLabelString) return;
            
            // å¼·åˆ¶åœ–è¡¨æ›´æ–°ä»¥ç¢ºä¿æ‰€æœ‰å…ƒç´ ä½ç½®æ­£ç¢º
            chart.update('none'); // ä½¿ç”¨ 'none' æ¨¡å¼é¿å…å‹•ç•«å»¶é²
            
            const datasets = chart.data.datasets;
            let datasetIndex = -1;
            for (let i = 0; i < datasets.length; i++) {
                if (String(datasets[i].label) === selectedLabelString) {
                    datasetIndex = i;
                    break;
                }
            }
            if (datasetIndex === -1) return; 
            const meta = chart.getDatasetMeta(datasetIndex);
            if (!meta || !meta.data || meta.data.length === 0) return;
            meta.data.forEach((element, index) => {
                const arrowEl = document.getElementById(`chartArrow-${index}`);
                if (!arrowEl || !element || typeof element.getProps !== 'function' || element.hidden) {
                    if (arrowEl) arrowEl.style.display = 'none';
                    return;
                }
                const props = element.getProps(['x', 'y', 'height', 'base'], true);
                const hasVisibleWidth = props && (props.x > props.base + 0.01);
                if (hasVisibleWidth) {
                    const xPos = props.x;
                    const yPos = props.y - (props.height / 2);
                    const arrowHeight = 8;
                    const margin = 2;
                    arrowEl.style.left = `${xPos}px`;
                    arrowEl.style.top = `${yPos - arrowHeight - margin}px`;
                    arrowEl.style.display = 'block';
                } else {
                    arrowEl.style.display = 'none';
                }
            });
        }
        function updateQuantileMarkers(hide = false, yKey, groupKey, yLabels, filteredData) {
            const container = document.getElementById('markerContainer');
            if (!container) return;
            const allMarkers = container.querySelectorAll('.quantile-marker');
            allMarkers.forEach(marker => marker.style.display = 'none'); 
            if (hide || !chart) return;
            yLabels.forEach((yLabel, yIndex) => {
                
                // ** BUG 1 ä¿®æ­£ (ç¬¬äºŒæ¬¡)ï¼šä½¿ç”¨ bar element çš„å±¬æ€§ä¾†å®šä½ **
                // æˆ‘å€‘éœ€è¦ bar element çš„å±¬æ€§ä¾†æ‰¾åˆ°å®ƒçš„åº•éƒ¨é‚Šç·£
                let barProps = null;
                for (let i = 0; i < chart.data.datasets.length; i++) {
                    const meta = chart.getDatasetMeta(i);
                    if (meta && meta.data[yIndex]) {
                        const el = meta.data[yIndex];
                        if (el && !el.hidden && typeof el.getProps === 'function') {
                            // æ‰¾åˆ°äº†ç¬¬ä¸€å€‹å¯è¦‹çš„ barï¼Œå–å¾—å®ƒçš„å±¬æ€§
                            barProps = el.getProps(['y', 'height'], true);
                            break; // æ‰¾åˆ°å°±è·³å‡ºè¿´åœˆ
                        }
                    }
                }

                // å¦‚æœæ²’æœ‰å¯è¦‹çš„ barï¼Œå°±ç„¡æ³•æ”¾ç½® marker
                if (!barProps) return;Â 

                // barProps.y æ˜¯ bar çš„ä¸­å¿ƒ Y è»¸ä½ç½®
                // barProps.height æ˜¯ bar çš„åšåº¦
                const barBottomEdge = barProps.y + (barProps.height / 2);
                // ** BUG 1 ä¿®æ­£çµæŸ **

                let groupData = filteredData
                    .filter(d => String(d[yKey]) === String(yLabel))
                    .map(d => d[groupKey])
                    .filter(val => val !== undefined && val !== null);
                if (groupData.length === 0) return;
                
                // ** ä¿®æ­£ï¼šä½¿ç”¨ .trim() é€²è¡Œæ’åºåˆ—è¡¨æ¯”å° **
                const customOrder = CUSTOM_SORT_ORDERS[groupKey];
                const sortedIndices = Array.from(Array(groupData.length).keys()).sort((a, b) => {
                    if (customOrder) {
                        return getSortIndex(groupData[a], customOrder) - getSortIndex(groupData[b], customOrder);
                    }
                    return smartSort(groupData[a], groupData[b]);
                });
                
                const q1Index = sortedIndices[Math.floor(groupData.length * 0.25)];
                const q2Index = sortedIndices[Math.floor(groupData.length * 0.50)];
                const q3Index = sortedIndices[Math.floor(groupData.length * 0.75)];
                const q1Value = groupData[q1Index];
                const q2Value = groupData[q2Index];
                const q3Value = groupData[q3Index];
                const datasets = chart.data.datasets;
                const q1DatasetIndex = datasets.findIndex(ds => String(ds.label) === String(q1Value));
                const q2DatasetIndex = datasets.findIndex(ds => String(ds.label) === String(q2Value));
                const q3DatasetIndex = datasets.findIndex(ds => String(ds.label) === String(q3Value));

                // ** ä¿®æ­£ 2ï¼šç²å–é•·æ¢å€å¡Šçš„ä¸­å¿ƒé» X è»¸ä½ç½® **
                const getXPixel = (targetDatasetIndex) => {
                    if (targetDatasetIndex === -1) return null;
                    const datasetMeta = chart.getDatasetMeta(targetDatasetIndex);
                    if (!datasetMeta || !datasetMeta.data[yIndex]) return null;
                    const dataElement = datasetMeta.data[yIndex];
                    if (dataElement.hidden || !dataElement.getProps) return null; 
                    
                    // å–å¾— bar segment çš„ä¸­å¿ƒé» X è»¸ä½ç½®
                    return dataElement.getCenterPoint().x;
        };
                // ** ä¿®æ­£çµæŸ **

                const xPixels = { q1: getXPixel(q1DatasetIndex), q2: getXPixel(q2DatasetIndex), q3: getXPixel(q3DatasetIndex) };
                ['q1', 'q2', 'q3'].forEach(q => {
                    const markerEl = document.getElementById(`quantileMarker-${yIndex}-${q}`);
                    // ç®­é ­è·é›¢é•·æ¢åº•éƒ¨é‚Šç·£ 4px
                    const markerMargin = 4; 
                    if (markerEl && xPixels[q] !== null) {
                        markerEl.style.left = `${xPixels[q]}px`;
                        // ** é—œéµä¿®æ­£ï¼šä½¿ç”¨ barBottomEdge **
                        markerEl.style.top = `${barBottomEdge + markerMargin}px`;
                        markerEl.style.display = 'block';
                    }
                });
            });
        }
        function updateAverageLabels(hide = false, yKey, groupKey, yLabels, filteredData, subGroupKey = null) {
            const container = document.getElementById('markerContainer');
            if (!container) return;
            const allLabels = container.querySelectorAll('.average-label');
            allLabels.forEach(label => label.style.display = 'none');
            if (hide || !chart) return;
            
            yLabels.forEach((yItem, yIndex) => {
                // å¦‚æœæ˜¯å­—ä¸²ï¼ˆèˆŠæ ¼å¼ï¼‰ï¼Œè½‰æ›ç‚ºç‰©ä»¶
                const labelObj = typeof yItem === 'string' ? { primary: yItem, secondary: null, isSpacer: false, isTotal: false } : yItem;
                
                // è·³éé–“è·æ¨™ç±¤
                if (labelObj.isSpacer) return;
                
                let numericData;
                if (subGroupKey && labelObj.secondary && !labelObj.isTotal) {
                    // æœ‰æ¬¡è¦åˆ†çµ„ä¸”ä¸æ˜¯ç¸½è¨ˆï¼šéæ¿¾ä¸»è¦å’Œæ¬¡è¦åˆ†çµ„
                    numericData = filteredData
                        .filter(d => String(d[yKey]) === String(labelObj.primary) && String(d[subGroupKey]) === String(labelObj.secondary))
                        .map(d => parseNumericValue(d[groupKey]))
                        .filter(val => val.isNumeric)
                        .map(val => val.num);
                } else {
                    // ç„¡æ¬¡è¦åˆ†çµ„æˆ–æ˜¯ç¸½è¨ˆBARï¼šåªéæ¿¾ä¸»è¦åˆ†çµ„
                    numericData = filteredData
                        .filter(d => String(d[yKey]) === String(labelObj.primary))
                        .map(d => parseNumericValue(d[groupKey]))
                        .filter(val => val.isNumeric)
                        .map(val => val.num);
                }
                
                if (numericData.length === 0) return; 
                const sum = numericData.reduce((a, b) => a + b, 0);
                const average = sum / numericData.length;
                const meta = chart.getDatasetMeta(0); 
                if (!meta || !meta.data[yIndex]) return;
                const element = meta.data[yIndex];
                if (!element || typeof element.getProps !== 'function') return;
                const lastDatasetMeta = chart.getDatasetMeta(chart.data.datasets.length - 1);
                if (!lastDatasetMeta || !lastDatasetMeta.data[yIndex]) return;
                const lastElement = lastDatasetMeta.data[yIndex];
                const props = lastElement.getProps(['x', 'y', 'height'], true);
                const yPixel = props.y; 
                let xPixel = props.x; 
                const valueType = controls.valueSelect.value;
                if(valueType === 'percent') {
                    xPixel = chart.scales.x.getPixelForValue(100);
                }
                
                // ä¿®æ”¹ï¼šå°‡æ¨™ç±¤æ”¾åœ¨åœ–è¡¨å³é‚Šç·£å¤–å´ï¼ˆåŠ ä¸Š5pxé–“è·ï¼‰
                const chartRightEdge = chart.scales.x.right;
                const labelX = chartRightEdge + 5;
                
                const labelEl = document.getElementById(`averageLabel-${yIndex}`);
                if (labelEl) {
                    labelEl.textContent = `${average.toFixed(1)}`; 
                    labelEl.style.left = `${labelX}px`;
                    labelEl.style.top = `${yPixel}px`;
                    labelEl.style.display = 'block';
                }
            });
        }

        // ** ä¿®æ­£ 3.0: æ›´æ–°ä¸»åœ–è¡¨è¨­å®šçš„å‡½æ•¸ (åŠ å…¥ forceUpdate åƒæ•¸) **
        function updateChartSettings(forceUpdate = false) {
            if (!chart) return;
            
            // ** ä¿®æ­£ 1.1: å¦‚æœç”¨æˆ¶èª¿æ•´äº†è¨­å®šï¼Œæˆ‘å€‘å¼·åˆ¶å°‡è¨­å®šå€¼å¯«å…¥ Options **
            chart.options.scales.y.barPercentage = BAR_PERCENTAGE;
            chart.options.scales.y.categoryPercentage = BAR_CATEGORY_PERCENTAGE;
            chart.options.plugins.datalabels.font.size = DATALABELS_FONT_SIZE;
            
            if (forceUpdate) {
                 // é‡æ–°è§¸ç™¼å®Œæ•´æ›´æ–°ï¼Œé€™æœƒé‡æ–°è¨ˆç®—é«˜åº¦ä¸¦é‡ç¹ª
                 updateChart();
                 updateSankeyChart(); // é‡æ–°ç¹ªè£½ Sankey åœ–
            } else {
                chart.update();
                const yKey = controls.yAxisSelect.value;
                const groupKey = controls.colorBySelect.value;
                // æ³¨æ„ï¼šfilteredData åœ¨é€™è£¡å¯èƒ½ä¸æ˜¯æœ€æ–°çš„ï¼Œä½†æˆ‘å€‘å‡è¨­å®ƒè¶³å¤ ç”¨æ–¼ marker çš„å¤§è‡´å®šä½
                const isGroupKeyNumeric = groupKey !== 'none' && rawData.length > 0 && parseNumericValue(rawData[0][groupKey]).isNumeric; // ç°¡åŒ–åˆ¤æ–·
                setTimeout(() => triggerMarkerUpdates(yKey, groupKey, chart.data.labels, rawData, isGroupKeyNumeric), 50);
            }
        }

        // --- ä¸»æ›´æ–°å‡½æ•¸ (æ¨ç´åˆ†æ) ---
        function updateChart() {
            if (!chart || !controls.yAxisSelect) return;
            isUpdatingFilters = true;

            const yKey = controls.yAxisSelect.value;
            const groupKey = controls.colorBySelect.value;
            const subGroupKey = controls.subGroupSelect.value; // æ¬¡è¦åˆ†çµ„
            const valueType = controls.valueSelect.value;
            updateAnnotations();
            
            // æ§åˆ¶æ¬¡è¦åˆ†çµ„é¸å–®çš„é¡¯ç¤º
            const subGroupContainer = document.getElementById('subGroupContainer');
            if (yKey) {
                subGroupContainer.classList.remove('hidden');
            } else {
                subGroupContainer.classList.add('hidden');
            }

            // æŠ“å–ç¯©é¸ (èˆ‡å°åœ–è¡¨å…±ç”¨)
            const activeFilters = getActiveFilters();
            let filteredData = rawData.filter(d => {
                return allColumns.every(key => {
                    const filterValues = activeFilters[key];
                    if (filterValues === undefined) return true;
                    if (filterValues.length === 0) return false;
                    return filterValues.includes(String(d[key]));
                });
            });



            // è™•ç†æ¬¡è¦åˆ†çµ„
            let yLabels;
            if (subGroupKey) {
                // æœ‰æ¬¡è¦åˆ†çµ„ï¼šå‰µå»ºçµ„åˆæ¨™ç±¤ï¼ˆä¾‹å¦‚ï¼š"ç„¡é–’éŒ¢-çŠ¬", "ç„¡é–’éŒ¢-è²“"ï¼‰
                const primaryLabels = [...new Set(filteredData.map(d => d[yKey]))];
                if (CUSTOM_SORT_ORDERS[yKey]) primaryLabels.sort((a, b) => getSortIndex(a, CUSTOM_SORT_ORDERS[yKey]) - getSortIndex(b, CUSTOM_SORT_ORDERS[yKey]));
                else primaryLabels.sort(smartSort);
                
                const secondaryLabels = [...new Set(filteredData.map(d => d[subGroupKey]))];
                if (CUSTOM_SORT_ORDERS[subGroupKey]) secondaryLabels.sort((a, b) => getSortIndex(a, CUSTOM_SORT_ORDERS[subGroupKey]) - getSortIndex(b, CUSTOM_SORT_ORDERS[subGroupKey]));
                else secondaryLabels.sort(smartSort);
                
                // å‰µå»ºçµ„åˆæ¨™ç±¤ï¼Œåœ¨ä¸»è¦åˆ†çµ„ä¹‹é–“æ·»åŠ å›ºå®š1å€‹é–“è·
                yLabels = [];
                primaryLabels.forEach((primary, pIdx) => {
                    // 1. å…ˆæ·»åŠ ä¸»è¦åˆ†çµ„çš„ç¸½è¨ˆBAR
                    yLabels.push({ primary, secondary: null, label: String(primary), isSpacer: false, isTotal: true });
                    
                    // 2. å†æ·»åŠ å„å€‹æ¬¡è¦åˆ†çµ„çš„BAR
                    secondaryLabels.forEach(secondary => {
                        // æª¢æŸ¥é€™å€‹çµ„åˆæ˜¯å¦æœ‰è³‡æ–™
                        const hasData = filteredData.some(d => 
                            String(d[yKey]) === String(primary) && 
                            String(d[subGroupKey]) === String(secondary)
                        );
                        if (hasData) {
                            yLabels.push({ primary, secondary, label: `${primary}-${secondary}`, isSpacer: false, isTotal: false });
                        }
                    });
                    
                    // 3. åœ¨æ¯å€‹ä¸»è¦åˆ†çµ„å¾Œæ·»åŠ 1å€‹é–“è·æ¨™ç±¤ï¼ˆé™¤äº†æœ€å¾Œä¸€å€‹ï¼‰
                    if (pIdx < primaryLabels.length - 1) {
                        yLabels.push({ primary: null, secondary: null, label: '', isSpacer: true, isTotal: false }); // ç©ºå­—ä¸²éš±è—æ¨™ç±¤
                    }
                });
            } else {
                // ç„¡æ¬¡è¦åˆ†çµ„ï¼šä½¿ç”¨åŸæœ¬çš„é‚è¼¯
                yLabels = [...new Set(filteredData.map(d => d[yKey]))];
                if (CUSTOM_SORT_ORDERS[yKey]) yLabels.sort((a, b) => getSortIndex(a, CUSTOM_SORT_ORDERS[yKey]) - getSortIndex(b, CUSTOM_SORT_ORDERS[yKey]));
                else yLabels.sort(smartSort);
                yLabels = yLabels.map(label => ({ primary: label, secondary: null, label, isSpacer: false, isTotal: false }));
            }
            
            chart.data.labels = yLabels.map(item => item.label);

            let groupLabels;
            let colorMap = {};
            const isPercent = valueType === 'percent';
            
            let isGroupKeyNumeric = false;
            if (groupKey !== 'none' && filteredData.length > 0) {
                const firstValue = filteredData.find(d => d[groupKey] !== null && d[groupKey] !== undefined);
                if(firstValue) {
                    isGroupKeyNumeric = parseNumericValue(firstValue[groupKey]).isNumeric;
                }
            }

            if (groupKey !== 'none') {
                groupLabels = [...new Set(filteredData.map(d => d[groupKey]))];
                if (CUSTOM_SORT_ORDERS[groupKey]) groupLabels.sort((a, b) => getSortIndex(a, CUSTOM_SORT_ORDERS[groupKey]) - getSortIndex(b, CUSTOM_SORT_ORDERS[groupKey]));
                else groupLabels.sort(smartSort);

                // ** ä¿®æ­£ï¼šä¸å†å‹•æ…‹ç”Ÿæˆ colorMapï¼Œç›´æ¥åœ¨ä¸‹é¢ä½¿ç”¨ getColorForValue å‡½æ•¸ **
                // èˆŠçš„ colorMap ç”Ÿæˆé‚è¼¯å·²ç§»é™¤ï¼Œå› ç‚ºå®ƒæœƒå°è‡´é¡è‰²ä¸å›ºå®šçš„å•é¡Œã€‚
                // æˆ‘å€‘å°‡åœ¨ä¸‹é¢çš„ datasets æ˜ å°„ä¸­ç›´æ¥èª¿ç”¨ getColorForValueã€‚

                const totalsPerYLabel = yLabels.map(yItem => {
                    if (yItem.isSpacer) return 1; // é–“è·æ¨™ç±¤
                    let count;
                    if (subGroupKey && !yItem.isTotal) {
                        // æ¬¡è¦åˆ†çµ„çš„ç´°åˆ†BARï¼šéœ€è¦éæ¿¾ä¸»è¦å’Œæ¬¡è¦
                        count = filteredData.filter(d => String(d[yKey]) === String(yItem.primary) && String(d[subGroupKey]) === String(yItem.secondary)).length;
                    } else {
                        // ä¸»è¦åˆ†çµ„çš„ç¸½è¨ˆBARæˆ–ç„¡æ¬¡è¦åˆ†çµ„ï¼šåªéæ¿¾ä¸»è¦
                        count = filteredData.filter(d => String(d[yKey]) === String(yItem.primary)).length;
                    }
                    return count > 0 ? count : 1;
                });

                chart.data.datasets = groupLabels.map(groupVal => {
                    const dataValues = yLabels.map((yItem, yIdx) => {
                        if (yItem.isSpacer) return 0; // é–“è·æ¨™ç±¤é¡¯ç¤ºç‚º0
                        let count;
                        if (subGroupKey && !yItem.isTotal) {
                            // æ¬¡è¦åˆ†çµ„çš„ç´°åˆ†BARï¼šéœ€è¦éæ¿¾ä¸»è¦ã€æ¬¡è¦å’Œé¡è‰²åˆ†çµ„
                            count = filteredData.filter(d => 
                                String(d[yKey]) === String(yItem.primary) && 
                                String(d[subGroupKey]) === String(yItem.secondary) &&
                                String(d[groupKey]) === String(groupVal)
                            ).length;
                        } else {
                            // ä¸»è¦åˆ†çµ„çš„ç¸½è¨ˆBARæˆ–ç„¡æ¬¡è¦åˆ†çµ„ï¼šåªéæ¿¾ä¸»è¦å’Œé¡è‰²åˆ†çµ„
                            count = filteredData.filter(d => 
                                String(d[yKey]) === String(yItem.primary) && 
                                String(d[groupKey]) === String(groupVal)
                            ).length;
                        }
                        return isPercent ? (count / totalsPerYLabel[yIdx]) * 100 : count;
                    });
                    const originalLabel = [...new Set(rawData.map(d => d[groupKey]))].find(l => String(l) === String(groupVal)) ?? groupVal;
                    // ** ä¿®æ­£ï¼šç›´æ¥èª¿ç”¨ getColorForValue ç¢ºä¿é¡è‰²å›ºå®š **
                    const color = getColorForValue(groupVal, groupKey);
                    return { 
                        label: originalLabel, 
                        data: dataValues, 
                        backgroundColor: color + 'CC', 
                        borderColor: color, 
                        borderWidth: 0, 
                        borderRadius: 0 
        };
                });
                
                document.getElementById('yAxisChartTitle').textContent = subGroupKey ? `${yKey} (æ¬¡è¦åˆ†çµ„: ${subGroupKey})` : yKey;
                document.getElementById('cAxisChartTitle').textContent = groupKey;
                
            } else { // ç„¡åˆ†çµ„
                const dataCounts = yLabels.map(yItem => {
                    if (yItem.isSpacer) return 0; // é–“è·æ¨™ç±¤é¡¯ç¤ºç‚º0
                    if (subGroupKey && !yItem.isTotal) {
                        // æ¬¡è¦åˆ†çµ„çš„ç´°åˆ†BAR
                        return filteredData.filter(d => 
                            String(d[yKey]) === String(yItem.primary) && 
                            String(d[subGroupKey]) === String(yItem.secondary)
                        ).length;
                    } else {
                        // ä¸»è¦åˆ†çµ„çš„ç¸½è¨ˆBARæˆ–ç„¡æ¬¡è¦åˆ†çµ„
                        return filteredData.filter(d => String(d[yKey]) === String(yItem.primary)).length;
                    }
                });
                chart.data.datasets = [{
                    label: 'ç­†æ•¸', data: dataCounts,
                    backgroundColor: CATEGORICAL_PALETTE[0] + 'CC', borderColor: CATEGORICAL_PALETTE[0], 
                    borderWidth: 0, // ** ä¿®æ­£ï¼šç§»é™¤é–“è· **
                    borderRadius: 0 // ** æ–°å¢ï¼šç§»é™¤åœ“è§’ **
                }];
                document.getElementById('yAxisChartTitle').textContent = subGroupKey ? `${yKey} (æ¬¡è¦åˆ†çµ„: ${subGroupKey})` : yKey;
                document.getElementById('cAxisChartTitle').textContent = '';
            }

            // --- æ›´æ–°åœ–è¡¨é¸é … (Xè»¸, Tooltip, Datalabels) ---
            chart.options.plugins.tooltip.callbacks = {
                // ** ä¿®æ­£ 2.1: çªå‡ºé¡¯ç¤ºç•¶å‰ hover çš„ dataset **
                label: function(context) {
                    let label = context.dataset.label || '';
                    const rawCount = filteredData.filter(d => 
                        String(d[yKey]) === String(chart.data.labels[context.dataIndex]) && 
                        String(d[groupKey]) === String(context.dataset.label)
                    ).length;

                    if (label) {
                        label += ': ';
                    } else {
                        label = 'ç­†æ•¸: ';
                    }

                    if (isPercent) {
                        label += context.parsed.x !== null ? context.parsed.x.toFixed(1) + '%' : 'N/A';
                        label += ` (${rawCount}ç­†)`;
                    } else {
                        label += context.parsed.x !== null ? context.parsed.x : 'N/A';
                    }
                    return label;
                },
                // ** æ–°å¢ footer: é¡¯ç¤ºç•¶å‰ hover çš„ç¸½æ•¸å’Œç™¾åˆ†æ¯” **
                footer: function(context) {
                    const yValue = chart.data.labels[context[0].dataIndex];
                    const total = filteredData.filter(d => String(d[yKey]) === String(yValue)).length;
                    const totalText = total > 0 ? `ç¸½è¨ˆ: ${total} ç­†` : 'ç¸½è¨ˆ: N/A';
                    return totalText;
                }
        };
            
            // ** ä¿®æ­£ 2.2: çªå‡ºé¡¯ç¤º hover çš„ bar **
            chart.options.plugins.tooltip.backgroundColor = 'rgba(0, 0, 0, 0.8)';
            chart.options.plugins.tooltip.titleFont = { weight: 'bold', size: 14 }; // ç¢ºä¿æ¨™é¡Œç²—é«”
            chart.options.plugins.tooltip.footerFont = { weight: 'bold', size: 12 };
            chart.options.plugins.tooltip.mode = 'nearest'; // ç¢ºä¿èƒ½æŠ“åˆ°å–®ç¨çš„ bar
            chart.options.plugins.tooltip.position = 'nearest'; 


            if (isPercent) {
                chart.options.scales.x.max = 100;
                chart.options.scales.x.title.text = 'å„åˆ—ä½”æ¯” (%)';
                chart.options.plugins.datalabels.display = true;
                // ** ä¿®æ­£ 3.1: ä½¿ç”¨å…¨å±€è¨­å®šçš„å­—é«”å¤§å° **
                chart.options.plugins.datalabels.font.size = DATALABELS_FONT_SIZE;
                chart.options.plugins.datalabels.formatter = (value) => value > 5 ? Math.round(value) + '%' : '';
            } else { // ç­†æ•¸æ¨¡å¼
                chart.options.scales.x.max = undefined;
                chart.options.scales.x.title.text = 'ç­†æ•¸ (Count)';
                chart.options.plugins.datalabels.display = false;
            }
            
            // ** ä¿®æ­£ 1.1: å¥—ç”¨é•·æ¢ç²—åº¦è¨­å®š (Pivot) **
            chart.options.scales.y.barPercentage = BAR_PERCENTAGE;
            chart.options.scales.y.categoryPercentage = BAR_CATEGORY_PERCENTAGE;
            chart.options.plugins.datalabels.font.size = DATALABELS_FONT_SIZE; // ç¢ºä¿ datalabels size ä¹ŸåŒæ­¥

            // --- å‹•æ…‹èª¿æ•´åœ–è¡¨é«˜åº¦ ---
            const chartContainer = document.querySelector('.chart-container');
            const heightPerLabel = 30;
            // ** ä¿®æ­£ 1.2: è€ƒæ…® BAR_CATEGORY_PERCENTAGE ä¾†èª¿æ•´é«˜åº¦ **
            const adjustedHeightPerLabel = heightPerLabel * BAR_CATEGORY_PERCENTAGE;
            const baseHeight = 150;
            const newHeight = baseHeight + yLabels.length * adjustedHeightPerLabel;
            const finalHeight = Math.min(Math.max(newHeight, 350), 8000); // æœ€å°é«˜åº¦é™ä½
            chartContainer.style.height = `${finalHeight}px`;
            if (chart) chart.resize();

            // --- æ›´æ–°åœ–ä¾‹ ---
            const legendContainer = document.getElementById('customLegend');
            const arrowSelectContainer = document.getElementById('arrowSelectContainer');
            if (groupKey !== 'none') {
                let legendHTML = '';
                chart.data.datasets.forEach((dataset, index) => {
                    const label = dataset.label;
                    const color = dataset.borderColor || dataset.backgroundColor;
                    const isHidden = dataset.hidden || false;
                    legendHTML += `<div class="flex items-center legend-item ${isHidden ? 'legend-item-hidden' : ''}" data-label="${label}" data-dataset-index="${index}">
                                     <span class="w-3 h-3 mr-1" style="background-color: ${color}; border-radius: 2px;"></span>
                                     <span class="text-sm text-gray-700">${label}</span>
                                   </div>`;
                });
                legendContainer.innerHTML = legendHTML;
                legendContainer.querySelectorAll('.legend-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const datasetIndex = parseInt(item.getAttribute('data-dataset-index'));
                        if (!chart || isNaN(datasetIndex) || datasetIndex < 0 || datasetIndex >= chart.data.datasets.length) return;
                        chart.data.datasets[datasetIndex].hidden = !chart.data.datasets[datasetIndex].hidden;
                        item.classList.toggle('legend-item-hidden', chart.data.datasets[datasetIndex].hidden);
                        chart.update();
                        setTimeout(() => triggerMarkerUpdates(yKey, groupKey, yLabels, filteredData, isGroupKeyNumeric), 10);
                    });
                });
                controls.arrowSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
                groupLabels.forEach(label => controls.arrowSelect.innerHTML += `<option value="${label}">${label}</option>`);
                arrowSelectContainer.classList.remove('hidden'); 
            } else { 
                legendContainer.innerHTML = '';
                arrowSelectContainer.classList.add('hidden');
                controls.arrowSelect.value = "";
            }

            // --- æ›´æ–°ç¯©é¸å™¨ç‹€æ…‹ ---
            updateFilterActiveStates();

            // --- æ›´æ–°åœ–è¡¨èˆ‡æ¨™è¨˜ ---
            chart.update();
            createOrUpdateArrows(yLabels.length);
            createOrUpdateQuantileMarkers(yLabels.length);
            createOrUpdateAverageLabels(yLabels.length);
            setTimeout(() => {
                triggerMarkerUpdates(yKey, groupKey, yLabels, filteredData, isGroupKeyNumeric, subGroupKey);
            }, 50); 
            isUpdatingFilters = false;
        }
        
        // --- æå–ç¯©é¸å™¨ç‹€æ…‹ (é€šç”¨å‡½æ•¸) ---
        function getActiveFilters() {
            const activeFilters = {};
            allColumns.forEach(catKey => {
                const panel = document.getElementById(`filter-${catKey}-panel`);
                if (panel) {
                    const checkedCbs = panel.querySelectorAll('input[type="checkbox"].filter-checkbox:checked');
                    activeFilters[catKey] = Array.from(checkedCbs).map(cb => cb.value);
                }
            });
            return activeFilters;
        }
        
        // --- æ›´æ–°ç¯©é¸å™¨è¦–è¦ºç‹€æ…‹ (é€šç”¨å‡½æ•¸) ---
        function updateFilterActiveStates() {
            allColumns.forEach(catKey => {
                const panel = document.getElementById(`filter-${catKey}-panel`);
                if (!panel) return;
                const summary = panel.closest('.filter-dropdown').querySelector('summary');
                if (!summary) return;
                const allCheckboxes = panel.querySelectorAll('input[type="checkbox"].filter-checkbox');
                const checkedCheckboxes = panel.querySelectorAll('input[type="checkbox"].filter-checkbox:checked');
                if (allCheckboxes.length > 0) {
                    const isFiltered = checkedCheckboxes.length < allCheckboxes.length;
                    summary.classList.toggle('filter-active', isFiltered);
                } else {
                    summary.classList.remove('filter-active');
                }
            });
        }
        
        // --- ä¸»æ¨™è¨˜è§¸ç™¼ (æ¨ç´åˆ†æ) ---
        function triggerMarkerUpdates(yKey, groupKey, yLabels, filteredData, isGroupKeyNumeric, subGroupKey = null) {
            const valueType = controls.valueSelect.value;
            const hideQuantiles = valueType === 'percent' || groupKey === 'none' || !isGroupKeyNumeric;
            const hideAverage = groupKey === 'none' || !isGroupKeyNumeric;
            
            updateArrowPosition(false);
            updateQuantileMarkers(hideQuantiles, yKey, groupKey, yLabels, filteredData);
            updateAverageLabels(hideAverage, yKey, groupKey, yLabels, filteredData, subGroupKey);
        }

        // å»ºç«‹åœ–è¡¨ (åªåŸ·è¡Œä¸€æ¬¡)
        function createChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { top: 20, right: 60 } }, // æ·»åŠ å³å´paddingç‚ºå¹³å‡æ•¸æ¨™ç±¤ç•™ç©ºé–“
                    scales: {
                        x: { stacked: true, title: { display: true, text: 'ç­†æ•¸ (Count)', font: { size: 14 } } },
                        y: { 
                            stacked: true, 
                            ticks: { autoSkip: false },
                            barPercentage: BAR_PERCENTAGE,  // ** ä½¿ç”¨å…¨å±€è®Šæ•¸ **
                            categoryPercentage: BAR_CATEGORY_PERCENTAGE // ** ä½¿ç”¨å…¨å±€è®Šæ•¸ **
                        }
                    },
                    plugins: {
                        datalabels: { 
                            display: false, 
                            color: '#333', 
                            font: { weight: 'bold', size: DATALABELS_FONT_SIZE } // ** ä½¿ç”¨å…¨åŸŸè®Šæ•¸ **
                        },
                        tooltip: { 
                            enabled: true, 
                            mode: 'index', 
                            intersect: false,
                            // ** ä¿®æ­£ Tooltip é¡¯ç¤º **
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: { weight: 'bold', size: 14 }, 
                            footerFont: { weight: 'bold', size: 12 },
                            mode: 'nearest', 
                            position: 'nearest' 
                        },
                        legend: { display: false }
                    }
                }
            });
            
            // ** ä¿®æ­£ Q1ï¼šä¿®æ”¹ Resize äº‹ä»¶ **
            window.addEventListener('resize', debounce(() => {
                // å®Œæ•´é‡ç¹ªï¼Œæ‰èƒ½åœ¨ Zoom ä¹‹å¾Œæ­£ç¢ºå®šç‚º
                updateChart();
                updateSankeyChart(); // ç¸®æ”¾æ™‚é‡ç¹ª Sankey
                updateSmallMultiples();
            }, 250));
        }
        
        // ===============================================
        // == æ¡‘åŸºåœ– (Sankey Diagram) å‡½æ•° (æ–°å¢/æ›¿æ›) ==
        // ===============================================
        
        // ** Helper for Sankey Color **
        // (å·²ç§»å‹•è‡³ä¸‹æ–¹çµ±ä¸€å®£å‘Š)
        
        // ===============================================
        // == æ¨ç´åœ–è¡¨åˆ†æå‡½æ•¸ ==
        // ===============================================
        // ===============================================
        // == æ¨ç´åœ–è¡¨åˆ†æå‡½æ•¸ (æ–°ç‰ˆ) ==
        // ===============================================
        
        let pivotColumnCounter = 0;
        
        // æ·»åŠ æ–°çš„æ•¸æ“šæ¬„
        function addPivotColumnField(defaultField = '') {
            const container = document.getElementById('pivotColumnsContainer');
            const id = pivotColumnCounter++;
            
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'flex gap-2 items-center p-2 bg-gray-50 rounded border border-gray-200';
            fieldDiv.id = `pivotCol_${id}`;
            
            // æ¬„ä½é¸æ“‡
            const fieldSelect = document.createElement('select');
            fieldSelect.className = 'flex-1 py-1.5 px-2 border border-gray-300 bg-white rounded text-xs';
            fieldSelect.innerHTML = '<option value="">é¸æ“‡æ¬„ä½</option>';
            allColumns.forEach(key => {
                const selected = key === defaultField ? ' selected' : '';
                fieldSelect.innerHTML += `<option value="${key}"${selected}>${key}</option>`;
            });
            
            // èšåˆå‡½æ•¸é¸æ“‡
            const aggSelect = document.createElement('select');
            aggSelect.className = 'w-24 py-1.5 px-2 border border-gray-300 bg-white rounded text-xs';
            aggSelect.innerHTML = `
                <option value="count">COUNT</option>
                <option value="countunique">UNIQUE</option>
                <option value="sum">SUM</option>
                <option value="average">AVG</option>
                <option value="max">MAX</option>
                <option value="min">MIN</option>
                <option value="median">MEDIAN</option>
                <option value="stdev">STDEV</option>
                <option value="var">VAR</option>
                <option value="countx">X</option>
            `;
            
            // æ ¼å¼è¼¸å…¥æ¡†
            const formatInput = document.createElement('input');
            formatInput.type = 'text';
            formatInput.placeholder = 'æ ¼å¼/Xå€¼ ä¾‹:1æˆ–"å…ƒ"';
            formatInput.className = 'w-32 py-1.5 px-2 border border-gray-300 bg-white rounded text-xs';
            formatInput.title = 'æ ¼å¼ï¼š#,##0 "å–®ä½" æˆ–ç›´æ¥è¼¸å…¥å–®ä½\nXå‡½æ•¸ï¼šè¼¸å…¥è¦è¨ˆç®—çš„å€¼ï¼ˆå¦‚ï¼š1ã€0ã€æ˜¯ï¼‰';
            
            // åˆªé™¤æŒ‰éˆ•
            const removeBtn = document.createElement('button');
            removeBtn.className = 'px-2 py-1 text-red-600 hover:bg-red-50 rounded text-xs';
            removeBtn.innerHTML = 'âœ•';
            removeBtn.onclick = () => {
                fieldDiv.remove();
                updatePivotTable();
            };
            
            fieldDiv.appendChild(fieldSelect);
            fieldDiv.appendChild(aggSelect);
            fieldDiv.appendChild(formatInput);
            fieldDiv.appendChild(removeBtn);
            container.appendChild(fieldDiv);
            
            fieldSelect.addEventListener('change', updatePivotTable);
            aggSelect.addEventListener('change', updatePivotTable);
            formatInput.addEventListener('change', updatePivotTable);
            formatInput.addEventListener('blur', updatePivotTable);
        }
        
        // ç²å–æ‰€æœ‰å·²é…ç½®çš„æ¬„ä½
        function getPivotColumns() {
            const container = document.getElementById('pivotColumnsContainer');
            const columns = [];
            
            container.querySelectorAll('[id^="pivotCol_"]').forEach(div => {
                const fieldSelect = div.querySelector('select:nth-of-type(1)');
                const aggSelect = div.querySelector('select:nth-of-type(2)');
                const formatInput = div.querySelector('input[type="text"]');
                const field = fieldSelect.value;
                const agg = aggSelect.value;
                const format = formatInput ? formatInput.value.trim() : '';
                
                if (field) {
                    columns.push({ 
                        field, 
                        agg, 
                        format,
                        label: `${field} (${agg.toUpperCase()})` 
                    });
                }
            });
            
            return columns;
        }
        
        function updatePivotTable() {
            const rowMainKey = controls.pivotRowMainSelect.value;
            const rowKeys = [controls.pivotRowSubSelect.value, controls.pivotRowLevel3Select.value, controls.pivotRowLevel4Select.value].filter(Boolean);
            const columns = getPivotColumns();
            const container = document.getElementById('pivotTableContainer');
            
            if (columns.length === 0) {
                container.innerHTML = '<p class="text-gray-500">è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ•¸æ“šæ¬„</p>';
                return;
            }
            
            // ç²å–ç¯©é¸å¾Œçš„æ•¸æ“š
            const activeFilters = getActiveFilters();
            console.log('[æ¨ç´è¡¨] activeFilters:', activeFilters); // Debug
            let filteredData = rawData.filter(d => {
                return allColumns.every(key => {
                    const filterValues = activeFilters[key];

                    if (filterValues === undefined) return true;
                    if (filterValues.length === 0) return false;
                    return filterValues.includes(String(d[key]));
                });
            });
            console.log('[æ¨ç´è¡¨] filteredData.length:', filteredData.length, '/ rawData.length:', rawData.length); // Debug
            
            // æ§‹å»ºè¡Œæ¨™ç±¤
            let rowLabels = [];

            // å¦‚æœæ²’æœ‰é¸æ“‡ä¸»è¦åˆ†çµ„ï¼Œå‰‡é¡¯ç¤ºç¸½è¨ˆ
            if (!rowMainKey) {
                rowLabels.push({ path: [{ key: 'ç¸½è¨ˆ', value: 'ç¸½è¨ˆ' }], isTotal: true });

                // ç”ŸæˆHTMLè¡¨æ ¼
                let html = '<table class="min-w-full border-collapse border border-gray-300">';

                // è¡¨é ­
                html += '<thead><tr class="bg-gray-100">';
                html += `<th class="border border-gray-300 px-3 py-2 text-left font-bold sticky left-0 bg-gray-100">åˆ†çµ„</th>`;
                html += `<th class="border border-gray-300 px-3 py-2 text-center font-medium bg-blue-50">ç­†æ•¸</th>`;
                columns.forEach(col => {
                    html += `<th class="border border-gray-300 px-3 py-2 text-center font-medium">${col.label}</th>`;
                });
                html += '</tr></thead>';

                // è¡¨èº«
                html += '<tbody><tr>';
                html += `<td class="border border-gray-300 px-3 py-2 font-medium bg-yellow-50 font-bold sticky left-0">ç¸½è¨ˆ</td>`;
                html += `<td class="border border-gray-300 px-3 py-2 text-right bg-yellow-50 bg-blue-50 font-medium">${filteredData.length}</td>`;

                columns.forEach(col => {
                    const value = calculateAggregation(filteredData, col.field, col.agg, col.format);
                    let displayValue;
                    if (col.agg === 'countx') {
                        displayValue = (value === null || value === undefined || isNaN(value)) ? '' : value.toFixed(2) + '%';
                    } else {
                        displayValue = formatValueWithCustomFormat(value, col.format);
                    }
                    html += `<td class="border border-gray-300 px-3 py-2 text-right bg-yellow-50">${displayValue}</td>`;
                });

                html += '</tr></tbody></table>';
                container.innerHTML = html;
                return;
            }


            // ç²å–æ’åºå¾Œçš„å”¯ä¸€å€¼
            const getSortedUniqueValues = (key, data) => {
                const values = [...new Set(data.map(d => d[key]))];
                if (CUSTOM_SORT_ORDERS[key]) {
                    values.sort((a, b) => getSortIndex(a, CUSTOM_SORT_ORDERS[key]) - getSortIndex(b, CUSTOM_SORT_ORDERS[key]));
                } else {
                    values.sort(smartSort);
                }
                return values;
            };

            // éè¿´å‡½æ•¸ä¾†å»ºç«‹å·¢ç‹€çµæ§‹
            function buildNestedRows(data, keys, level = 0, parentValues = []) {
                const currentKey = keys[level];
                const uniqueValues = getSortedUniqueValues(currentKey, data);

                uniqueValues.forEach(value => {
                    const currentPath = [...parentValues, { key: currentKey, value }];
                    const filteredForSubgroup = data.filter(d => String(d[currentKey]) === String(value));

                    // æ·»åŠ ç•¶å‰å±¤ç´šçš„ç¸½è¨ˆè¡Œ
                    rowLabels.push({ path: currentPath, isTotal: true });

                    if (keys[level + 1]) {
                        // å¦‚æœé‚„æœ‰ä¸‹ä¸€å±¤ï¼Œéè¿´
                        buildNestedRows(filteredForSubgroup, keys, level + 1, currentPath);
                    } else {
                        // é€™æ˜¯æœ€æ·±å±¤ï¼Œæ·»åŠ æ˜ç´°è¡Œ (é›–ç„¶é€™è£¡æ²’æœ‰æ›´ç´°çš„äº†ï¼Œä½†ä¿ç•™çµæ§‹)
                        // åœ¨é€™å€‹é‚è¼¯ä¸‹ï¼Œæœ€æ·±å±¤çš„ "Total" è¡Œå°±æ˜¯æ˜ç´°è¡Œ
                    }
                });
            }

            buildNestedRows(filteredData, [rowMainKey, ...rowKeys]);
            
            // ç”ŸæˆHTMLè¡¨æ ¼
            let html = '<table class="min-w-full border-collapse border border-gray-300">';

            // è¡¨é ­
            html += '<thead><tr class="bg-gray-100">';
            const headerLabel = [rowMainKey, ...rowKeys].join(' / ');
            html += `<th class="border border-gray-300 px-3 py-2 text-left font-bold sticky left-0 bg-gray-100">${headerLabel}</th>`;
            html += `<th class="border border-gray-300 px-3 py-2 text-center font-medium bg-blue-50">ç­†æ•¸</th>`;
            columns.forEach(col => {
                html += `<th class="border border-gray-300 px-3 py-2 text-center font-medium">${col.label}</th>`;
            });
            html += '</tr></thead>';
            
            // è¡¨èº«
            html += '<tbody>';
            rowLabels.forEach(row => {
                const level = row.path.length - 1; // 0-based level
                const label = row.path.map(p => String(p.value)).join('<br>'); // æ›è¡Œç–ŠåŠ é¡¯ç¤º
                const isMainTotal = level === 0; // åªæœ‰ç¬¬ä¸€å±¤æ˜¯é»ƒè‰²ç²—é«”

                html += '<tr>';
                const bgClass = isMainTotal ? 'bg-yellow-50 font-bold' : (level > 0 ? 'bg-gray-50' : 'bg-white');
                html += `<td class="border border-gray-300 px-3 py-2 font-medium ${bgClass} sticky left-0">${label}</td>`;
                
                // æ·»åŠ ç­†æ•¸æ¬„(ç§»åˆ°ç¬¬2æ¬„)
                let rowCount;
                let rowData = filteredData;
                row.path.forEach(p => {
                    rowData = rowData.filter(d => String(d[p.key]) === String(p.value));
                });
                rowCount = rowData.length;
                html += `<td class="border border-gray-300 px-3 py-2 text-right ${bgClass} bg-blue-50 font-medium">${rowCount}</td>`;
                
                columns.forEach(col => {
                    // è¨ˆç®—èšåˆå€¼
                    const value = calculateAggregation(rowData, col.field, col.agg, col.format);
                    
                    // Xå‡½æ•¸è¿”å›çš„æ˜¯ç™¾åˆ†æ¯”ï¼Œç›´æ¥æ·»åŠ %è™Ÿ
                    let displayValue;
                    if (col.agg === 'countx') {
                        displayValue = (value === null || value === undefined || isNaN(value)) ? '' : value.toFixed(2) + '%';
                    } else {
                        displayValue = formatValueWithCustomFormat(value, col.format);
                    }
                    
                    html += `<td class="border border-gray-300 px-3 py-2 text-right ${bgClass}">${displayValue}</td>`;
                });
                
                html += '</tr>';
            });
            html += '</tbody></table>';
            
            container.innerHTML = html;
        }
        
        // è¨ˆç®—èšåˆå€¼
        function calculateAggregation(data, field, aggFunc, format) {
            if (aggFunc === 'count') {
                return data.length;
            } else if (aggFunc === 'countunique') {
                return new Set(data.map(d => d[field])).size;
            } else if (aggFunc === 'countx') {
                // X = COUNT(X) / COUNTA Ã— 100%
                // Xçš„å€¼å¾formatåƒæ•¸ä¸­å–å¾—
                if (!format || format.trim() === '') {
                    return null; // æ²’æœ‰æŒ‡å®šXå€¼
                }
                
                const allValues = data.map(d => String(d[field]).trim());
                const totalCount = allValues.length; // COUNTA
                
                if (totalCount === 0) return null;
                
                // å¾formatä¸­æå–Xå€¼
                // æ”¯æ´ç›´æ¥è¼¸å…¥å€¼ï¼Œæˆ–å¾å¼•è™Ÿä¸­æå–
                let targetValue = format.trim();
                const quoteMatch = format.match(/"([^"]*)"/);
                if (quoteMatch) {
                    targetValue = quoteMatch[1];
                } else {
                    // ç§»é™¤å¸¸è¦‹çš„æ ¼å¼å­—ç¬¦ï¼Œåªä¿ç•™å€¼
                    targetValue = format.replace(/#|,|0|\.|%/g, '').trim();
                    // å¦‚æœé‚„æœ‰å¼•è™Ÿï¼Œç§»é™¤å®ƒ
                    targetValue = targetValue.replace(/["']/g, '');
                }
                
                if (targetValue === '') return null;
                
                // è¨ˆç®—åŒ¹é…çš„æ•¸é‡
                const matchCount = allValues.filter(v => v === targetValue).length;
                return (matchCount / totalCount) * 100; // è¿”å›ç™¾åˆ†æ¯”
            }
            
            // æå–æ•¸å€¼
            const values = data.map(d => parseFloat(d[field])).filter(v => !isNaN(v));
            if (values.length === 0) return null;
            
            switch(aggFunc) {
                case 'sum':
                    return values.reduce((a, b) => a + b, 0);
                case 'average':
                    return values.reduce((a, b) => a + b, 0) / values.length;
                case 'max':
                    return Math.max(...values);
                case 'min':
                    return Math.min(...values);
                case 'median':
                    const sorted = [...values].sort((a, b) => a - b);
                    const mid = Math.floor(sorted.length / 2);
                    return sorted.length % 2 === 0 ? (sorted[mid - 1] + sorted[mid]) / 2 : sorted[mid];
                case 'stdev':
                    const avg = values.reduce((a, b) => a + b, 0) / values.length;
                    const squareDiffs = values.map(v => Math.pow(v - avg, 2));
                    return Math.sqrt(squareDiffs.reduce((a, b) => a + b, 0) / (values.length - 1));
                case 'var':
                    const avgv = values.reduce((a, b) => a + b, 0) / values.length;
                    const squareDiffsv = values.map(v => Math.pow(v - avgv, 2));
                    return squareDiffsv.reduce((a, b) => a + b, 0) / (values.length - 1);
                default:
                    return values.length;
            }
        }
        
        // æ ¼å¼åŒ–é¡¯ç¤ºå€¼
        function formatValue(value) {
            if (value === null || value === undefined || isNaN(value)) return '';
            if (Number.isInteger(value)) return value;
            return value.toFixed(2);
        }
        
        // ä½¿ç”¨è‡ªè¨‚æ ¼å¼æ ¼å¼åŒ–æ•¸å€¼
        function formatValueWithCustomFormat(value, format) {
            if (value === null || value === undefined || isNaN(value)) return '';
            
            // å¦‚æœæ²’æœ‰è‡ªè¨‚æ ¼å¼ï¼Œä½¿ç”¨é è¨­æ ¼å¼
            if (!format) {
                return formatValue(value);
            }
            
            // è§£ææ ¼å¼å­—ä¸²
            // æ”¯æ´æ ¼å¼ï¼š#,##0 "å…ƒ"ã€0.00 "%"ã€æˆ–ç›´æ¥è¼¸å…¥å–®ä½
            
            let formattedNumber = '';
            let suffix = '';
            
            // æª¢æŸ¥æ˜¯å¦åŒ…å«å¼•è™Ÿï¼ˆå–®ä½ï¼‰
            const quoteMatch = format.match(/"([^"]*)"/);
            if (quoteMatch) {
                suffix = quoteMatch[1];
                format = format.replace(/"[^"]*"/, '').trim();
            } else if (format && !format.includes('#') && !format.includes('0') && !format.includes(',')) {
                // å¦‚æœæ ¼å¼åªæ˜¯ç´”æ–‡å­—ï¼ˆæ²’æœ‰#æˆ–0ï¼‰ï¼Œç›´æ¥ç•¶ä½œå–®ä½
                suffix = format;
                format = '';
            }
            
            // è™•ç†æ•¸å­—æ ¼å¼
            if (format.includes('#,##0') || format.includes(',')) {
                // åƒåˆ†ä½æ ¼å¼
                const decimals = (format.match(/\.0+/) || [''])[0].length - 1;
                if (decimals > 0) {
                    formattedNumber = value.toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                } else {
                    formattedNumber = Math.round(value).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                }
            } else if (format.includes('0.')) {
                // å°æ•¸æ ¼å¼
                const decimals = (format.match(/\.0+/) || [''])[0].length - 1;
                formattedNumber = value.toFixed(decimals);
            } else {
                // é è¨­æ ¼å¼
                formattedNumber = Number.isInteger(value) ? value.toString() : value.toFixed(2);
            }
            
            return formattedNumber + suffix;
        }

        // ** æ–°å¢ï¼šå–å¾—é¡è‰²çš„è¼”åŠ©å‡½æ•¸ (Sankey ä½¿ç”¨) **
        function getColorForValue(val, key) {
            const valStr = String(val).trim();
            const prefix = getQuestionPrefix(key); 
            
            // 1. å„ªå…ˆæª¢æŸ¥ (å•é¡Œå‰ç¶´ + é¸é …å€¼) çš„çµ„åˆ
            if (FIXED_ANSWER_COLORS[prefix + '_' + valStr]) {
                return FIXED_ANSWER_COLORS[prefix + '_' + valStr];
            }
            // 2. æ¥è‘—æª¢æŸ¥å–®ç´”çš„é¸é …å€¼
            if (FIXED_ANSWER_COLORS[valStr]) {
                return FIXED_ANSWER_COLORS[valStr];
            }
            
            // 3. éƒ½ä¸åŒ¹é…æ™‚ï¼Œä½¿ç”¨é›œæ¹¯å€¼å¾é¡åˆ¥èª¿è‰²ç›¤é¸è‰²
            let hash = 0;
            for (let i = 0; i < valStr.length; i++) {
                hash = valStr.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash) % CATEGORICAL_PALETTE.length;
            return CATEGORICAL_PALETTE[index];
        }
        
        function updateSankeyChart() {
            const sourceKey = controls.sankeySourceSelect.value;
            const targetKey = controls.sankeyTargetSelect.value;
            const intermediateKey = controls.sankeyIntermediateSelect.value; // ä¸­ç¹¼é»
            const minThreshold = parseInt(document.getElementById('sankeyMinThreshold').value) || 1;
            const sankeyContainer = d3.select("#sankeyChart");
            
            sankeyContainer.html(""); // æ¸…é™¤èˆŠåœ–è¡¨

            const sourceLegendContainer = document.getElementById('sankeySourceLegend');
            const intermediateLegendContainer = document.getElementById('sankeyIntermediateLegend');
            const targetLegendContainer = document.getElementById('sankeyTargetLegend');
            
            // æ¸…ç†èˆŠçš„ no-data æ¨™ç±¤
            if (sourceLegendContainer) sourceLegendContainer.querySelector('.sankey-no-data')?.remove();
            if (intermediateLegendContainer) intermediateLegendContainer.querySelector('.sankey-no-data')?.remove();
            if (targetLegendContainer) targetLegendContainer.querySelector('.sankey-no-data')?.remove();

            // é©—è­‰é‚è¼¯ï¼šå¿…é ˆæœ‰èµ·é»å’Œçµ‚é»ï¼Œä¸”ä¸èƒ½ç›¸åŒ
            if (!sourceKey || !targetKey || sourceKey === targetKey || (intermediateKey && (intermediateKey === sourceKey || intermediateKey === targetKey))) {
                sankeyContainer.html('<p class="text-gray-500 text-center py-8">è«‹é¸æ“‡æœ‰æ•ˆçš„ã€Œèµ·é»ã€ã€ã€Œä¸­ç¹¼é»ã€å’Œã€Œçµ‚é»ã€æ¬„ä½ï¼Œä¸”æ¬„ä½ä¸å¾—é‡è¤‡ã€‚</p>');
                // æ¸…ç©ºåœ–ä¾‹
                if (sourceLegendContainer) sourceLegendContainer.querySelector('.sankey-legend-items-wrapper')?.remove();
                if (intermediateLegendContainer) intermediateLegendContainer.querySelector('.sankey-legend-items-wrapper')?.remove();
                if (targetLegendContainer) targetLegendContainer.querySelector('.sankey-legend-items-wrapper')?.remove();
                document.getElementById('sourceLegendTitle').textContent = 'èµ·é»åœ–ä¾‹ (A)';
                document.getElementById('intermediateLegendTitle').textContent = 'ä¸­ç¹¼é»åœ–ä¾‹ (B)';
                document.getElementById('targetLegendTitle').textContent = 'çµ‚é»åœ–ä¾‹ (C)';
                return;
            }

            const activeFilters = getActiveFilters();
            let filteredData = rawData.filter(d => {
                return allColumns.every(key => {
                    const filterValues = activeFilters[key];
                    if (filterValues === undefined) return true;
                    if (filterValues.length === 0) return false;
                    return filterValues.includes(String(d[key]));
                });
            });

            if (filteredData.length === 0) {
                 sankeyContainer.html('<p class="text-red-500 text-center py-8">åœ¨ç•¶å‰ç¯©é¸æ¢ä»¶ä¸‹ï¼Œç„¡è³‡æ–™å¯ä¾›åˆ†æã€‚</p>');
                 if (sourceLegendContainer) sourceLegendContainer.querySelector('.sankey-legend-items-wrapper')?.remove();
                 if (intermediateLegendContainer) intermediateLegendContainer.querySelector('.sankey-legend-items-wrapper')?.remove();
                 if (targetLegendContainer) targetLegendContainer.querySelector('.sankey-legend-items-wrapper')?.remove();
                 return;
            }

            const linkCounts = new Map();
            const allNodes = new Set();
            
            filteredData.forEach(d => {
                const sourceVal = String(d[sourceKey]).trim();
                const targetVal = String(d[targetKey]).trim();
                
                if (intermediateKey) {
                    // A -> B -> C
                    const interVal = String(d[intermediateKey]).trim();
                    if (sourceVal && interVal && targetVal) {
                        // Link 1: Source -> Intermediate
                        const link1Id = `Source: ${sourceVal}->Intermediate: ${interVal}`;
                        linkCounts.set(link1Id, (linkCounts.get(link1Id) || 0) + 1);
                        
                        // Link 2: Intermediate -> Target
                        const link2Id = `Intermediate: ${interVal}->Target: ${targetVal}`;
                        linkCounts.set(link2Id, (linkCounts.get(link2Id) || 0) + 1);
                        
                        allNodes.add(`Source: ${sourceVal}`);
                        allNodes.add(`Intermediate: ${interVal}`);
                        allNodes.add(`Target: ${targetVal}`);
                    }
                } else {
                    // A -> C (Original)
                    if (sourceVal && targetVal) {
                        const linkId = `Source: ${sourceVal}->Target: ${targetVal}`;
                        linkCounts.set(linkId, (linkCounts.get(linkId) || 0) + 1);
                        allNodes.add(`Source: ${sourceVal}`);
                        allNodes.add(`Target: ${targetVal}`);
                    }
                }
            });

            const nodeMap = new Map();
            const nodes = Array.from(allNodes).map((name, index) => {
                const node = { id: index, name: name, category: name.split(': ')[0], value: 0 };
                nodeMap.set(name, node);
                return node;
            });

            const links = [];
            linkCounts.forEach((count, linkId) => {
                if (count >= minThreshold) {
                    const [sourceFull, targetFull] = linkId.split('->');
                    const sourceVal = sourceFull.split(': ')[1];
                    const targetVal = targetFull.split(': ')[1];
                    
                    if (nodeMap.has(sourceFull) && nodeMap.has(targetFull)) {
                        links.push({
                            source: nodeMap.get(sourceFull).id,
                            target: nodeMap.get(targetFull).id,
                            value: count,
                            sourceLabel: sourceVal,
                            targetLabel: targetVal,
                            sourceCategory: sourceFull.split(': ')[0] // ç”¨æ–¼é¡è‰²åˆ¤æ–·
                        });
                    }
                }
            });

            const graph = { nodes, links };
            
            const margin = { top: 10, right: 10, bottom: 10, left: 10 };
            const containerEl = document.getElementById('sankeyChart');
            const availableWidth = containerEl.clientWidth;
            const innerWidth = availableWidth - margin.left - margin.right;
            // æ ¹æ“šç¯€é»æ•¸é‡å‹•æ…‹èª¿æ•´é«˜åº¦ï¼Œå…¨è¢å¹•æ™‚å¯èƒ½éœ€è¦æ›´é«˜
            const isFullScreen = document.getElementById('sankeyContentArea').classList.contains('fixed');
            const baseHeight = isFullScreen ? window.innerHeight - 300 : Math.min(nodes.length * 25 + 100, 600);
            const height = Math.max(baseHeight, 400) - margin.top - margin.bottom;
            
            const svgWidth = availableWidth; 
            const svgHeight = height + margin.top + margin.bottom;

            const svg = sankeyContainer.append("svg")
                .attr("width", svgWidth) 
                .attr("height", svgHeight)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");



            const sortNodesByCustomOrder = (a, b) => {
                const aName = a.name.split(': ')[1];
                const bName = b.name.split(': ')[1];
                
                let key;
                if (a.category === 'Source') key = sourceKey;
                else if (a.category === 'Intermediate') key = intermediateKey;
                else key = targetKey;
                
                const customOrder = CUSTOM_SORT_ORDERS[key];

                if (customOrder) {
                    return getSortIndex(aName, customOrder) - getSortIndex(bName, customOrder);
                }
                return smartSort(aName, bName);
            };

            const sankey = d3.sankey()
                .nodeWidth(15)
                .nodePadding(10)
                .extent([[0, 0], [innerWidth, height]])
                .nodeSort(sortNodesByCustomOrder);

            sankey(graph);
            
            svg.append("g")
                .attr("fill", "none")
                .selectAll(".sankey-link")
                .data(graph.links)
                .join("path")
                .attr("class", "sankey-link")
                .attr("d", d3.sankeyLinkHorizontal())
                .attr("stroke-width", d => Math.max(1, d.width))
                .attr("stroke", d => {
                    // é€£çµé¡è‰²è·Ÿéš¨ä¾†æºç¯€é»
                    const key = d.sourceCategory === 'Source' ? sourceKey : intermediateKey;
                    return getColorForValue(d.sourceLabel, key);
                })
                .append("title")
                .text(d => `${d.sourceLabel} â†’ ${d.targetLabel}\nç­†æ•¸: ${d.value}`);

            const node = svg.append("g")
                .selectAll(".sankey-node")
                .data(graph.nodes)
                .join("g")
                .attr("class", "sankey-node")
                .attr("transform", d => `translate(${d.x0},${d.y0})`);

            node.append("rect")
                .attr("height", d => d.y1 - d.y0)
                .attr("width", sankey.nodeWidth())
                .attr("rx", 4)
                .attr("ry", 4)
                .attr("fill", d => {
                    const value = d.name.split(': ')[1];
                    let key;
                    if (d.category === 'Source') key = sourceKey;
                    else if (d.category === 'Intermediate') key = intermediateKey;
                    else key = targetKey;
                    return getColorForValue(value, key);
                })
                .each(function(d) {
                    d.value = d.sourceLinks.reduce((sum, link) => sum + link.value, 0) || d.targetLinks.reduce((sum, link) => sum + link.value, 0);
                })
                .append("title")
                .text(d => {
                    const val = d.sourceLinks.reduce((sum, link) => sum + link.value, 0) || d.targetLinks.reduce((sum, link) => sum + link.value, 0);
                    return `${d.name.split(': ')[1]}\nç¸½ç­†æ•¸: ${val}`
                });

            // ç”Ÿæˆåœ–ä¾‹
            if (links.length > 0) {
                 generateSankeyLegend(graph.nodes, sourceKey, 'Source'); 
                 if (intermediateKey) generateSankeyLegend(graph.nodes, intermediateKey, 'Intermediate');
                 else {
                     // æ¸…é™¤ä¸­ç¹¼é»åœ–ä¾‹
                     if (intermediateLegendContainer) intermediateLegendContainer.querySelector('.sankey-legend-items-wrapper')?.remove();
                     document.getElementById('intermediateLegendTitle').textContent = 'ä¸­ç¹¼é»åœ–ä¾‹ (B)';
                 }
                 generateSankeyLegend(graph.nodes, targetKey, 'Target');
            } else {
                // No Data Handling
                [sourceLegendContainer, intermediateLegendContainer, targetLegendContainer].forEach(container => {
                    if (container) container.querySelector('.sankey-legend-items-wrapper')?.remove();
                });
                
                const noDataMsg = 'ç„¡é€£çµè³‡æ–™ã€‚';
                if (sourceLegendContainer) {
                    const p = document.createElement('p'); p.className = 'text-gray-400 sankey-no-data'; p.textContent = noDataMsg;
                    document.getElementById('sourceLegendTitle').after(p);
                }
                // ... (Simplified for brevity, logic is similar)
            }
        }

        // ** æ–°å¢ï¼šå…¨è¢å¹•åˆ‡æ›å‡½æ•¸ **
        function toggleSankeyFullScreen() {
            const contentArea = document.getElementById('sankeyContentArea');
            const fullScreenBtn = document.getElementById('sankeyFullScreenBtn');
            const exitBtn = document.getElementById('exitSankeyFullScreenBtn');
            const isFullScreen = contentArea.classList.contains('fixed');

            if (!isFullScreen) {
                // Enter Full Screen
                contentArea.classList.add('fixed', 'inset-0', 'z-50', 'bg-gray-100', 'overflow-auto', 'p-8');
                fullScreenBtn.innerHTML = '<i class="fas fa-compress mr-1"></i> é€€å‡ºå…¨è¢å¹•';
                fullScreenBtn.classList.replace('bg-blue-600', 'bg-red-600');
                fullScreenBtn.classList.replace('hover:bg-blue-700', 'hover:bg-red-700');
                
                if(exitBtn) exitBtn.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            } else {
                // Exit Full Screen
                contentArea.classList.remove('fixed', 'inset-0', 'z-50', 'bg-gray-100', 'overflow-auto', 'p-8');
                fullScreenBtn.innerHTML = '<i class="fas fa-expand mr-1"></i> å…¨è¢å¹•æ¨¡å¼';
                fullScreenBtn.classList.replace('bg-red-600', 'bg-blue-600');
                fullScreenBtn.classList.replace('hover:bg-red-700', 'hover:bg-blue-700');
                
                if(exitBtn) exitBtn.classList.add('hidden');
                document.body.style.overflow = '';
            }
            
            // Trigger resize to update chart dimensions
            // å»¶é²ä¸€é»é»ä»¥ç¢ºä¿ DOM æ›´æ–°å®Œæˆ
            setTimeout(updateSankeyChart, 100);
        }

        // ** ä¿®æ”¹ï¼šåœ–ä¾‹ç”Ÿæˆå‡½æ•¸ä»¥æ”¯æ´ä¸‰ç¨®ç‹€æ…‹ **
        function generateSankeyLegend(nodes, key, category) {
            let legendContainerId, legendTitleId, titleText;
            if (category === 'Source') {
                legendContainerId = 'sankeySourceLegend';
                legendTitleId = 'sourceLegendTitle';
                titleText = 'èµ·é»åœ–ä¾‹ (A)';
            } else if (category === 'Intermediate') {
                legendContainerId = 'sankeyIntermediateLegend';
                legendTitleId = 'intermediateLegendTitle';
                titleText = 'ä¸­ç¹¼é»åœ–ä¾‹ (B)';
            } else {
                legendContainerId = 'sankeyTargetLegend';
                legendTitleId = 'targetLegendTitle';
                titleText = 'çµ‚é»åœ–ä¾‹ (C)';
            }

            const legendContainer = document.getElementById(legendContainerId);
            const legendTitle = document.getElementById(legendTitleId);
            
            if (!legendContainer || !legendTitle) return;

            let itemsContainer = legendContainer.querySelector('.sankey-legend-items-wrapper');
            if (!itemsContainer) {
                itemsContainer = document.createElement('div');
                itemsContainer.className = `sankey-legend-items-wrapper flex flex-wrap gap-x-4 gap-y-1 justify-start`;
                const oldNoData = legendContainer.querySelector('.sankey-no-data');
                if (oldNoData) oldNoData.remove();
                legendTitle.after(itemsContainer);
            }
            
            itemsContainer.innerHTML = ''; 
            legendTitle.textContent = `${QUESTION_MAP[key] || key} ${titleText.substring(titleText.indexOf('('))}`;


            const customOrder = CUSTOM_SORT_ORDERS[key];
            const sortedNodes = [...nodes].sort((a, b) => {
                const valA = a.name.split(': ')[1];
                const valB = b.name.split(': ')[1];
                
                if (a.category !== category && b.category !== category) return 0;
                
                if (customOrder) {
                    return getSortIndex(valA, customOrder) - getSortIndex(valB, customOrder);
                }
                return smartSort(valA, valB);
            });

            const sideNodes = sortedNodes.filter(d => d.category === category);
            
            if (sideNodes.length === 0) {
                 const p = document.createElement('p');
                 p.className = 'text-gray-400 sankey-no-data';
                 p.textContent = 'ç„¡åœ–ä¾‹è³‡æ–™ã€‚';
                 itemsContainer.appendChild(p);
                 return;
            }
            
            sideNodes.forEach(node => {
                const value = node.name.split(': ')[1];
                const color = getColorForValue(value, key); 
                
                const itemDiv = document.createElement('div');
                itemDiv.className = `flex items-center sankey-legend-item justify-start`;
                
                const textSpan = document.createElement('span');
                textSpan.textContent = `${value}`;
                textSpan.className = 'text-sm';

                const colorBlock = `<span class="w-3 h-3 mx-1 flex-shrink-0" style="background-color: ${color}; border-radius: 2px;"></span>`;

                itemDiv.innerHTML = colorBlock + textSpan.outerHTML;
                itemsContainer.appendChild(itemDiv);
            });
        }


        // ===============================================
        // == å–®ä¸€æ¬„ä½åˆ†æ (å„€è¡¨æ¿) å‡½æ•¸ ==
        // ===============================================

        // ** ä¿®æ­£ 3.0: æ›´æ–°æ‰€æœ‰å°åœ–è¡¨è¨­å®šçš„å‡½æ•¸ (åŠ å…¥ forceUpdate åƒæ•¸) **
        function updateSmallMultiplesSettings(forceUpdate = false) {
            // ** ä¿®æ­£ 1: ç¢ºä¿æ‰€æœ‰é¸é …åœ¨ Chart.js å¯¦ä¾‹ä¸Šè¢«æ›´æ–° **
            Object.values(smallCharts).forEach(chartInstance => {
                chartInstance.options.scales.y.barPercentage = BAR_PERCENTAGE;
                chartInstance.options.scales.y.categoryPercentage = BAR_CATEGORY_PERCENTAGE;
                chartInstance.options.plugins.datalabels.font.size = DATALABELS_FONT_SIZE;
                chartInstance.update('none'); // å¼ºåˆ¶æ›´æ–°è§†å›¾
            });
            
            // ** ä¿®æ­£ 4.1: å¦‚æœæ˜¯ BAR ç²—åº¦èª¿æ•´ï¼Œéœ€è¦é‡æ–°å‰µå»º/ç¹ªè£½åœ–è¡¨å®¹å™¨ **
            if (forceUpdate) {
                // é‡æ–°èª¿ç”¨ updateSmallMultiples é‡æ–°ç¹ªè£½æ•´å€‹å€å¡Šï¼Œ
                // é€™æœƒé‡æ–°è¨ˆç®—æ¯å€‹å°åœ–è¡¨çš„ wrapperHeightã€‚
                updateSmallMultiples();
                return;
            }
        }
        
        function updateSmallMultiples() {
            const container = document.getElementById('smallMultiplesContainer');
            const selectedColumns = Array.from(document.querySelectorAll('.small-multiple-checkbox:checked')).map(cb => cb.value);
            // ** ä¿®æ­£ 2ï¼šè®€å–ç¨ç«‹çš„ valueSelect **
            const valueType = controls.smallValueSelect.value;
            const isPercent = valueType === 'percent';

            // æŠ“å–å…±ç”¨ç¯©é¸
            const activeFilters = getActiveFilters();
            let filteredData = rawData.filter(d => {
                return allColumns.every(key => {
                    const filterValues = activeFilters[key];
                    if (filterValues === undefined) return true;
                    if (filterValues.length === 0) return false;
                    return filterValues.includes(String(d[key]));
                });
            });

            // æ‘§æ¯€èˆŠåœ–è¡¨
            Object.values(smallCharts).forEach(chart => chart.destroy());
            smallCharts = {};
            container.innerHTML = '';

            if (selectedColumns.length === 0) {
                container.innerHTML = '<p class="text-gray-500">è«‹å¾ä¸Šæ–¹å‹¾é¸æ¬„ä½ä»¥é¡¯ç¤ºåˆ†æåœ–è¡¨ã€‚</p>';
                return;
            }
            

            
            // ** ä¿®æ­£ 5.0: ä½¿ç”¨å›ºå®šåƒç´ é«˜åº¦ **
            // ç›´æ¥ä½¿ç”¨ SMALL_CHART_BAR_HEIGHT ä½œç‚ºBARçš„å¯¦éš›é«˜åº¦
            const chartAreaHeight = SMALL_CHART_BAR_HEIGHT + 10; // BARé«˜åº¦ + ä¸Šä¸‹ç•™ç™½
            // æ•´é«” wrapper çš„é«˜åº¦ = åœ–è¡¨å€ + Xè»¸åˆ»åº¦ (35px) + ä¸Šä¸‹ padding/margin (5px)
            const headerHeight = 30; // ç‚ºæ¨™é¡Œå’Œåœ–ä¾‹é ç•™ 30px çš„ç©ºé–“
            const wrapperHeight = chartAreaHeight + 35 + 5 + headerHeight; 

            // ç‚ºæ¯ä¸€å€‹å‹¾é¸çš„æ¬„ä½å»ºç«‹ä¸€å€‹åœ–è¡¨
            selectedColumns.forEach((colKey, index) => {
                const chartId = `smallChart-${index}`;
                const legendId = `smallLegend-${index}`;
                const avgId = `smallAvg-${index}`;

                // 2. æº–å‚™è³‡æ–™
                const yLabels = [colKey]; 
                let groupLabels = [...new Set(filteredData.map(d => d[colKey]))];
                
                if (CUSTOM_SORT_ORDERS[colKey]) groupLabels.sort((a, b) => getSortIndex(a, CUSTOM_SORT_ORDERS[colKey]) - getSortIndex(b, CUSTOM_SORT_ORDERS[colKey]));
                else groupLabels.sort(smartSort);

                let isGroupKeyNumeric = false;
                if (filteredData.length > 0) {
                    const firstValue = filteredData.find(d => d[colKey] !== null && d[colKey] !== undefined);
                    if(firstValue) isGroupKeyNumeric = parseNumericValue(firstValue[colKey]).isNumeric;
                }

                // ** é¡è‰²æ˜ å°„é‚è¼¯ (èˆ‡ä¸»åœ–è¡¨ä¸€è‡´) **
                let activePalette;
                if (isGroupKeyNumeric && groupLabels.length > 3) activePalette = GRADIENT_PALETTE; 
                else activePalette = CATEGORICAL_PALETTE;
                
                let colorMap = {};
                let paletteIndex = 0;
                groupLabels.forEach((val) => {
                    const valStr = String(val).trim();
                    const prefix = getQuestionPrefix(colKey);
                    
                    const keyedColor = FIXED_ANSWER_COLORS[prefix + '_' + valStr]; 
                    if (keyedColor) {
                        colorMap[String(val)] = keyedColor;
                    } else if (FIXED_ANSWER_COLORS[valStr]) {
                        colorMap[String(val)] = FIXED_ANSWER_COLORS[valStr];
                    } else {
                        colorMap[String(val)] = activePalette[paletteIndex % activePalette.length]; 
                        paletteIndex++;
                    }
                });

                const total = filteredData.filter(d => d[colKey] !== undefined && d[colKey] !== null).length;
                const totalForPercent = total > 0 ? total : 1;
                
                const datasets = groupLabels.map(groupVal => {
                    const count = filteredData.filter(d => String(d[colKey]) === String(groupVal)).length;
                    const dataValue = isPercent ? (count / totalForPercent) * 100 : count;
                    // ** ä¿®æ­£ï¼šç›´æ¥èª¿ç”¨ getColorForValue ç¢ºä¿é¡è‰²å›ºå®š **
                    const color = getColorForValue(groupVal, colKey);
                    return {
                        label: groupVal,
                        data: [dataValue], // åªæœ‰ä¸€ç­†è³‡æ–™
                        backgroundColor: color + 'CC', 
                        borderColor: color, 
                        borderWidth: 0, 
                        borderRadius: 0, 
                        rawCount: count // å„²å­˜åŸå§‹ç­†æ•¸çµ¦ tooltip
        };
                });


                // 1. å»ºç«‹ HTML çµæ§‹ (å„ªåŒ–æ’ç‰ˆ)
                const chartWrapper = document.createElement('div');
                chartWrapper.className = 'bg-white pt-2 pb-1 px-4'; // æ¸›å°‘å‚ç›´ padding
                if (index > 0) {
                    chartWrapper.className += ' border-t border-gray-200'; 
                }
                
                // æ¨™é¡Œ/å¹³å‡æ•¸/åœ–ä¾‹ æ•´åˆåœ¨ä¸€å€‹ flex å®¹å™¨ä¸­
                chartWrapper.innerHTML = `
                    <div class="small-chart-header flex gap-4 pt-1">
                        <div class="w-2/5 flex items-baseline space-x-2">
                            <h3 class="text-base font-bold text-gray-800 leading-none">${colKey}</h3>
                            <span id="${avgId}" class="text-sm font-medium text-blue-700 leading-none whitespace-nowrap"></span>
                        </div>
                        <div id="${legendId}" class="w-3/5 flex flex-wrap gap-x-2 gap-y-0.5 justify-end"></div>
                    </div>
                    <!-- ä¿®æ­£ï¼šå°‡ chartAreaHeight å¯«å…¥ï¼Œç¢ºä¿é«˜åº¦ç·Šæ¹Š -->
                    <div class="small-chart-container" style="height: ${wrapperHeight}px;">
                        <canvas id="${chartId}"></canvas>
                    </div>
                `;
                container.appendChild(chartWrapper);

                // 3. å»ºç«‹æ–°åœ–è¡¨ (é•·æ¢åœ–)
                const ctx = document.getElementById(chartId).getContext('2d');
                smallCharts[chartId] = new Chart(ctx, {
                    type: 'bar', 
                    data: { 
                        labels: yLabels, 
                        datasets: datasets 
                    },
                    options: {
                        indexAxis: 'y', 
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: { 
                            padding: { left: -10 } // éš±è— Y è»¸æ¨™ç±¤
                        }, 
                        scales: {
                            x: {
                                display: true,
                                stacked: true,
                                max: isPercent ? 100 : undefined,
                                // ä¿®æ­£ 2.1: éš±è— X è»¸æ¨™é¡Œï¼Œä½†é¡¯ç¤ºåˆ»åº¦æ•¸å­— (ticks)
                                ticks: {
                                    display: true, 
                                    font: { size: 10 }
                                },
                                title: { 
                                    display: false // éš±è—è»¸æ¨™é¡Œ
                                }
                            },
                            y: {
                                stacked: true,
                                display: false, // éš±è— Y è»¸
                                barPercentage: 1.0, // å¡«æ»¿æ•´å€‹categoryç©ºé–“
                                categoryPercentage: 1.0 // å¡«æ»¿æ•´å€‹è»¸ç©ºé–“
                            }
                        },
                        plugins: {
                            datalabels: {
                                display: true, 
                                color: '#fff',
                                textShadow: '0 1px 2px rgba(0,0,0,0.4)',
                                font: { weight: 'bold', size: DATALABELS_FONT_SIZE },
                                formatter: (value, context) => {
                                    if (value === 0) return ''; 
                                    
                                    if (isPercent) {
                                        if (value < 8) return ''; 
                                        return Math.round(value) + '%';
                                    } else {
                                        const allData = context.chart.data.datasets.map(ds => ds.data[0]);
                                        const total = allData.reduce((sum, val) => sum + val, 0);
                                        if (total > 0 && (value / total) < 0.08) return ''; 
                                        return value; 
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';
                                        const rawCount = context.dataset.rawCount || 0;
                                        if (isPercent) {
                                            if (context.parsed.x !== null) label += context.parsed.x.toFixed(1) + '%';
                                            label += ` (${rawCount}ç­†)`;
                                        } else {
                                            if (context.parsed.x !== null) label += context.parsed.x;
                                        }
                                        return label;
                                    }
                                }
                            },
                            legend: { display: false } // ä½¿ç”¨è‡ªè¨‚åœ–ä¾‹
                        }
                    }
                });

                // 4. å¡«å…¥åœ–ä¾‹ - æ·»åŠ é»æ“Šéš±è—åŠŸèƒ½
                const legendContainer = document.getElementById(legendId);
                let legendHTML = '';
                datasets.forEach((dataset, index) => { 
                    const label = dataset.label;
                    const color = dataset.borderColor;
                    const isHidden = dataset.hidden || false;
                    legendHTML += `<div class="flex items-center legend-item ${isHidden ? 'legend-item-hidden' : ''}" data-dataset-index="${index}">
                                     <span class="w-3 h-3 mr-1 flex-shrink-0" style="background-color: ${color}; border-radius: 2px;"></span>
                                     <span class="text-xs text-gray-700">${label}</span>
                                   </div>`; // åœ–ä¾‹æ–‡å­—ç¸®å°ç‚º text-xs
                });
                legendContainer.innerHTML = legendHTML;
                
                // æ·»åŠ é»æ“Šäº‹ä»¶ä¾†éš±è—/é¡¯ç¤ºdataset
                const chart = smallCharts[chartId];
                legendContainer.querySelectorAll('.legend-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const datasetIndex = parseInt(item.getAttribute('data-dataset-index'));
                        if (!chart || isNaN(datasetIndex) || datasetIndex < 0 || datasetIndex >= chart.data.datasets.length) return;
                        chart.data.datasets[datasetIndex].hidden = !chart.data.datasets[datasetIndex].hidden;
                        item.classList.toggle('legend-item-hidden', chart.data.datasets[datasetIndex].hidden);
                        chart.update();
                    });
                });

                
                // 5. é‚„åŸå¹³å‡æ•¸è¨ˆç®—
                if (isGroupKeyNumeric) {
                    let numericData = filteredData
                        .map(d => parseNumericValue(d[colKey]))
                        .filter(val => val.isNumeric)
                        .map(val => val.num);
                    if (numericData.length > 0) {
                        const sum = numericData.reduce((a, b) => a + b, 0);
                        const average = sum / numericData.length;
                        document.getElementById(avgId).textContent = `å¹³å‡æ•¸: ${average.toFixed(1)}`;
                    }
                }
            });
        }
        
        // ** æ–°å¢ Q2ï¼šå–®æ¬„åˆ†ææˆªåœ–å‡½æ•¸ **
        async function downloadScreenshot() {
            const statusEl = document.getElementById('sm-screenshot-status');
            const buttonEl = document.getElementById('sm-download-screenshot');
            // ** ä¿®æ­£ï¼šåªæ“·å–åœ–è¡¨å®¹å™¨ **
            const targetEl = document.getElementById('smallMultiplesContainer'); 
            
            if (!targetEl) return;
            
            // ** æ–°å¢ï¼šæª¢æŸ¥æ˜¯å¦æœ‰åœ–è¡¨ **
            if (targetEl.children.length === 0 || (targetEl.children.length === 1 && targetEl.children[0].tagName === 'P')) {
                statusEl.textContent = 'æ²’æœ‰åœ–è¡¨å¯ä¾›æ“·å–ã€‚';
                statusEl.classList.remove('hidden');
                setTimeout(() => statusEl.classList.add('hidden'), 2000);
                return;
            }

            statusEl.textContent = 'æ­£åœ¨ç”¢ç”Ÿæˆªåœ–... è«‹ç¨å€™...';
            statusEl.classList.remove('hidden');
            buttonEl.disabled = true;

            try {
                const canvas = await html2canvas(targetEl, {
                    useCORS: true, // å…è¨±è·¨åŸŸåœ–ç‰‡ (é›–ç„¶æˆ‘å€‘æ²’æœ‰)
                    scale: 2 // æé«˜è§£æåº¦
                });
                
                const dataUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = 'smallmultiples-screenshot.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                statusEl.textContent = 'æˆªåœ–å·²ä¸‹è¼‰ï¼';
                setTimeout(() => statusEl.classList.add('hidden'), 2000);

            } catch (error) {
                console.error('æˆªåœ–å¤±æ•—:', error);
                statusEl.textContent = 'æˆªåœ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ consoleã€‚';
            } finally {
                buttonEl.disabled = false;
            }
        }

        // ** æ–°å¢ï¼šæ¨ç´åˆ†ææˆªåœ–å‡½æ•¸ **
        async function downloadPivotScreenshot() {
            const statusEl = document.getElementById('pivot-screenshot-status');
            const buttonEl = document.getElementById('pivot-download-screenshot');
            // æ“·å–æ•´å€‹æ¨ç´åœ–è¡¨åˆ†æå€åŸŸï¼ˆåŒ…å«æ¨™é¡Œã€åœ–ä¾‹ã€åœ–è¡¨ï¼‰
            const targetEl = document.getElementById('pivotChartContainer').parentElement;
            
            if (!targetEl) return;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰åœ–è¡¨
            if (!chart || !chart.data || chart.data.labels.length === 0) {
                statusEl.textContent = 'æ²’æœ‰åœ–è¡¨å¯ä¾›æ“·å–ã€‚';
                statusEl.classList.remove('hidden');
                setTimeout(() => statusEl.classList.add('hidden'), 2000);
                return;
            }

            statusEl.textContent = 'æ­£åœ¨ç”¢ç”Ÿæˆªåœ–... è«‹ç¨å€™...';
            statusEl.classList.remove('hidden');
            buttonEl.disabled = true;

            try {
                const canvas = await html2canvas(targetEl, {
                    useCORS: true,
                    scale: 2 // æé«˜è§£æåº¦
                });
                
                const dataUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = 'pivot-chart-screenshot.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                statusEl.textContent = 'æˆªåœ–å·²ä¸‹è¼‰ï¼';
                setTimeout(() => statusEl.classList.add('hidden'), 2000);

            } catch (error) {
                console.error('æˆªåœ–å¤±æ•—:', error);
                statusEl.textContent = 'æˆªåœ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ consoleã€‚';
            } finally {
                buttonEl.disabled = false;
            }
        }
        
        // ** æ–°å¢ï¼šåŒ¯å‡ºæ¨ç´åˆ†æç‚º CSV **
        function exportPivotToCSV() {
            const yKey = controls.yAxisSelect.value;
            const groupKey = controls.colorBySelect.value;
            const subGroupKey = controls.subGroupSelect.value;
            
            if (!yKey) {
                alert('è«‹å…ˆé¸æ“‡ Y è»¸æ¬„ä½');
                return;
            }
            
            const activeFilters = getActiveFilters();
            let filteredData = rawData.filter(d => {
                return allColumns.every(key => {
                    const filterValues = activeFilters[key];
                    if (filterValues === undefined) return true;
                    if (filterValues.length === 0) return false;
                    return filterValues.includes(String(d[key]));
                });
            });
            
            if (filteredData.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
                return;
            }
            
            let csvContent = '\uFEFF'; // UTF-8 BOM
            let headers = [yKey];
            if (subGroupKey) headers.push(subGroupKey);
            if (groupKey !== 'none') {
                const groupLabels = [...new Set(filteredData.map(d => d[groupKey]))];
                headers.push(...groupLabels);
            }
            headers.push('ç¸½è¨ˆ');
            csvContent += headers.map(h => `"${h}"`).join(',') + '\n';
            
            const yLabels = [...new Set(filteredData.map(d => d[yKey]))];
            yLabels.forEach(yVal => {
                let row = [`"${yVal}"`];
                if (groupKey !== 'none') {
                    const groupLabels = [...new Set(filteredData.map(d => d[groupKey]))];
                    groupLabels.forEach(gVal => {
                        const count = filteredData.filter(d => 
                            String(d[yKey]) === String(yVal) && 
                            String(d[groupKey]) === String(gVal)
                        ).length;
                        row.push(count);
                    });
                }
                const total = filteredData.filter(d => String(d[yKey]) === String(yVal)).length;
                row.push(total);
                csvContent += row.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `pivot-analysis-${yKey}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ** æ–°å¢ï¼šæ·»åŠ å…¨éƒ¨æ•¸æ“šæ¬„ä½åˆ°æ¨ç´è¡¨ **
        function addAllPivotColumns() {
            const pivotColumnsContainer = document.getElementById('pivotColumnsContainer');
            controls.pivotColumns = [];
            pivotColumnsContainer.innerHTML = '';
            allColumns.forEach(colKey => {
                addPivotColumnField(colKey);
            });
            // å»¶é²æ›´æ–°ï¼Œç¢ºä¿æ‰€æœ‰æ¬„ä½éƒ½å·²æ·»åŠ 
            setTimeout(() => updatePivotTable(), 100);
        }
        
        // ** æ–°å¢ï¼šåŒ¯å‡ºæ¨ç´åœ–è¡¨åˆ†æç‚º CSV **
        function exportPivotTableToCSV() {
            const rowMainKey = controls.pivotRowMainSelect.value;
            const rowSubKey = controls.pivotRowSubSelect.value;
            const columns = getPivotColumns();
            
            if (!rowMainKey || columns.length === 0) {
                alert('è«‹å…ˆé¸æ“‡ä¸»è¦åˆ—å’Œè‡³å°‘ä¸€å€‹æ•¸æ“šæ¬„');
                return;
            }
            
            const activeFilters = getActiveFilters();
            let filteredData = rawData.filter(d => {
                return allColumns.every(key => {
                    const filterValues = activeFilters[key];
                    if (filterValues === undefined) return true;
                    if (filterValues.length === 0) return false;
                    return filterValues.includes(String(d[key]));
                });
            });
            
            if (filteredData.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
                return;
            }
            
            let csvContent = '\uFEFF'; // UTF-8 BOM
            
            // è¡¨é ­
            let headers = [rowMainKey + (rowSubKey ? ' / ' + rowSubKey : ''), 'ç­†æ•¸'];
            columns.forEach(col => headers.push(col.label || `${col.field} (${col.agg})`));
            csvContent += headers.map(h => `"${h}"`).join(',') + '\n';
            
            // æ§‹å»ºè¡Œæ¨™ç±¤ (èˆ‡ updatePivotTable é‚è¼¯ä¿æŒä¸€è‡´)
            const mainValues = [...new Set(filteredData.map(d => d[rowMainKey]))];
            if (CUSTOM_SORT_ORDERS[rowMainKey]) {
                mainValues.sort((a, b) => getSortIndex(a, CUSTOM_SORT_ORDERS[rowMainKey]) - getSortIndex(b, CUSTOM_SORT_ORDERS[rowMainKey]));
            } else {
                mainValues.sort(smartSort);
            }
            
            let rowLabels = [];
            if (rowSubKey) {
                const subValues = [...new Set(filteredData.map(d => d[rowSubKey]))];
                if (CUSTOM_SORT_ORDERS[rowSubKey]) {
                    subValues.sort((a, b) => getSortIndex(a, CUSTOM_SORT_ORDERS[rowSubKey]) - getSortIndex(b, CUSTOM_SORT_ORDERS[rowSubKey]));
                } else {
                    subValues.sort(smartSort);
                }
                mainValues.forEach(main => {
                    rowLabels.push({ main, sub: null, label: String(main), isTotal: true });
                    subValues.forEach(sub => {
                        const hasData = filteredData.some(d => 
                            String(d[rowMainKey]) === String(main) && 
                            String(d[rowSubKey]) === String(sub)
                        );
                        if (hasData) {
                            rowLabels.push({ main, sub, label: `  ${main}-${sub}`, isTotal: false });
                        }
                    });
                });
            } else {
                rowLabels = mainValues.map(main => ({ main, sub: null, label: String(main), isTotal: false }));
            }
            
            // æ•¸æ“šè¡Œ
            rowLabels.forEach(row => {
                let rowData = [`"${row.label}"`];
                
                // ç­†æ•¸
                let rowCount;
                if (rowSubKey && !row.isTotal) {
                    rowCount = filteredData.filter(d => 
                        String(d[rowMainKey]) === String(row.main) && 
                        String(d[rowSubKey]) === String(row.sub)
                    ).length;
                } else {
                    rowCount = filteredData.filter(d => String(d[rowMainKey]) === String(row.main)).length;
                }
                rowData.push(rowCount);
                
                // å„æ¬„æ•¸æ“š
                columns.forEach(col => {
                    let cellData;
                    if (rowSubKey && !row.isTotal) {
                        cellData = filteredData.filter(d => 
                            String(d[rowMainKey]) === String(row.main) && 
                            String(d[rowSubKey]) === String(row.sub)
                        );
                    } else {
                        cellData = filteredData.filter(d => String(d[rowMainKey]) === String(row.main));
                    }
                    
                    let value = 0;
                    if (col.aggregation === 'COUNT') {
                        value = cellData.filter(d => d[col.field] !== null && d[col.field] !== undefined && d[col.field] !== '').length;
                    } else if (col.aggregation === 'SUM') {
                        value = cellData.reduce((sum, d) => sum + (parseFloat(d[col.field]) || 0), 0);
                    } else if (col.aggregation === 'AVG') {
                        const nums = cellData.map(d => parseFloat(d[col.field])).filter(n => !isNaN(n));
                        value = nums.length > 0 ? nums.reduce((a, b) => a + b, 0) / nums.length : 0;
                    }
                    rowData.push(value);
                });
                
                csvContent += rowData.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `pivot-table-${rowMainKey}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ** æ–°å¢ï¼šæ·»åŠ å…¨éƒ¨æ¬„ä½åˆ°æ¨ç´åœ–è¡¨åˆ†æ **
        function addAllPivotTableColumns() {
            const pivotColumnsContainer = document.getElementById('pivotColumnsContainer');
            controls.pivotColumns = [];
            pivotColumnsContainer.innerHTML = '';
            allColumns.forEach(colKey => {
                addPivotColumnField(colKey);
            });
            // å»¶é²æ›´æ–°ï¼Œç¢ºä¿æ‰€æœ‰æ¬„ä½éƒ½å·²æ·»åŠ 
            setTimeout(() => updatePivotTable(), 100);
        }
        
        // æ¨ç´åˆ†æè¡¨æ ¼æˆªåœ–å‡½æ•¸
        async function downloadPivotTableScreenshot() {
            const statusEl = document.getElementById('pivotTable-screenshot-status');
            const buttonEl = document.getElementById('pivotTable-download-screenshot');
            const targetEl = document.getElementById('pivotTableContainer');
            
            if (!targetEl) return;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰è¡¨æ ¼
            const table = targetEl.querySelector('table');
            if (!table) {
                statusEl.textContent = 'æ²’æœ‰è¡¨æ ¼å¯ä¾›æ“·å–ã€‚';
                statusEl.classList.remove('hidden');
                setTimeout(() => statusEl.classList.add('hidden'), 2000);
                return;
            }

            statusEl.textContent = 'æ­£åœ¨ç”¢ç”Ÿæˆªåœ–... è«‹ç¨å€™...';
            statusEl.classList.remove('hidden');
            buttonEl.disabled = true;

            try {
                const canvas = await html2canvas(targetEl, {
                    useCORS: true,
                    scale: 2 // æé«˜è§£æåº¦
                });
                
                const dataUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = 'pivot-table-screenshot.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                statusEl.textContent = 'æˆªåœ–å·²ä¸‹è¼‰ï¼';
                setTimeout(() => statusEl.classList.add('hidden'), 2000);

            } catch (error) {
                console.error('æˆªåœ–å¤±æ•—:', error);
                statusEl.textContent = 'æˆªåœ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ consoleã€‚';
            } finally {
                buttonEl.disabled = false;
            }
        }

        // ** æ–°å¢ï¼šæ¡‘åŸºåœ–æˆªåœ–å‡½æ•¸ **
        async function downloadSankeyScreenshot() {
            const statusEl = document.getElementById('sankey-screenshot-status');
            const buttonEl = document.getElementById('sankey-download-screenshot');
            const targetEl = document.getElementById('sankeyChart'); 
            
            if (!targetEl) return;
            
            statusEl.textContent = 'æ­£åœ¨ç”¢ç”Ÿæˆªåœ–... è«‹ç¨å€™...';
            statusEl.classList.remove('hidden');
            buttonEl.disabled = true;

            try {
                // Sankey chart is SVG, html2canvas handles it but sometimes needs help with styles
                // Ensure background is white
                const originalBg = targetEl.style.backgroundColor;
                targetEl.style.backgroundColor = 'white';

                const canvas = await html2canvas(targetEl, {
                    useCORS: true,
                    scale: 2,
                    backgroundColor: '#ffffff'
                });
                
                targetEl.style.backgroundColor = originalBg;

                const dataUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = 'sankey-screenshot.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                statusEl.textContent = 'æˆªåœ–å·²ä¸‹è¼‰ï¼';
                setTimeout(() => statusEl.classList.add('hidden'), 2000);

            } catch (error) {
                console.error('æˆªåœ–å¤±æ•—:', error);
                statusEl.textContent = 'æˆªåœ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ consoleã€‚';
            } finally {
                buttonEl.disabled = false;
            }
        }

        // =============================================
        // æ–°å¢åŠŸèƒ½ï¼šæ¨ç´åœ–è¡¨è¨­å®šæª”åŒ¯å‡º/åŒ¯å…¥
        // =============================================
        
        /**
         * åŒ¯å‡ºæ¨ç´åœ–è¡¨è¨­å®šæª”
         */
        function exportPivotTableConfig() {
            const rowMain = document.getElementById('pivotRowMainSelect').value;
            const rowSub = document.getElementById('pivotRowSubSelect').value;
            
            // æ”¶é›†æ‰€æœ‰æ¬„ä½è¨­å®š
            const columns = [];
            const container = document.getElementById('pivotColumnsContainer');
            const allFields = container.querySelectorAll('[id^="pivotCol_"]');
            
            allFields.forEach(fieldDiv => {
                const fieldSelect = fieldDiv.querySelector('select:nth-of-type(1)');
                const aggSelect = fieldDiv.querySelector('select:nth-of-type(2)');
                const formatInput = fieldDiv.querySelector('input[type="text"]');
                
                if (fieldSelect && fieldSelect.value) {
                    columns.push({
                        column: fieldSelect.value,
                        aggregate: aggSelect?.value || 'count',
                        format: formatInput?.value || ''
                    });
                }
            });
            
            const config = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                settings: {
                    rowMain: rowMain,
                    rowSub: rowSub,
                    columns: columns
                }
            };
            
            // ç”¢ç”Ÿæª”æ¡ˆä¸‹è¼‰
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `æ¨ç´åœ–è¡¨è¨­å®š_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('è¨­å®šæª”å·²åŒ¯å‡ºï¼');
        }
        
        /**
         * åŒ¯å…¥æ¨ç´åœ–è¡¨è¨­å®šæª”
         */
        function importPivotTableConfig(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    
                    if (!config.settings) {
                        alert('è¨­å®šæª”æ ¼å¼éŒ¯èª¤ï¼');
                        return;
                    }
                    
                    const settings = config.settings;
                    
                    // è¨­å®šåˆ—
                    document.getElementById('pivotRowMainSelect').value = settings.rowMain || '';
                    document.getElementById('pivotRowSubSelect').value = settings.rowSub || '';
                    
                    // æ¸…ç©ºç¾æœ‰æ¬„ä½
                    const container = document.getElementById('pivotColumnsContainer');
                    container.innerHTML = '';
                    
                    // é‡æ–°å»ºç«‹æ¬„ä½
                    if (settings.columns && settings.columns.length > 0) {
                        settings.columns.forEach(col => {
                            // æ·»åŠ æ¬„ä½
                            addPivotColumnField(col.column);
                            
                            // è¨­å®šèšåˆæ–¹å¼å’Œæ ¼å¼ - æ‰¾åˆ°å‰›æ·»åŠ çš„æ¬„ä½å€å¡Š
                            const container = document.getElementById('pivotColumnsContainer');
                            const allFields = container.querySelectorAll('[id^="pivotCol_"]');
                            if (allFields.length > 0) {
                                const lastField = allFields[allFields.length - 1];
                                
                                // è¨­å®šèšåˆæ–¹å¼
                                const aggSelect = lastField.querySelector('select:nth-of-type(2)');
                                if (aggSelect) {
                                    aggSelect.value = col.aggregate || 'count';
                                }
                                
                                // è¨­å®šæ ¼å¼
                                const formatInput = lastField.querySelector('input[type="text"]');
                                if (formatInput && col.format) {
                                    formatInput.value = col.format;
                                }
                            }
                        });
                    }
                    
                    // é‡æ–°ç”Ÿæˆæ¨ç´è¡¨
                    setTimeout(() => updatePivotTable(), 100);
                    
                    alert('è¨­å®šæª”å·²åŒ¯å…¥ä¸¦å¥—ç”¨ï¼');
                    
                } catch (error) {
                    console.error('åŒ¯å…¥å¤±æ•—:', error);
                    alert('è¨­å®šæª”è®€å–å¤±æ•—ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
            
            // æ¸…é™¤æª”æ¡ˆé¸æ“‡ï¼Œå…è¨±é‡è¤‡åŒ¯å…¥åŒä¸€æª”æ¡ˆ
            event.target.value = '';
        }

        /**
         * æ¸…é™¤æ¨ç´åœ–è¡¨è¨­å®š
         */
        function clearPivotTableConfig() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ¨ç´åœ–è¡¨è¨­å®šå—ï¼Ÿ')) {
                return;
            }
            
            // æ¸…é™¤åˆ—é¸æ“‡
            document.getElementById('pivotRowMainSelect').value = '';
            document.getElementById('pivotRowSubSelect').value = '';
            
            // æ¸…é™¤æ‰€æœ‰æ¬„ä½
            const container = document.getElementById('pivotColumnsContainer');
            container.innerHTML = '';
            
            // æ¸…é™¤æ¨ç´è¡¨é¡¯ç¤º
            const tableContainer = document.getElementById('pivotTableContainer');
            tableContainer.innerHTML = '<p class="text-gray-500">è«‹é¸æ“‡åˆ—å’Œæ¬„ä»¥ç”Ÿæˆæ¨ç´åˆ†æè¡¨</p>';
            
            alert('è¨­å®šå·²æ¸…é™¤ï¼');
        }

        // =============================================
        // æ–°å¢åŠŸèƒ½ï¼šå–®æ¬„åˆ†æCSVåŒ¯å‡º
        // =============================================
        
        /**
         * åŒ¯å‡ºå–®æ¬„åˆ†æç‚ºCSVï¼ˆæ”¹è‰¯ç‰ˆæ ¼å¼ï¼‰
         * æ ¼å¼ï¼šé¡Œç›®ç·¨è™Ÿ,é¡Œç›®åç¨±,è³‡æ–™é¡å‹,é¸é …1,é¸é …2,...
         */
        function exportSingleColumnToCSV() {
            // å–å¾—ç›®å‰é¸ä¸­çš„æ¬„ä½
            const selectedColumns = Array.from(document.querySelectorAll('#smallMultiplesControls input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedColumns.length === 0) {
                alert('è«‹å…ˆé¸æ“‡è¦åŒ¯å‡ºçš„æ¬„ä½ï¼');
                return;
            }
            
            // å–å¾—ç•¶å‰çš„å€¼æ¨¡å¼ï¼ˆè¨ˆæ•¸æˆ–ç™¾åˆ†æ¯”ï¼‰
            const valueMode = document.getElementById('smallValueSelect').value; // 'count' æˆ– 'percent'
            
            const csvRows = [];
            
            // æ±ºå®šæœ€å¤§æ¬„ä½æ•¸ï¼ˆç”¨æ–¼CSVè¡¨é ­ï¼‰
            let maxOptions = 0;
            selectedColumns.forEach(colKey => {
                const uniqueValues = [...new Set(rawData.map(row => row[colKey]))].filter(v => v !== null && v !== undefined && v !== '');
                maxOptions = Math.max(maxOptions, uniqueValues.length);
            });
            
            // å»ºç«‹è¡¨é ­
            const headers = ['é¡Œç›®ç·¨è™Ÿ', 'é¡Œç›®åç¨±', 'è³‡æ–™é¡å‹'];
            for (let i = 1; i <= maxOptions; i++) {
                headers.push(`é¸é …${i}`);
            }
            csvRows.push(headers.join(','));
            
            // å¥—ç”¨ç¯©é¸å™¨
            const activeFilters = getActiveFilters();
            let filteredData = rawData.filter(d => {
                return allColumns.every(key => {
                    const filterValues = activeFilters[key];
                    if (filterValues === undefined) return true;
                    if (filterValues.length === 0) return false;
                    return filterValues.includes(String(d[key]));
                });
            });
            
            // ç‚ºæ¯å€‹æ¬„ä½ç”¢ç”Ÿè³‡æ–™åˆ—
            selectedColumns.forEach((colKey, index) => {
                // æ”¶é›†è³‡æ–™
                const dataPoints = filteredData.map(row => row[colKey]).filter(v => v !== null && v !== undefined && v !== '');
                
                // è¨ˆç®—å„é¸é …çš„æ¬¡æ•¸
                const valueCounts = {};
                dataPoints.forEach(val => {
                    valueCounts[val] = (valueCounts[val] || 0) + 1;
                });
                
                // æ’åºï¼ˆå˜—è©¦æ•¸å€¼æ’åºï¼Œå¤±æ•—å‰‡å­—ä¸²æ’åºï¼‰
                const sortedKeys = Object.keys(valueCounts).sort((a, b) => {
                    const numA = parseFloat(a);
                    const numB = parseFloat(b);
                    if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                    return String(a).localeCompare(String(b));
                });
                
                // é¡Œç›®ç·¨è™Ÿï¼ˆå¯ä»¥æ ¹æ“šå¯¦éš›æƒ…æ³èª¿æ•´ï¼‰
                const questionNum = `Q${index + 1}`;
                
                // ç¬¬ä¸€åˆ—ï¼šé¸é …å€¼
                const optionRow = [questionNum, colKey, 'é¸é …å€¼'];
                sortedKeys.forEach(key => {
                    optionRow.push(escapeCSV(key));
                });
                csvRows.push(optionRow.join(','));
                
                // ç¬¬äºŒåˆ—ï¼šè¨ˆç¥¨æˆ–ç™¾åˆ†æ¯”
                const dataRow = [questionNum, colKey, valueMode === 'percent' ? 'ç™¾åˆ†æ¯”' : 'è¨ˆç¥¨'];
                const total = dataPoints.length;
                
                sortedKeys.forEach(key => {
                    if (valueMode === 'percent' && total > 0) {
                        const percent = ((valueCounts[key] / total) * 100).toFixed(2);
                        dataRow.push(percent + '%');
                    } else {
                        dataRow.push(valueCounts[key]);
                    }
                });
                csvRows.push(dataRow.join(','));
                
                // ç¬¬ä¸‰åˆ—ï¼šå¹³å‡å€¼
                const avgRow = [questionNum, colKey, 'å¹³å‡å€¼'];
                // æª¢æŸ¥æ˜¯å¦ç‚ºæ•¸å€¼è³‡æ–™
                const numericValues = dataPoints.map(v => parseFloat(v)).filter(v => !isNaN(v));
                if (numericValues.length > 0) {
                    const avg = numericValues.reduce((sum, val) => sum + val, 0) / numericValues.length;
                    avgRow.push(avg.toFixed(2));
                } else {
                    avgRow.push('N/A');
                }
                csvRows.push(avgRow.join(','));
                
                // ç¬¬å››åˆ—ï¼šä¸­ä½æ•¸
                const medianRow = [questionNum, colKey, 'ä¸­ä½æ•¸'];
                if (numericValues.length > 0) {
                    const sorted = [...numericValues].sort((a, b) => a - b);
                    const mid = Math.floor(sorted.length / 2);
                    const median = sorted.length % 2 === 0 
                        ? (sorted[mid - 1] + sorted[mid]) / 2 
                        : sorted[mid];
                    medianRow.push(median.toFixed(2));
                } else {
                    medianRow.push('N/A');
                }
                csvRows.push(medianRow.join(','));
            });
            
            // ç”¢ç”Ÿä¸‹è¼‰
            const csvContent = csvRows.join('\n');
            const BOM = '\uFEFF'; // UTF-8 BOM for Excel
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const modeText = valueMode === 'percent' ? 'ç™¾åˆ†æ¯”' : 'è¨ˆç¥¨';
            link.download = `å–®æ¬„åˆ†æ_${modeText}_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        /**
         * CSV æ¬„ä½è½‰ç¾©ï¼ˆè™•ç†é€—è™Ÿã€å¼•è™Ÿã€æ›è¡Œï¼‰
         */
        function escapeCSV(str) {
            if (str === null || str === undefined) return '';
            str = String(str);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }
        
        // ===============================================
        // == æ–°å¢: çµæ§‹å·®ç•°åˆ†æ (TA vs éTA) å‡½æ•¸ ==
        // ===============================================

        // å…¨å±€å‡½å¼ï¼šè¨­å®š Grid æ¬„æ•¸
        window.setComparisonGridColumns = function(cols) {
            const container = document.getElementById('comparisonChartContainer');
            const btns = document.querySelectorAll('.comparison-grid-btn');
            
            btns.forEach(btn => {
                if(parseInt(btn.dataset.cols) === cols) {
                    btn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
                    btn.classList.remove('text-slate-500');
                } else {
                    btn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
                    btn.classList.add('text-slate-500');
                }
            });

            container.className = 'grid gap-6 transition-all duration-300'; // Reset
            if (cols === 1) container.classList.add('grid-cols-1', 'max-w-6xl', 'mx-auto'); // 1æ¬„æ™‚æ›´å¯¬
            else if (cols === 2) container.classList.add('grid-cols-1', 'lg:grid-cols-2'); // 2æ¬„
            else if (cols === 3) container.classList.add('grid-cols-1', 'lg:grid-cols-2', 'xl:grid-cols-3'); // 3æ¬„
        }

        function calculateDistribution(data, questionKey) {
            const distribution = {};
            const values = data.map(d => d[questionKey]).filter(v => v !== undefined && v !== null);
            const total = values.length;
            if (total === 0) return { distribution: {}, total: 0 };

            values.forEach(val => {
                distribution[val] = (distribution[val] || 0) + 1;
            });

            // Convert to percentage
            for (const key in distribution) {
                distribution[key] = (distribution[key] / total) * 100;
            }
            
            const numericValues = values.map(v => parseFloat(v)).filter(v => !isNaN(v));
            let mean = null;
            let median = null;

            if (numericValues.length > 0) {
                mean = numericValues.reduce((sum, val) => sum + val, 0) / numericValues.length;
                const sorted = [...numericValues].sort((a, b) => a - b);
                const mid = Math.floor(sorted.length / 2);
                median = sorted.length % 2 === 0 ? (sorted[mid - 1] + sorted[mid]) / 2 : sorted[mid];
            }

            return { distribution, total, mean, median };
        }

        async function updateComparisonCharts() {
            const container = document.getElementById('comparisonChartContainer');
            const defineCol = controls.compDefineSelect.value;
            const value1 = controls.compValue1.value;
            const name1 = controls.compName1.value || 'ç¾¤çµ„1';
            const value2 = controls.compValue2.value;
            const name2 = controls.compName2.value || 'ç¾¤çµ„2';
            const selectedQuestions = Array.from(document.querySelectorAll('.comparison-checkbox:checked')).map(cb => cb.value);

            document.getElementById('comp-selected-count').textContent = `å·²é¸ ${selectedQuestions.length} é …`;

            // æ¸…ç†èˆŠåœ–è¡¨
            Object.values(comparisonCharts).forEach(chart => chart.destroy());
            comparisonCharts = {};
            container.innerHTML = '';
            
            if (!defineCol || !value1 || !value2 || selectedQuestions.length === 0) {
                container.innerHTML = `<div id="comparison-loading-message" class="col-span-full flex flex-col items-center justify-center p-20 bg-white rounded-2xl shadow-sm border border-slate-100">
                    <svg class="w-10 h-10 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                    <div class="mt-4 text-lg font-medium text-slate-600">è«‹å…ˆé¸æ“‡æ¯”è¼ƒæ¬„ä½ã€æ­£å€¼ï¼Œä¸¦å‹¾é¸åˆ†æé¡Œç›®</div></div>`;
                return;
            }
            
            const activeFilters = getActiveFilters();
            let baseData = rawData.filter(d => {
                return allColumns.every(key => {
                    const filterValues = activeFilters[key];
                    if (filterValues === undefined) return true;
                    if (filterValues.length === 0) return false;
                    return filterValues.includes(String(d[key]));
                });
            });
            
            const group1Data = baseData.filter(d => String(d[defineCol]) === String(value1));
            const group2Data = baseData.filter(d => String(d[defineCol]) === String(value2));

            selectedQuestions.forEach(qKey => {
                const card = document.createElement('div');
                card.className = 'comparison-chart-card bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col relative';

                const header = document.createElement('div');
                header.className = 'mb-4';
                header.innerHTML = `
                    <span class="text-[10px] font-bold tracking-wider text-slate-400 uppercase bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100 mb-1 inline-block">${qKey}</span>
                    <h3 class="text-lg font-bold text-slate-800 leading-snug">${QUESTION_MAP[qKey] || qKey}</h3>
                `;
                card.appendChild(header);

                const chartsGrid = document.createElement('div');
                chartsGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4';
                chartsGrid.className = 'grid grid-cols-1 gap-y-6';
                card.appendChild(chartsGrid);

                container.appendChild(card);

                // --- Helper to create a single stacked bar chart ---
                const createSingleComparisonChart = (data, title, groupType) => {
                    const chartContainer = document.createElement('div');
                    
                    const { distribution, total, mean, median } = calculateDistribution(data, qKey);
                    if (total === 0) {
                        chartContainer.innerHTML = `<h4 class="text-base font-semibold text-slate-700 mb-2">${title} <span class="font-normal text-slate-500">(N=${total})</span></h4><p class="text-slate-400 text-center py-10">ç„¡è³‡æ–™</p>`;
                        return chartContainer;
                    }

                    const groupLabels = Object.keys(distribution);
                    // ä¿®æ­£ï¼šå¥—ç”¨è‡ªè¨‚æ’åºè¦å‰‡
                    if (CUSTOM_SORT_ORDERS[qKey]) {
                        groupLabels.sort((a, b) => getSortIndex(a, CUSTOM_SORT_ORDERS[qKey]) - getSortIndex(b, CUSTOM_SORT_ORDERS[qKey]));
                    } else {
                        groupLabels.sort(smartSort);
                    }

                    const isGroupKeyNumeric = groupLabels.every(label => !isNaN(parseFloat(label)));

                    const datasets = groupLabels.map(groupVal => ({
                        label: groupVal,
                        data: [distribution[groupVal]],
                        backgroundColor: (getColorForValue(groupVal, qKey) || '#cccccc') + 'CC',
                        borderColor: getColorForValue(groupVal, qKey) || '#cccccc',
                        borderWidth: 0,
                        borderRadius: 0,
                    }));

                    const chartId = `comp-chart-${qKey}-${groupType}`;
                    const legendId = `comp-legend-${qKey}-${groupType}`;
                    const formatStat = (val) => (val !== null && val !== undefined) ? val.toFixed(1) : '-';

                    chartContainer.innerHTML = `
                        <div>
                            <h4 class="text-base font-semibold text-slate-700 mb-1">${title} <span class="font-normal text-slate-500">(N=${total})</span></h4>
                            ${isGroupKeyNumeric ? `<p class="text-xs text-blue-600 font-medium mb-2">Avg: ${formatStat(mean)} / Median: ${formatStat(median)}</p>` : ''}
                            <div id="${legendId}" class="flex flex-wrap gap-x-3 gap-y-1 mb-2"></div>
                            <div class="comparison-sub-chart-container" style="height: ${SMALL_CHART_BAR_HEIGHT + 80}px;">
                                <canvas id="${chartId}"></canvas>
                            </div>
                        </div>
                    `;

                    // Use a timeout to ensure the element is in the DOM before creating the chart
                    setTimeout(() => {
                        const legendContainer = document.getElementById(legendId);
                        legendContainer.innerHTML = datasets.map(ds => `
                            <div class="flex items-center">
                                <span class="w-3 h-3 mr-1 flex-shrink-0" style="background-color: ${ds.borderColor}; border-radius: 2px;"></span>
                                <span class="text-xs text-gray-700">${ds.label}</span>
                            </div>
                        `).join('');

                        const ctx = document.getElementById(chartId)?.getContext('2d');
                        if (!ctx) return;

                        comparisonCharts[chartId] = new Chart(ctx, {
                            type: 'bar',
                            data: { labels: [''], datasets: datasets },
                            options: {
                                indexAxis: 'y',
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: { stacked: true, max: 100, ticks: { font: { size: 10 }, callback: v => v + '%' }, title: { display: false }, grid: { display: false } },
                                    y: { 
                                        stacked: true, 
                                        display: false,
                                        barPercentage: 1.0, // å¡«æ»¿ä»¥ç¬¦åˆå®¹å™¨é«˜åº¦
                                        categoryPercentage: 1.0 }
                                },
                                plugins: {
                                    legend: { display: false },
                                    tooltip: { callbacks: { label: c => `${c.dataset.label}: ${c.parsed.x.toFixed(1)}%` } },
                                    datalabels: {
                                        display: v => v.dataset.data[v.dataIndex] > 8,
                                        color: '#fff',
                                        textShadow: '0 1px 2px rgba(0,0,0,0.4)',
                                        font: { weight: 'bold', size: DATALABELS_FONT_SIZE },
                                        formatter: v => Math.round(v) + '%'
                                    }
                                }
                            }
                        });
                    }, 0);

                    return chartContainer;
                };

                // Create and append the two charts
                const group1ChartEl = createSingleComparisonChart(group1Data, name1, 'group1');
                const group2ChartEl = createSingleComparisonChart(group2Data, name2, 'group2');
                
                chartsGrid.appendChild(group1ChartEl);
                chartsGrid.appendChild(group2ChartEl);
            });
        }

        /**
         * æ–°å¢ï¼šä¸‹è¼‰çµæ§‹å·®ç•°åˆ†æå€å¡Šçš„æˆªåœ–
         */
        async function downloadComparisonScreenshot() {
            const statusEl = document.getElementById('comp-screenshot-status');
            const buttonEl = document.getElementById('comp-download-screenshot');
            const targetEl = document.getElementById('comparisonChartContainer'); 
            
            if (!targetEl) return;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰åœ–è¡¨å¯ä¾›æ“·å–
            if (targetEl.children.length === 0 || targetEl.querySelector('#comparison-loading-message')) {
                statusEl.textContent = 'æ²’æœ‰åœ–è¡¨å¯ä¾›æ“·å–ã€‚';
                statusEl.classList.remove('hidden');
                setTimeout(() => statusEl.classList.add('hidden'), 3000);
                return;
            }

            statusEl.textContent = 'æ­£åœ¨ç”¢ç”Ÿæˆªåœ–ï¼Œè«‹ç¨å€™...';
            statusEl.classList.remove('hidden');
            buttonEl.disabled = true;

            try {
                // ç‚ºäº†è®“æˆªåœ–èƒŒæ™¯ä¸æ˜¯é€æ˜çš„ï¼Œæš«æ™‚è¨­å®šèƒŒæ™¯è‰²
                const originalBg = targetEl.style.backgroundColor;
                targetEl.style.backgroundColor = '#f1f5f9'; // èˆ‡ body èƒŒæ™¯è‰²ä¸€è‡´

                const canvas = await html2canvas(targetEl, {
                    useCORS: true,
                    scale: 2, // æé«˜è§£æåº¦
                    backgroundColor: '#f1f5f9'
                });
                
                // é‚„åŸèƒŒæ™¯è‰²
                targetEl.style.backgroundColor = originalBg;

                const dataUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = 'comparison-analysis-screenshot.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                statusEl.textContent = 'æˆªåœ–å·²ä¸‹è¼‰ï¼';
                setTimeout(() => statusEl.classList.add('hidden'), 3000);

            } catch (error) {
                console.error('æˆªåœ–å¤±æ•—:', error);
                statusEl.textContent = 'æˆªåœ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ consoleã€‚';
            } finally {
                buttonEl.disabled = false;
            }
        }

        /**
         * æ–°å¢ï¼šåŒ¯å‡ºçµæ§‹å·®ç•°åˆ†æç‚º CSV
         */
        function exportComparisonToCSV() {
            const defineCol = controls.compDefineSelect.value;
            const value1 = controls.compValue1.value;
            const name1 = controls.compName1.value || 'ç¾¤çµ„1';
            const value2 = controls.compValue2.value;
            const name2 = controls.compName2.value || 'ç¾¤çµ„2';
            const selectedQuestions = Array.from(document.querySelectorAll('.comparison-checkbox:checked')).map(cb => cb.value);

            if (!defineCol || !value1 || !value2 || selectedQuestions.length === 0) {
                alert('è«‹å…ˆé¸æ“‡æ¯”è¼ƒæ¬„ä½ã€æ­£å€¼ï¼Œä¸¦å‹¾é¸è‡³å°‘ä¸€å€‹åˆ†æé¡Œç›®ã€‚');
                return;
            }

            const activeFilters = getActiveFilters();
            let baseData = rawData.filter(d => {
                return allColumns.every(key => {
                    const filterValues = activeFilters[key];
                    if (filterValues === undefined) return true;
                    if (filterValues.length === 0) return false;
                    return filterValues.includes(String(d[key]));
                });
            });

            let csvContent = '\uFEFF'; // UTF-8 BOM
            csvContent += 'åˆ†æé¡Œç›®,ç¾¤çµ„,ç¸½æ•¸,é¸é …,ç™¾åˆ†æ¯”\n';

            selectedQuestions.forEach(qKey => {
                const processGroup = (data, groupName) => {
                    const { distribution, total } = calculateDistribution(data, qKey);
                    if (total > 0) {
                        for (const option in distribution) {
                            csvContent += `"${qKey}","${groupName}",${total},"${option}",${distribution[option].toFixed(2)}%\n`;
                        }
                    }
                };

                const group1Data = baseData.filter(d => String(d[defineCol]) === String(value1));
                const group2Data = baseData.filter(d => String(d[defineCol]) === String(value2));
                processGroup(group1Data, name1);
                processGroup(group2Data, name2);
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `comparison-analysis-${defineCol}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ===============================================
        // == æ–°å¢: ç›¸ä¼¼åº¦å°ç…§åˆ†æå‡½æ•¸ ==
        // ===============================================

        function setupSimilarityControls() {
            // é è¨­å€¼
            if(allColumns.includes('1.1_TA')) controls.simColX.value = '1.1_TA';
            if(allColumns.includes('6.2_é¡˜æ„æ·»è³¼')) controls.simColY.value = '6.2_é¡˜æ„æ·»è³¼';

            updateSimilarityValueOptions('X');
            updateSimilarityValueOptions('Y');

            controls.simColX.onchange = () => updateSimilarityValueOptions('X');
            controls.simColY.onchange = () => updateSimilarityValueOptions('Y');
            controls.simValX.onchange = () => updateSimilarityCountDisplay('X');
            controls.simValY.onchange = () => updateSimilarityCountDisplay('Y');

            controls.btnCalcSimilarity.addEventListener('click', calculateAndRenderSimilarity);
            document.getElementById('simFilterDiff').addEventListener('change', () => {
                renderSimilarityTable(currentSimilarityData, currentSimilarityMeta);
            });
        }

        function updateSimilarityValueOptions(axis) {
            const colSelect = document.getElementById(`simCol${axis}`);
            const valSelect = document.getElementById(`simVal${axis}`);
            const colName = colSelect.value;
            
            valSelect.innerHTML = '';
            if (!colName) return;

            const values = [...new Set(rawData.map(r => r[colName]))].filter(v => v !== undefined && v !== "");
            values.sort(smartSort);
            
            values.forEach(val => valSelect.add(new Option(val, val)));

            // é è¨­é¸ 'TA' æˆ– 'æ˜¯'
            if (colName.includes('TA') || colName.includes('é¡˜æ„')) {
                const positive = values.find(v => ['TA', 'æ˜¯', 'True', '1'].includes(String(v)));
                if (positive) valSelect.value = positive;
            }

            updateSimilarityCountDisplay(axis);
        }

        function updateSimilarityCountDisplay(axis) {
            const col = document.getElementById(`simCol${axis}`).value;
            const val = document.getElementById(`simVal${axis}`).value;
            const display = document.getElementById(`simCountDisplay${axis}`);
            
            if (col && val) {
                const count = rawData.filter(r => String(r[col]) === String(val)).length;
                display.textContent = `ç›®å‰é¸å–äººæ•¸ï¼š${count} äºº`;
            } else {
                display.textContent = '';
            }
        }

        function calculateAndRenderSimilarity() {
            const colX = controls.simColX.value;
            const valX = controls.simValX.value;
            const colY = controls.simColY.value;
            const valY = controls.simValY.value;

            if (!colX || !valX || !colY || !valY) {
                alert("è«‹å®Œæ•´é¸æ“‡ X è»¸èˆ‡ Y è»¸çš„æ¬„ä½åŠæ¢ä»¶å€¼ã€‚");
                return;
            }

            // ** ä¿®æ­£ï¼šå¥—ç”¨å…¨åŸŸç¯©é¸å™¨ **
            const activeFilters = getActiveFilters();
            let filteredData = rawData.filter(d => {
                return allColumns.every(key => {
                    const filterValues = activeFilters[key];
                    if (filterValues === undefined) return true;
                    if (filterValues.length === 0) return false;
                    return filterValues.includes(String(d[key]));
                });
            });

            // åœ¨å·²ç¯©é¸çš„è³‡æ–™åŸºç¤ä¸Šï¼Œå†å®šç¾©ç¾¤çµ„
            const groupX = filteredData.filter(r => String(r[colX]) === String(valX));
            const groupY = filteredData.filter(r => String(r[colY]) === String(valY));

            if (groupX.length === 0 || groupY.length === 0) {
                alert("åœ¨ç›®å‰çš„ç¯©é¸æ¢ä»¶ä¸‹ï¼Œæ‚¨å®šç¾©çš„ç¾¤çµ„äººæ•¸ç‚º 0ï¼Œç„¡æ³•é€²è¡Œåˆ†æã€‚");
                return;
            }

            const excludeCols = ['è­˜åˆ¥', 'ç¸½æ•¸', 'ç™¾åˆ†æ¯”', 'ç¾¤çµ„', 'é¸é …', 'åˆ†æé¡Œç›®', colX, colY]; 
            const questions = allColumns.filter(k => !excludeCols.includes(k) && !k.startsWith('æœªå‘½å'));

            let dataPoints = [];
            let xVals = [], yVals = [];

            questions.forEach(q => {
                const allOptions = [...new Set(filteredData.map(r => r[q]))].filter(v => v);
                allOptions.forEach(opt => {
                    const countX = groupX.filter(r => r[q] === opt).length;
                    const pctX = (countX / groupX.length) * 100;
                    
                    const countY = groupY.filter(r => r[q] === opt).length;
                    const pctY = (countY / groupY.length) * 100;

                    if (pctX > 0 || pctY > 0) {
                        dataPoints.push({
                            question: q, option: opt, x: pctX, y: pctY, diff: pctY - pctX,
                            countX: countX, totalX: groupX.length, countY: countY, totalY: groupY.length
                        });
                        xVals.push(pctX);
                        yVals.push(pctY);
                    }
                });
            });

            const corr = calculateCorrelation(xVals, yVals);
            const labelX = `${colX}: ${valX}`;
            const labelY = `${colY}: ${valY}`;
            
            currentSimilarityData = dataPoints;
            currentSimilarityMeta = { corr, labelX, labelY };

            renderSimilarityChart(currentSimilarityData, currentSimilarityMeta);
            renderSimilarityTable(currentSimilarityData, currentSimilarityMeta);
        }

        function renderSimilarityChart(data, meta) {
            const hoverTemplate = data.map(d => 
                `<b>${d.question} - ${d.option}</b><br>` +
                `Xè»¸: ${d.x.toFixed(2)}% <span style="color:#666">(${d.countX}/${d.totalX}äºº)</span><br>` +
                `Yè»¸: ${d.y.toFixed(2)}% <span style="color:#666">(${d.countY}/${d.totalY}äºº)</span><br>` +
                `å·®ç•°: ${d.diff > 0 ? '+' : ''}${d.diff.toFixed(2)}%`
            );

            const trace1 = {
                x: data.map(d => d.x), y: data.map(d => d.y),
                mode: 'markers', type: 'scatter', text: hoverTemplate, hoverinfo: 'text',
                marker: { size: 8, color: data.map(d => Math.abs(d.diff) > 10 ? '#ef4444' : '#3b82f6'), opacity: 0.6 },
                name: 'é¸é …æ•¸æ“šé»'
            };

            const traceLine = {
                x: [0, 100], y: [0, 100], mode: 'lines', type: 'scatter', name: 'å®Œå…¨ä¸€è‡´ç·š',
                line: { dash: 'dashdot', color: 'red', width: 1 }, hoverinfo: 'skip'
            };

            const layout = {
                title: 'ç¾¤çµ„å›ç­”ç›¸ä¼¼åº¦åˆ†æ',
                xaxis: { title: `${meta.labelX} (%)`, range: [0, 100] },
                yaxis: { title: `${meta.labelY} (%)`, range: [0, 100] },
                hovermode: 'closest', showlegend: false,
                annotations: [{ x: 95, y: 5, text: `r = ${meta.corr.toFixed(4)}`, showarrow: false, font: { size: 14, color: 'blue' } }]
            };

            Plotly.newPlot('similarityChartContainer', [traceLine, trace1], layout);
            
            const statsEl = document.getElementById('similarityStats');
            statsEl.innerHTML = `
                <p class="font-bold text-gray-700">çµ±è¨ˆæ•¸æ“šï¼š</p>
                <ul class="list-disc pl-5 text-sm text-gray-600">
                    <li>ç›¸é—œä¿‚æ•¸ (Correlation)ï¼š<span class="font-bold text-blue-600 text-lg">${meta.corr.toFixed(4)}</span></li>
                    <li>Xè»¸ä¾†æºï¼š${meta.labelX}</li>
                    <li>Yè»¸ä¾†æºï¼š${meta.labelY}</li>
                </ul>`;
            statsEl.classList.remove('hidden');
        }

        function renderSimilarityTable(data, meta) {
            const table = document.getElementById('similarityDiffTable');
            const tableCard = document.getElementById('similarityTableCard');
            const noDataMsg = document.getElementById('simNoDataMsg');
            const minDiff = parseInt(document.getElementById('simFilterDiff').value);

            const filteredData = data.filter(d => Math.abs(d.diff) >= minDiff);
            const sortedData = filteredData.sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff));

            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="w-1/4">åˆ†æé¡Œç›®</th><th class="w-1/4">é¸é …</th>
                        <th class="w-1/6">Xè»¸ æ¯”ä¾‹<br><span class="text-xs font-normal text-gray-500">(${meta.labelX})</span></th>
                        <th class="w-1/6">Yè»¸ æ¯”ä¾‹<br><span class="text-xs font-normal text-gray-500">(${meta.labelY})</span></th>
                        <th class="w-1/6 text-right">å·®ç•° (Diff)</th>
                    </tr>
                </thead>
                <tbody></tbody>`;
            
            const tableBody = table.querySelector('tbody');
            tableBody.innerHTML = '';

            if (sortedData.length === 0) {
                noDataMsg.classList.remove('hidden');
            } else {
                noDataMsg.classList.add('hidden');
                sortedData.forEach(d => {
                    const diffClass = d.diff > 0 ? 'sim-diff-positive' : (d.diff < 0 ? 'sim-diff-negative' : '');
                    const diffSign = d.diff > 0 ? '+' : '';
                    const barX = `<div class="sim-bar-container"><div class="sim-bar-fill bg-blue-500" style="width: ${d.x}%"></div></div>`;
                    const barY = `<div class="sim-bar-container"><div class="sim-bar-fill bg-green-500" style="width: ${d.y}%"></div></div>`;

                    tableBody.innerHTML += `
                        <tr>
                            <td>${d.question}</td>
                            <td><span class="font-bold text-gray-700">${d.option}</span></td>
                            <td><div class="flex items-center">${barX} <span>${d.x.toFixed(1)}%</span></div><div class="text-xs text-gray-400 mt-1">(${d.countX}/${d.totalX}äºº)</div></td>
                            <td><div class="flex items-center">${barY} <span>${d.y.toFixed(1)}%</span></div><div class="text-xs text-gray-400 mt-1">(${d.countY}/${d.totalY}äºº)</div></td>
                            <td class="text-right"><span class="${diffClass} text-lg">${diffSign}${d.diff.toFixed(2)}%</span></td>
                        </tr>`;
                });
            }
            tableCard.classList.remove('hidden');
        }

        function calculateCorrelation(x, y) {
            const n = x.length;
            if (n === 0) return 0;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);
            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            return denominator === 0 ? 0 : numerator / denominator;
        }

    </script>
</body>
</html>
